<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AcWing Django 框架课 | Colopen's blog</title><meta name="keywords" content="AcWing"><meta name="author" content="Colopen 彩色铅笔"><meta name="copyright" content="Colopen 彩色铅笔"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Python3教程 ஐ Python3官方Tutorial 配置docker、git环境与项目创建 ஐ 配置 docker 环境 与先前在 linux基础课 里完成对于 dock_lesson 容器的配置完全一样 1234567891011121314151617181920212223242526# 先将 y 总给的镜像 scp 到自己租的服务器上scp django_lesson_1_0.ta">
<meta property="og:type" content="article">
<meta property="og:title" content="AcWing Django 框架课">
<meta property="og:url" content="http://www.colopen-blog.com/Engineer/acw_django/index.html">
<meta property="og:site_name" content="Colopen&#39;s blog">
<meta property="og:description" content="Python3教程 ஐ Python3官方Tutorial 配置docker、git环境与项目创建 ஐ 配置 docker 环境 与先前在 linux基础课 里完成对于 dock_lesson 容器的配置完全一样 1234567891011121314151617181920212223242526# 先将 y 总给的镜像 scp 到自己租的服务器上scp django_lesson_1_0.ta">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.acwing.com/media/activity/surface/acdjango.png">
<meta property="article:published_time" content="2022-01-20T16:00:00.000Z">
<meta property="article:modified_time" content="2022-01-27T14:59:12.185Z">
<meta property="article:author" content="Colopen 彩色铅笔">
<meta property="article:tag" content="AcWing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.acwing.com/media/activity/surface/acdjango.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.colopen-blog.com/Engineer/acw_django/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Colopen 彩色铅笔","link":"链接: ","source":"来源: Colopen's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'AcWing Django 框架课',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-27 22:59:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><script src="https://cdn.jsdelivr.net/npm/echarts@4.7.0/dist/echarts.min.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.acwing.com/media/activity/surface/acdjango.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Colopen's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">AcWing Django 框架课</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-20T16:00:00.000Z" title="发表于 2022-01-21 00:00:00">2022-01-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-27T14:59:12.185Z" title="更新于 2022-01-27 22:59:12">2022-01-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BA%92%E8%81%94%E7%BD%91%E5%B7%A5%E7%A8%8B%E9%A1%B9%E7%9B%AE%E6%95%99%E7%A8%8B/">互联网工程项目教程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">24.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>117分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="AcWing Django 框架课"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="python3教程-ஐ">Python3教程 ஐ</h1>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/tutorial/index.html">Python3官方Tutorial</a></p>
<h1 id="配置dockergit环境与项目创建-ஐ">配置docker、git环境与项目创建 ஐ</h1>
<h2 id="配置-docker-环境">配置 docker 环境</h2>
<p>与先前在 <strong>linux基础课</strong> 里完成对于 <strong>dock_lesson</strong> 容器的配置完全一样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先将 y 总给的镜像 scp 到自己租的服务器上</span></span><br><span class="line">scp django_lesson_1_0.tar server_baidu:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录到自己的服务器上</span></span><br><span class="line">ssh server_baidu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将该镜像加载出来</span></span><br><span class="line">docker load -i django_lesson_1_0.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用该镜像 django_lesson 创建并启动成容器 django_server</span></span><br><span class="line"><span class="comment"># 同时将该容器的端口 22(ssh登录服务端口) 和 8000（Django调试端口）</span></span><br><span class="line"><span class="comment"># 映射到服务器的 20000 与 8000 端口上</span></span><br><span class="line">docker run -p 20000:22 -p 8000:8000 --name django_server -itd django_lesson:1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入容器内</span></span><br><span class="line">docker attach django_server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建接下来要用的用户 acs 并给予 sudo 权限</span></span><br><span class="line">adduser acs</span><br><span class="line">usermode -aG sudo acs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后回到 Ac-Terminal 下配置 ssh 到容器下的免密登录</span></span><br><span class="line">........</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把bash、vim、tmux的配置文件上传到django服务器下</span></span><br><span class="line">scp .bashrc .vimrc .tmux.conf django:</span><br></pre></td></tr></table></figure>
<p>然后用 <strong>Django-admin</strong> 新建一个 <strong>Django</strong> 项目</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">acs@79ab5005fd7a:~$ django-admin --version</span><br><span class="line">3.2.8</span><br><span class="line">acs@79ab5005fd7a:~$ django-admin startproject acapp</span><br><span class="line">acs@79ab5005fd7a:~$ tree .</span><br><span class="line">.</span><br><span class="line">`-- acapp</span><br><span class="line">    |-- acapp</span><br><span class="line">    |   |-- __init__.py</span><br><span class="line">    |   |-- asgi.py</span><br><span class="line">    |   |-- settings.py</span><br><span class="line">    |   |-- urls.py</span><br><span class="line">    |   `-- wsgi.py</span><br><span class="line">    `-- manage.py</span><br><span class="line"></span><br><span class="line">2 directories, 6 files</span><br></pre></td></tr></table></figure>
<h2 id="配置-git-环境">配置 git 环境</h2>
<p>在对项目进行 git 提交前，先配置好 git.acwing 与 服务器的密钥交互</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">cat .ssh/id_rsa.pub</span><br><span class="line"><span class="comment"># 复制密钥，提交到 git 服务器的 ssh 密钥中</span></span><br></pre></td></tr></table></figure>
<p>然后对应上远程仓库即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常规流程，不多解释了</span></span><br><span class="line">git config --global user.name <span class="string">&quot;colopen&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;zhaoxiucong@126.com&quot;</span></span><br><span class="line"></span><br><span class="line">git init</span><br><span class="line">git remote add origin git@git.acwing.com:colopen/acapp.git</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;Initial commit&quot;</span></span><br><span class="line">git push -u origin main</span><br></pre></td></tr></table></figure>
<h2 id="配置-django-项目">配置 Django 项目</h2>
<h3 id="启动初始项目">启动初始项目</h3>
<p>先直接启动项目</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py runserver 0.0.0.0:8000</span><br></pre></td></tr></table></figure>
<p>直接登录到对应 <code>ip:socket</code> 下后，会看到标题提示字</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invalid HTTP_HOST header: &#x27;120.48.18.165:8000&#x27;. You may need to add &#x27;120.48.18.165&#x27; to ALLOWED_HOSTS.</span><br></pre></td></tr></table></figure>
<p>要求我们把 <code>120.48.18.165</code> 参数添加到 <code>ALLOWED_HOSTS</code> 下</p>
<p>先找出 <code>ALLOWED_HOSTS</code> 在哪个文件下，然后加进去即可：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找出 ALLOWED_HOSTS 在哪个文件下</span></span><br><span class="line">$ ag ALLOWED_HOSTS</span><br><span class="line"></span><br><span class="line">&gt; acapp/settings.py</span><br><span class="line">&gt; 28:ALLOWED_HOSTS = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 ag命令 找到了该函数在 acapp/settings.py 下</span></span><br><span class="line"></span><br><span class="line">$ vim acapp/settings.py</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&quot;120.48.18.165&quot;</span>]</span><br><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存后退出，再从浏览器登入</span></span><br></pre></td></tr></table></figure>
<p>首页标题显示如下，这表示我们成功了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The install worked successfully! Congratulations!</span><br></pre></td></tr></table></figure>
<h3 id="gitignore的作用">【*.gitignore的作用】</h3>
<p>考虑把当前项目，提交到 <code>git</code> 服务器</p>
<p>执行一次 <code>git status</code> 后，发现会提示我们把 <code>__pycache__</code> 缓存文件也提交</p>
<blockquote>
<p><strong>工程常识</strong>：<strong>缓存文件</strong>，<strong>可执行文件</strong>，<strong>编译文件</strong> 不要传到自己的 <code>git</code> 项目里</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git status</span><br><span class="line">&gt; Untracked files:</span><br><span class="line">&gt;   (use <span class="string">&quot;git add &lt;file&gt;...&quot;</span> to include <span class="keyword">in</span> what will be committed)</span><br><span class="line">&gt;       acapp/__pycache__/</span><br><span class="line">&gt;       ......</span><br></pre></td></tr></table></figure>
<p>为了不让 <code>git</code> 每次去额外检测缓存的 <code>cache</code> 文件，额外编写一个 <code>.gitignore</code> 文件，格式如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 格式：**/文件名</span></span><br><span class="line">**/__pycache__</span><br></pre></td></tr></table></figure>
<p>再调用一次 <code>git status</code> 就不会提示要 <code>add</code> 到 <strong>暂存区</strong> 了</p>
<p>编写 <code>.gitignore</code> 也是需要掌握的一项技能</p>
<h3 id="创建管理员登录页面">创建管理员登录页面</h3>
<p>直接调用封装好的命令，就会在当前目录下创建一个 <code>game</code> 文件夹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ python3 manage.py startapp game</span><br><span class="line">$ tree .</span><br><span class="line">&gt; .</span><br><span class="line">&gt; |-- acapp</span><br><span class="line">&gt; |   |-- __init__.py</span><br><span class="line">&gt; |   |-- __pycache__</span><br><span class="line">&gt; |   |   |-- __init__.cpython-38.pyc</span><br><span class="line">&gt; |   |   |-- settings.cpython-38.pyc</span><br><span class="line">&gt; |   |   |-- urls.cpython-38.pyc</span><br><span class="line">&gt; |   |   `-- wsgi.cpython-38.pyc</span><br><span class="line">&gt; |   |-- asgi.py</span><br><span class="line">&gt; |   |-- settings.py</span><br><span class="line">&gt; |   |-- urls.py</span><br><span class="line">&gt; |   `-- wsgi.py</span><br><span class="line">&gt; |-- db.sqlite3</span><br><span class="line">&gt; |-- game</span><br><span class="line">&gt; |   |-- __init__.py</span><br><span class="line">&gt; |   |-- admin.py          <span class="comment"># 管理员页面</span></span><br><span class="line">&gt; |   |-- apps.py           <span class="comment"># 用的不多</span></span><br><span class="line">&gt; |   |-- migrations</span><br><span class="line">&gt; |   |   `-- __init__.py</span><br><span class="line">&gt; |   |-- models.py         <span class="comment"># 定义网站里的数据库表</span></span><br><span class="line">&gt; |   |-- tests.py</span><br><span class="line">&gt; |   `-- views.py          <span class="comment"># 视图，即函数</span></span><br><span class="line">&gt; `-- manage.py</span><br></pre></td></tr></table></figure>
<p>在运行服务器的同时，我们也会看到几行红字警告：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">You have 18 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): admin, auth, contenttypes, sessions.</span><br><span class="line">Run &#x27;python manage.py migrate&#x27; to apply them.</span><br></pre></td></tr></table></figure>
<p>意识大致是有 18 个数据库的修改没有 <code>apply</code>，直接复制执行他要求我们执行的代码即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py migrate</span><br></pre></td></tr></table></figure>
<p>数据库修改完成后，打开 <code>ip:socket/admin</code> 就会进入 <strong>管理员登录</strong> 页面了</p>
<p>然后我们用指令创建一个 <strong>管理员用户</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ python3 manage.py createsuperuser</span><br><span class="line">&gt; Username (leave blank to use <span class="string">&#x27;acs&#x27;</span>): admin</span><br><span class="line">&gt; Email address: </span><br><span class="line">&gt; Password: 123456</span><br><span class="line">&gt; Password (again): 123456</span><br><span class="line">&gt; Superuser created successfully.</span><br></pre></td></tr></table></figure>
<p>然后利用该 <strong>管理员用户</strong> 登录 <code>admin</code> 页面，即可成功登陆</p>
<h3 id="创建用户登录页面">创建用户登录页面</h3>
<p><code>game</code> 下的各个文件作用：</p>
<ol type="1">
<li><code>templates</code> 目录：管理 <code>html</code> 文件</li>
<li><code>urls</code> 目录：管理路由，即链接与函数的对应关系</li>
<li><code>views</code> 目录：管理 <code>http</code> 函数</li>
<li><code>models</code> 目录：管理数据库数据</li>
</ol>
<p>现在我们要实现一个路由重定向：</p>
<p><code>url</code> 输入网址 -&gt; <code>acapp.urls</code> -&gt; <code>game.urls</code> -&gt; <code>game.views.index</code> -&gt; 展示页面</p>
<p><strong>game.views</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    line1 = <span class="string">&#x27;&lt;h1 style=&quot;text-align: center&quot;&gt; 第一个网页 &lt;/h1&gt;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(line1)</span><br></pre></td></tr></table></figure>
<p><strong>game.urls</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> game.views <span class="keyword">import</span> index</span><br><span class="line"></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    path(<span class="string">&quot;&quot;</span>, index, name=<span class="string">&quot;index&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong>acapp.urls</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(<span class="string">&#x27;game.urls&#x27;</span>)),</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">] </span><br></pre></td></tr></table></figure>
<p>然后直接打开 <code>ip:socket</code> 可以直接显示 <code>index</code> 返回的网页</p>
<h1 id="创建菜单界面-ஐ">创建菜单界面 ஐ</h1>
<p><strong>项目系统设计</strong></p>
<ul>
<li><code>menu</code> : 菜单页面</li>
<li><code>playground</code> : 游戏界面</li>
<li><code>settings</code> : 设置界面</li>
</ul>
<p><strong>项目文件结构</strong></p>
<ul>
<li><code>templates</code> 目录：管理 <code>html</code> 文件</li>
<li><code>urls</code> 目录：管理路由，即链接与函数的对应关系</li>
<li><code>views</code> 目录：管理 <code>http</code> 函数</li>
<li><code>models</code> 目录：管理数据库数据</li>
<li><code>static</code> 目录：管理静态文件，比如：
<ul>
<li><code>css</code> : 对象的格式，比如位置、长宽、颜色、背景、字体大小等</li>
<li><code>js</code> : 对象的逻辑，比如对象的创建与销毁、事件函数、移动、变色等</li>
<li><code>image</code> : 图片</li>
<li><code>audio</code> : 声音</li>
<li>…</li>
</ul></li>
<li><code>consumers</code> 目录：管理 <code>websocket</code> 函数</li>
</ul>
<p><strong>本节课用到的素材地址</strong></p>
<ul>
<li>背景图片
<ul>
<li>下载方式 : <code>wget --output-document=自定义图片名称 图片地址</code></li>
</ul></li>
<li><code>jquery</code> 库 :
<ul>
<li><code>&lt;link rel="stylesheet" href="https://cdn.acwing.com/static/jquery-ui-dist/jquery-ui.min.css"&gt;</code></li>
<li><code>&lt;script src="https://cdn.acwing.com/static/jquery/js/jquery-3.3.1.min.js"&gt;&lt;/script&gt;</code></li>
</ul></li>
</ul>
<h2 id="构建好项目的框架">构建好项目的框架</h2>
<ol type="1">
<li><strong>新建好 <code>templates、urls、views、models</code> 三个文件夹</strong></li>
<li><strong>新建好 <code>static</code> 静态文件夹下 <code>css、js、image、audio</code> 四个文件夹</strong></li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ rm urls.py views.py models.py</span><br><span class="line">$ mkdir urls views models templates static</span><br><span class="line">$ <span class="built_in">cd</span> static</span><br><span class="line">$ mkdir css js image audio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了让其他的python文件可以import当前文件夹，需要先在每个文件夹下初始化一个 __init__.py文件</span></span><br><span class="line">$ touch models/__init__.py</span><br><span class="line">$ touch urls/__init__.py</span><br><span class="line">$ touch views/__init__.py</span><br></pre></td></tr></table></figure>
<p><strong>修改项目的 UTC 时间为 CN 时间</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vim /acapp/settings.py</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span> <span class="comment"># 原来默认是 UTC</span></span><br><span class="line">******</span><br></pre></td></tr></table></figure>
<p><strong>将新创建的 <code>game</code> 下的 <code>apps.py</code> 中的 <code>GameConfig</code> 加到 <code>settings.py</code> 下</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim /acapp/settings.py</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">  <span class="string">&#x27;game.apps.GameConfig&#x27;</span>,</span><br><span class="line">  ......</span><br><span class="line">]</span><br><span class="line">******</span><br></pre></td></tr></table></figure>
<p><strong>声明将静态文件路径 <code>STATIC_ROOT</code> 和 <code>MEDIA_ROOT</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ vim /acapp/settings.py</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, <span class="string">&#x27;static&#x27;</span>)</span><br><span class="line">STATIC_URL = <span class="string">&#x27;/static/&#x27;</span></span><br><span class="line"></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">&#x27;media&#x27;</span>)</span><br><span class="line">MEDIA_URL = <span class="string">&#x27;/media/&#x27;</span></span><br><span class="line">******</span><br></pre></td></tr></table></figure>
<p><strong><code>image</code> 文件管理</strong></p>
<p><code>image</code> 文件一般放于 <code>game/static/image</code> 文件夹下</p>
<p>为了方便管理，对应每个模块，分别用不同的文件夹来进行分类管理</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mdkir menu playground settings</span><br></pre></td></tr></table></figure>
<p>然后我们在 <code>game/static/image/menu</code> 下载一个图片，作为 <code>menu</code> 模块的背景图</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> menu</span><br><span class="line">$ wget --output-document=background.gif https://gimg2.baidu.com/image_search/src=http%3A%2F%2Finews.gtimg.com%2Fnewsapp_match%2F0%2F11156556256%2F0.jpg&amp;refer=http%3A%2F%2Finews.gtimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg</span><br><span class="line">$ rm wget-log <span class="comment"># 删掉没有用的 wget 日志</span></span><br></pre></td></tr></table></figure>
<p>顺便也可以测试一下之前在 <strong>全局设置</strong> 中加的 <strong>静态文件url</strong></p>
<p>在浏览器键入 <code>ip:socket/static/image/menu/background.gif</code> 可以成功在浏览器中看到图片</p>
<p><strong><code>css</code> 文件管理</strong></p>
<p>一般一个工程，只有一个 <code>css</code> 文件就足够了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> css</span><br><span class="line">$ touch game.css</span><br></pre></td></tr></table></figure>
<p><strong><code>js</code> 文件管理</strong></p>
<p>一般一个工程会有很多个 <code>.js</code> 源文件，为了加快网络的传输，也为了每次写新的 <code>.js</code> 文件不用每个 <code>html</code> 都额外引入一次</p>
<p>考虑用一个 <code>src</code> 源文件夹来存储所有的 <code>.js</code> 源文件</p>
<p>然后用 <code>dist</code> 文件夹来存放由 <code>src</code> 下所有源文件整合生成的一个目标 <code>.js</code> 文件</p>
<p>这样既实现了快速传输的好处，也方便了后续编写 <code>html</code> 文件时，引入 <code>.js</code> 的便利</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> js</span><br><span class="line">$ mkdir dist src</span><br><span class="line">$ <span class="built_in">cd</span> mkdir src</span><br><span class="line">$ mkdir menu playground settings</span><br><span class="line">$ touch zbase.js  <span class="comment"># 总的 js 文件，命名以 z 开头会自动在字典序最后</span></span><br></pre></td></tr></table></figure>
<p>创建一个脚本实现上述 <strong>整合的功能</strong></p>
<p><code>~/acapp/scripts/compress_game_js.sh</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line">JS_PATH=/home/acs/acapp/game/static/js/</span><br><span class="line">JS_PATH_DIST=<span class="variable">$&#123;JS_PATH&#125;</span>dist/</span><br><span class="line">JS_PATH_SRC=<span class="variable">$&#123;JS_PATH&#125;</span>src/</span><br><span class="line"></span><br><span class="line">find <span class="variable">$JS_PATH_SRC</span> -<span class="built_in">type</span> f -name <span class="string">&#x27;*.js&#x27;</span> | sort | xargs cat &gt; <span class="variable">$&#123;JS_PATH_DIST&#125;</span>game.js</span><br></pre></td></tr></table></figure>
<p><strong><code>html</code> 文件管理</strong></p>
<p>在 <code>templates</code> 文件夹下创建 <code>menu、playground、settings、multiends</code> 四个文件夹，用于存储三个模块和终端的 <code>html</code> 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir menu playround settings multiends</span><br></pre></td></tr></table></figure>
<p>在 <code>multiends</code> 下创建 <code>web.html</code> 文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"><span class="comment">&lt;!-- Django 中引入全局setting里的变量 static 的语法--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdn.acwing.com/static/jquery-ui-dist/jquery-ui.min.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.acwing.com/static/jquery/js/jquery-3.3.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 上述两句引入 jQuery 库 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用引入的变量 static 的语法如下 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;% static &#x27;css/game.css&#x27; %&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&#123;% static &#x27;js/dist/game.js&#x27; %&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 分别引入 css 文件和总的 js 文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">&quot;margin: 0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;ac_game_12345678&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> ac_game = <span class="keyword">new</span> AcGame(<span class="string">&quot;ac_game_12345678&quot;</span>)</span></span><br><span class="line"><span class="javascript">        &#125;)</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>编写 <code>js/src/zbase.js</code> 文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGame</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>views</code>视图管理</strong></p>
<p>在 <code>views</code> 文件夹下新建三个模块的视图文件夹</p>
<p>同样为了能够被 <code>import</code> 到，分别初始化 <code>__init__.py</code> 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> views</span><br><span class="line">$ mkdir menu playground settings</span><br><span class="line">$ touch menu/__init__.py</span><br><span class="line">$ touch playground/__init__.py</span><br><span class="line">$ touch settings/__init__.py</span><br></pre></td></tr></table></figure>
<p>然后写一个 <code>index.py</code> 文件，目的是在 <code>web</code> 端被访问时，返回上面写的 <code>web.html</code> 文件</p>
<p><strong><code>index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">  <span class="keyword">return</span> render(request, <span class="string">&quot;multiends/web.html&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong><code>urls</code>路由管理</strong></p>
<p>这部分比较绕，首先需要对将要实现的访问路由有一个概览</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">                                     /-- &quot;&quot; -- index</span><br><span class="line">                                    / -- &quot;menu/&quot; -- menu.index</span><br><span class="line">             / &quot;&quot; --&gt; &quot;game.url&quot; --&gt; </span><br><span class="line">            /                       \ -- &quot;playground/&quot; -- playround.index</span><br><span class="line">id:scoket -&gt;                         \-- &quot;settings/&quot; -- settings.index</span><br><span class="line">            \</span><br><span class="line">             \ &quot;/admin&quot; -- 到达管理员页面</span><br></pre></td></tr></table></figure>
<p>接下来我们就是要实现这样一个路由规则</p>
<p>首先在 <code>urls</code> 下创建三个文件夹 <code>menu、playground、settings</code></p>
<p>并且分贝在三个文件夹下创建初始化的 <code>__init__.py</code> 文件，模板参考如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>首先修改我们的 <strong>路由起点</strong> 文件 : <code>~/acapp/acapp/urls.py</code></p>
<p>实现我们的第一个分支</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">  path(<span class="string">&#x27;&#x27;</span>, include(<span class="string">&#x27;game.urls.index&#x27;</span>)),</span><br><span class="line">  path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>根据我们的路由图，抵达第二个分支，修改第二个分支的文件 : <code>~/acapp/game/urls/index.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> game.views.index <span class="keyword">import</span> index</span><br><span class="line"></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    path(<span class="string">&quot;&quot;</span>, index, name=<span class="string">&quot;index&quot;</span>),</span><br><span class="line">    path(<span class="string">&quot;menu/&quot;</span>, include(<span class="string">&quot;game.urls.menu.index&quot;</span>)),</span><br><span class="line">    path(<span class="string">&quot;playground/&quot;</span>, include(<span class="string">&quot;game.urls.playground.index&quot;</span>)),</span><br><span class="line">    path(<span class="string">&quot;settings/&quot;</span>, include(<span class="string">&quot;game.urls.settings.index&quot;</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>这样就完全实现我们期望的 <strong>路由规则</strong> 了</p>
<h2 id="创建菜单-menu-界面">创建菜单 <code>menu</code> 界面</h2>
<h3 id="搭建菜单-menu-界面的框架">搭建菜单 <code>menu</code> 界面的框架</h3>
<p>我们采用的 <strong>前后端分离式</strong> 开发，所有的 <strong>html</strong> 渲染都要求在前端完成</p>
<p>开发流程就是，现在 <strong>html</strong> 里创建好一个有 <strong>id</strong> 的 <strong>div</strong></p>
<p>然后利用 <strong>js</strong> 文件，捕获到该 <strong>div</strong>，并进行 <strong>渲染</strong></p>
<p>因此，该模块的目的就很明确了</p>
<p>先前，在 <strong>multiends</strong> 的 <strong>web.html</strong> 文件里设置了一个 <strong>id</strong> 为 <strong>ac_game_12345678</strong> 的 <strong>div</strong></p>
<p>然后在 <strong>js / src</strong> 完成该对象的创建</p>
<blockquote>
<p>将每一个结构写成一个 <strong>class</strong></p>
</blockquote>
<p><strong><code>/templates/multiends/web.html</code></strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;ac_game_12345678&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> ac_game = <span class="keyword">new</span> AcGame(<span class="string">&quot;ac_game_12345678&quot;</span>)</span></span><br><span class="line"><span class="javascript">        &#125;)</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id; </span><br><span class="line">        <span class="built_in">this</span>.$ac_game = $(<span class="string">&#x27;#&#x27;</span> + id);</span><br><span class="line">        <span class="built_in">this</span>.menu = <span class="keyword">new</span> AcGameMenu(<span class="built_in">this</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/menu/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGameMenu</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.root = root;</span><br><span class="line">        <span class="built_in">this</span>.$menu = $(<span class="string">` </span></span><br><span class="line"><span class="string">&lt;div class=&quot;ac-game-menu&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line">        <span class="built_in">this</span>.root.$ac_game.append(<span class="built_in">this</span>.$menu); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>css/game.css</code></strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.ac-game-menu</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&#x27;/static/image/menu/background.gif&#x27;</span>);</span><br><span class="line">    <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span>;</span><br><span class="line">    user-select: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 <strong>代码逻辑</strong> 如下：</p>
<ol type="1">
<li><code>html</code> 页面执行到 <code>js</code> 代码，利用 <code>AcGame类</code> 创建对象 <code>ac_game</code> 同时传递参数 <code>div的id</code></li>
<li><code>AcGame</code> 开始执行构造函数，在构造函数中，捕获 <code>html</code> 标签，并利用 <code>AcGameMenu类</code> 创建对象 <code>menu</code>，并将整个对象作为参数下传</li>
<li><code>AcGameMenu</code> 开始执行构造函数，然后创建 <code>html</code> 代码，加到捕获到的 <code>html</code> 代码下</li>
<li>最终成功渲染出背景图片</li>
</ol>
<h3 id="设置菜单-menu-页面的内容">设置菜单 <code>menu</code> 页面的内容</h3>
<p>主要内容就是在主页面中，显示：单人模式、多人模式、设置，三个按钮的选项</p>
<p>比较简单，就不多解释了</p>
<p><strong><code>js/src/menu/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGameMenu</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.root = root;</span><br><span class="line">        <span class="built_in">this</span>.$menu = $(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;div class=&quot;ac-game-menu&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;ac-game-menu-field&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-menu-field-item ac-game-menu-field-item-single-mode&quot;&gt;</span></span><br><span class="line"><span class="string">            单人模式</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-menu-field-item ac-game-menu-field-item-multi-mode&quot;&gt;</span></span><br><span class="line"><span class="string">            多人模式</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-menu-field-item ac-game-menu-field-item-settings-mode&quot;&gt;</span></span><br><span class="line"><span class="string">            设置</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line">        <span class="built_in">this</span>.root.$ac_game.append(<span class="built_in">this</span>.$menu);</span><br><span class="line">        <span class="built_in">this</span>.$single_mode = <span class="built_in">this</span>.$menu.find(<span class="string">&#x27;.ac-game-menu-field-item-single-mode&#x27;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$multi_mode = <span class="built_in">this</span>.$menu.find(<span class="string">&#x27;.ac-game-menu-field-item-multi-mode&#x27;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$settings_mode = <span class="built_in">this</span>.$menu.find(<span class="string">&#x27;.ac-game-menu-field-item-settings-mode&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>css/game.css</code></strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.ac-game-menu</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&#x27;/static/image/menu/background.gif&#x27;</span>);</span><br><span class="line">    <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span>;</span><br><span class="line">    user-select: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ac-game-menu-field</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20vw</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">40vh</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">19vh</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ac-game-menu-field-item</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">7vh</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">18vw</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">6vh</span>;</span><br><span class="line">    <span class="attribute">font-style</span>: italic;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">2vh</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">1vh</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">39</span>, <span class="number">21</span>, <span class="number">28</span>, <span class="number">0.6</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">letter-spacing</span>: <span class="number">0.5vw</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ac-game-menu-field-item</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.2</span>);</span><br><span class="line">    <span class="attribute">transition</span>: <span class="number">100ms</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加-单人模式-监听函数-打开游戏界面-功能">添加 '单人模式' 监听函数 —— 打开游戏界面 功能</h3>
<p>如何添加 <strong>html</strong> 标签的监听函数，这里不多做解释</p>
<p>不会的小伙伴可以去学一下基本的 <strong>JavaScript</strong> 和 <strong>jQuery</strong></p>
<p>说明一下这里要实现的 <strong>逻辑</strong>：</p>
<ol type="1">
<li>点击 '单人模式' 按钮触发 <code>click</code> 事件，随即触发监听函数，开始执行</li>
<li>关闭 <code>menu</code> 页面</li>
<li>打开 <code>playground</code> 页面</li>
</ol>
<p>因此，我们先简易的实现一个 <code>playground</code> 页面，方便调试该功能</p>
<p><strong><code>js/src/playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.root = root;</span><br><span class="line">        <span class="built_in">this</span>.$playground = $(<span class="string">`&lt;div&gt;游戏界面&lt;/div&gt;`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.hide();</span><br><span class="line">        <span class="built_in">this</span>.root.$ac_game.append(<span class="built_in">this</span>.$playground);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//打开 playground 界面</span></span><br><span class="line">        <span class="built_in">this</span>.$playground.show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">hide</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//关闭 playground 界面</span></span><br><span class="line">        <span class="built_in">this</span>.$playground.hide();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再实现 监听函数功能之前，先在 <code>/src/zbase.js</code> 即主 <code>js</code> 文件下，利用 <code>AcGamePlayground</code> 类创建好 <code>playground</code> 对象</p>
<p>这样我们就能在前端，渲染出两个界面了，分别是：<code>menu</code> 和 <code>playground</code></p>
<p><strong><code>js/src/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.$ac_game = $(<span class="string">&#x27;#&#x27;</span> + id);</span><br><span class="line">        <span class="built_in">this</span>.menu = <span class="keyword">new</span> AcGameMenu(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// 把 playground 对象也建好，这样我们就同时有两个界面了</span></span><br><span class="line">        <span class="built_in">this</span>.playground = <span class="keyword">new</span> AcGamePlayground(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;                    </span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们开始实现 <code>ac-game-menu-field-item-single-mode</code> 标签的 <code>click</code> 事件的监听函数</p>
<p>其功能之前讲过了，就是关闭 <code>menu</code> 页面，打开 <code>playground</code> 页面</p>
<p><strong><code>js/src/menu/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGameMenu</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.root = root;</span><br><span class="line">        <span class="built_in">this</span>.$menu = $(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;div class=&quot;ac-game-menu&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;ac-game-menu-field&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-menu-field-item ac-game-menu-field-item-single-mode&quot;&gt;</span></span><br><span class="line"><span class="string">            单人模式</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-menu-field-item ac-game-menu-field-item-multi-mode&quot;&gt;</span></span><br><span class="line"><span class="string">            多人模式</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-menu-field-item ac-game-menu-field-item-settings-mode&quot;&gt;</span></span><br><span class="line"><span class="string">            设置</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line">        <span class="built_in">this</span>.root.$ac_game.append(<span class="built_in">this</span>.$menu);</span><br><span class="line">        <span class="built_in">this</span>.$single_mode = <span class="built_in">this</span>.$menu.find(<span class="string">&#x27;.ac-game-menu-field-item-single-mode&#x27;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$multi_mode = <span class="built_in">this</span>.$menu.find(<span class="string">&#x27;.ac-game-menu-field-item-multi-mode&#x27;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$settings_mode = <span class="built_in">this</span>.$menu.find(<span class="string">&#x27;.ac-game-menu-field-item-settings-mode&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.add_listening_events();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.$single_mode.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            outer.hide();   <span class="comment">// 关闭主页面</span></span><br><span class="line">            outer.root.playground.show();   <span class="comment">// 打开游戏界面</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//显示menu界面</span></span><br><span class="line">        <span class="built_in">this</span>.$menu.show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">hide</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//隐藏menu界面</span></span><br><span class="line">        <span class="built_in">this</span>.$menu.hide();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们到 <code>id:socket</code> 下查看，发现功能成功实现了 w</p>
<p>下课 ~~</p>
<h1 id="创建游戏界面-ஐ">创建游戏界面 ஐ</h1>
<h2 id="前端的模块化引入">前端的模块化引入</h2>
<p>这属于上节课的疑难杂症，由于在 <code>html</code> 代码部分，是将整个 <code>game.js</code> 文件引入</p>
<p>这样会导致在 <code>game.js</code> 中定义的变量，会变成整个网页的 <strong>全局变量</strong>（之后可能会引起变量重名的诸多问题）</p>
<p>因此，我们考虑使用 <strong>模块化引入</strong> 的功能，让网页只引入在 <strong>html</strong> 中需要的部分</p>
<p><strong>修改 <code>web.html</code></strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 首先，先删掉上面整个引入 game.js 的部分 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 然后，下方创建对象的部分，先使用模块化引入 --&gt;</span></span><br><span class="line">......</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">import</span> &#123;AcGame&#125; <span class="keyword">from</span> <span class="string">&quot;&#123;% static &#x27;js/dist/game.js&#x27; %&#125;&quot;</span></span></span><br><span class="line"><span class="javascript">        $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> ac_game = <span class="keyword">new</span> AcGame(<span class="string">&quot;ac_game_12345678&quot;</span>)</span></span><br><span class="line"><span class="javascript">        &#125;)</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>此外，还有修改引入的类，在前面加上 <code>export</code>，如下修改 <code>js/src/zbase.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AcGame</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，在全局中，只会出现引入的模块，其他的 <code>.js</code> 代码不会出现在全局中</p>
<h2 id="构建游戏界面框架">构建游戏界面框架</h2>
<p>文件框架在上一节已经完全搭建好了</p>
<p>这里要完成的是对 <strong>游戏界面画布</strong> 的构建，十分简单</p>
<p>给画布的 <strong>div block</strong> 一个 <strong>class</strong> 叫 <strong>ac-game-playground</strong>，然后在 <strong>game.css</strong> 中进行设置</p>
<p><strong><code>static/js/src/playground/=zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">    <span class="built_in">this</span>.$playground = $(<span class="string">`&lt;div class=&quot;ac-game-playground&quot;&gt;&lt;/div&gt;`</span>);</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p><strong><code>game.css</code></strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="selector-class">.ac-game-playground</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="实现游戏引擎框架">实现游戏引擎框架</h2>
<p>首先，需要对这部分有一个基本的认识</p>
<p>游戏中，物体在移动，其实现原理是：每一个动作都会渲染多张图片出来，然后图片快速的切换，从而实现动的过程</p>
<p>因此，需要先实现一个游戏引擎的基类 <strong><code>AcGameObject</code></strong> ，使得每帧能渲染一张图片出来</p>
<p>该基类需要具备的功能有：</p>
<ol type="1">
<li><code>start()</code> 在游戏开始的第一帧时需要执行的任务（一般是创建对象）</li>
<li><code>update()</code> 在游戏开始后的每一帧均会执行的任务（一般是渲染当前对象的各种状态）</li>
<li><code>on_destroy()</code> 删掉该物体前需要执行的任务（一般是删掉动画，或者给对手加分）</li>
<li><code>destroy()</code> 删掉该物体</li>
</ol>
<p>根据上述逻辑，我们就可以基本搭建出来一个游戏引擎的基类了，具体如下：</p>
<p><strong><code>/static/js/playground/ac_game_object/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> AC_GAME_OBJECTS = [];   <span class="comment">//用于记录当前画布中，需要渲染的对象有哪些</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        AC_GAME_OBJECTS.push(<span class="built_in">this</span>);  <span class="comment">//将当前新建的对象，加入到全局的画布中去，参与渲染</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.has_called_start = <span class="literal">false</span>;  <span class="comment">//是否执行过 start 函数</span></span><br><span class="line">        <span class="built_in">this</span>.timedelta = <span class="number">0</span>;             <span class="comment">//当前帧距离上一帧的时间间隔</span></span><br><span class="line">        <span class="comment">// 该数据记录是为了后续计算速度等参数的</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;   <span class="comment">//只会在第一帧执行一次</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;  <span class="comment">//每一帧均会执行一次</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">on_destroy</span>(<span class="params"></span>)</span> &#123;  <span class="comment">//在被销毁前执行一次</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">destroy</span>(<span class="params"></span>)</span> &#123; <span class="comment">//删掉该物体</span></span><br><span class="line">        <span class="built_in">this</span>.on_destroy();  <span class="comment">//删掉该物体前，执行删前的操作</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在全局渲染物体中，找到该物体，并将其删掉</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; AC_GAME_OBJECTS.length; i ++ ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (AC_GAME_OBJECTS[i] === <span class="built_in">this</span>) &#123;  <span class="comment">//三等号，在js里额外加了一层类型相等约束</span></span><br><span class="line">                AC_GAME_OBJECTS.splice(i, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> last_timestamp;</span><br><span class="line"><span class="keyword">let</span> AC_GAME_ANIMATION = <span class="function"><span class="keyword">function</span>(<span class="params">timestamp</span>) </span>&#123;  <span class="comment">// 回调函数，实现：每一帧重绘时，都会执行一遍</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; AC_GAME_OBJECTS.length; i ++ ) &#123;</span><br><span class="line">        <span class="keyword">let</span> obj = AC_GAME_OBJECTS[i];</span><br><span class="line">        <span class="keyword">if</span> (!obj.has_called_start) &#123; <span class="comment">//如果还未执行初始帧动作，就先执行</span></span><br><span class="line">            obj.start();</span><br><span class="line">            obj.has_called_start = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;  <span class="comment">//执行过初始帧，就执行每一帧的任务</span></span><br><span class="line">            obj.timedelta = timestamp - last_timestamp;</span><br><span class="line">            obj.update();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    last_timestamp = timestamp; <span class="comment">//更新最后一次时间戳</span></span><br><span class="line">    requestAnimationFrame(AC_GAME_ANIMATION);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requestAnimationFrame(AC_GAME_ANIMATION);   <span class="comment">// js提供的api，其功能如下官方文档所示</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>window.requestAnimationFrame(callback)</code> 告诉浏览器——你希望执行一个动画，并且要求浏览器在下次重绘之前调用指定的回调函数更新动画。该方法需要传入一个回调函数作为参数，该回调函数会在浏览器下一次重绘之前执行。 参数 <code>callback</code> : 下一次重绘之前更新动画帧所调用的函数(即上面所说的回调函数)。该回调函数会被传入 <code>DOMHighResTimeStamp</code> 参数，该参数与 <code>performance.now()</code> 的返回值相同，它表示 <code>requestAnimationFrame()</code> 开始去执行回调函数的时刻。</p>
</blockquote>
<blockquote>
<p>接下来所有的一切游戏，都是基于这个引擎的基类完成的</p>
</blockquote>
<h2 id="实现游戏地图功能">实现游戏地图功能</h2>
<p>目标：实现一个每一秒都在渲染的纯黑背景</p>
<p>虽然现阶段要实现的地图较为简单，但为了后期的拓展性，故还是考虑新建一个文件夹来完成</p>
<p>然后在 <code>js</code> 中，已经封装好了一个 <code>canvas</code> 的 <code>api</code> 来帮助实现背景画布，直接调用即可</p>
<p>先铺开画布，然后设置为黑色</p>
<p><strong><code>static/js/playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// $(&#x27;.playground&#x27;)对象已经在 css 文件里渲染出高宽了</span></span><br><span class="line">        <span class="comment">// 现在把他的高宽存下来，往下传递</span></span><br><span class="line">        <span class="built_in">this</span>.width = <span class="built_in">this</span>.$playground.width();</span><br><span class="line">        <span class="built_in">this</span>.weight = <span class="built_in">this</span>.$playground.height();</span><br><span class="line">        <span class="built_in">this</span>.game_map = <span class="keyword">new</span> GameMap(<span class="built_in">this</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>static/js/playground/game-map/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameMap</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;    <span class="comment">//继承自游戏引擎基类</span></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();    <span class="comment">//自函数功能：调用基类的构造函数</span></span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line">        <span class="built_in">this</span>.$canvas = $(<span class="string">`&lt;canvas&gt;&lt;/canvas&gt;`</span>); <span class="comment">//创建一个canvas的jQuery对象，就是我们要实现的画布</span></span><br><span class="line">        <span class="built_in">this</span>.ctx = <span class="built_in">this</span>.$canvas[<span class="number">0</span>].getContext(<span class="string">&#x27;2d&#x27;</span>); <span class="comment">//jQuery对象是一个数组，第一个索引是html对象</span></span><br><span class="line">        <span class="comment">//设置画布的宽高</span></span><br><span class="line">        <span class="built_in">this</span>.ctx.canvas.width = <span class="built_in">this</span>.playground.width;</span><br><span class="line">        <span class="built_in">this</span>.ctx.canvas.height = <span class="built_in">this</span>.playground.height;</span><br><span class="line">        <span class="built_in">this</span>.playground.$playground.append(<span class="built_in">this</span>.$canvas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;  <span class="comment">//游戏地图每帧都要渲染</span></span><br><span class="line">        <span class="built_in">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillStyle = <span class="string">&quot;rgba(0, 0, 0, 0.2)&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">this</span>.ctx.canvas.width, <span class="built_in">this</span>.ctx.canvas.height);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h1 id="实现玩家显示功能">实现玩家显示功能</h1>
<p>毛坯版玩家显示，每个玩家定义成一个圆，然后渲染在前端</p>
<p>需要对于玩家类定义多个参数，以方便日后拓展：</p>
<ol type="1">
<li><code>x</code> 当前位置的横坐标</li>
<li><code>y</code> 当前位置的纵坐标</li>
<li><code>radius</code> 当前的半径</li>
<li><code>speed</code> 当前的速度</li>
<li><code>is_me</code> 该对象是否是当前玩家操控的对象（一是区别于 bot，二是区别于 日后联机的其他玩家）</li>
</ol>
<p><strong><code>static/js/playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="built_in">this</span>.players = [];  <span class="comment">// 存放当前游戏中的所有玩家</span></span><br><span class="line">        <span class="comment">//将玩家加入游戏中</span></span><br><span class="line">        <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span>, <span class="built_in">this</span>.height / <span class="number">2</span>, <span class="built_in">this</span>.height * <span class="number">0.05</span>, <span class="string">&quot;white&quot;</span>, <span class="built_in">this</span>.height * <span class="number">0.15</span>, <span class="literal">true</span>));</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>static/js/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground, x, y, radius, color, speed, is_me</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="comment">//把信息都存下来</span></span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line">        <span class="built_in">this</span>.ctx = <span class="built_in">this</span>.playground.game_map.ctx;</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">        <span class="built_in">this</span>.color = color;</span><br><span class="line">        <span class="built_in">this</span>.speed = speed;</span><br><span class="line">        <span class="built_in">this</span>.radius = radius;</span><br><span class="line">        <span class="built_in">this</span>.is_me = is_me;</span><br><span class="line">        <span class="comment">//用于浮点数运算</span></span><br><span class="line">        <span class="built_in">this</span>.eps = <span class="number">0.1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;  <span class="comment">//渲染一个圆</span></span><br><span class="line">        <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">        <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, <span class="built_in">this</span>.radius, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI, <span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillStyle = <span class="built_in">this</span>.color;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fill();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">on_destroy</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现玩家移动功能">实现玩家移动功能</h2>
<p>移动的实现逻辑很简单，就是让每帧渲染的圆的位置发生移动即可</p>
<p>上述简单逻辑的实现如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">....</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.vx = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">this</span>.vy = <span class="number">1</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.x += x;</span><br><span class="line">        <span class="built_in">this</span>.y += y;</span><br><span class="line">        <span class="built_in">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们来实现一个向鼠标点击位置移动的功能</p>
<p>这就需要设置一个 <code>click</code> 事件的监听函数，分别传递：</p>
<ol type="1">
<li>鼠标点击事件</li>
<li>鼠标点击位置的横坐标</li>
<li>鼠标点击位置的纵坐标</li>
</ol>
<p>然后开始让圆的位置逐步向鼠标点击位置进行移动</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.is_me) &#123;   <span class="comment">//对于用户玩家，加上监听函数</span></span><br><span class="line">        <span class="built_in">this</span>.add_listening_events();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">    <span class="comment">//把鼠标右键调出菜单栏的功能关掉</span></span><br><span class="line">    <span class="built_in">this</span>.playground.game_map.$canvas.on(<span class="string">&quot;contextmenu&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//把右键控制移动功能加上</span></span><br><span class="line">    <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 左键:1 中键:2 右键:3</span></span><br><span class="line">        <span class="keyword">if</span> (e.which === <span class="number">3</span>) &#123;</span><br><span class="line">            outer.move_to(e.clientX, e.clientY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们来实现移动功能的函数 <code>move_to(tx, ty)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">...</span>)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.vx = <span class="number">0</span>;    <span class="comment">//x方向上的移动速度</span></span><br><span class="line">    <span class="built_in">this</span>.vy = <span class="number">0</span>;    <span class="comment">//y方向上的移动速度</span></span><br><span class="line">    <span class="built_in">this</span>.move_length = <span class="number">0</span>;   <span class="comment">//剩余移动距离</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">get_dist (x1, y1, x2, y2) &#123; <span class="comment">//求两点的欧几里得距离</span></span><br><span class="line">    <span class="keyword">let</span> dx = x2 - x1;</span><br><span class="line">    <span class="keyword">let</span> dy = y2 - y1;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(dx * dx + dy * dy);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">move_to</span>(<span class="params">tx, ty</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 计算移动距离</span></span><br><span class="line">    <span class="built_in">this</span>.move_length = <span class="built_in">this</span>.get_dist(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, tx, ty);</span><br><span class="line">    <span class="comment">// 计算移动角度，api接口：atan2(dy, dx)</span></span><br><span class="line">    <span class="keyword">let</span> angle = <span class="built_in">Math</span>.atan2(ty - <span class="built_in">this</span>.y, tx - <span class="built_in">this</span>.x);</span><br><span class="line">    <span class="comment">// 位移 1 个单位长度（向着矢量方向移动到单位圆上）</span></span><br><span class="line">    <span class="built_in">this</span>.vx = <span class="built_in">Math</span>.cos(angle);  <span class="comment">//极直互化</span></span><br><span class="line">    <span class="built_in">this</span>.vy = <span class="built_in">Math</span>.sin(angle);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">//浮点数精度运算</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.move_length &lt; <span class="built_in">this</span>.eps) &#123;</span><br><span class="line">        <span class="built_in">this</span>.move_length = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.vx = <span class="built_in">this</span>.vy = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 计算单位帧里的移动距离</span></span><br><span class="line">        <span class="keyword">let</span> moved = <span class="built_in">Math</span>.min(<span class="built_in">this</span>.move_length, <span class="built_in">this</span>.speed * <span class="built_in">this</span>.timedelta / <span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">this</span>.x += <span class="built_in">this</span>.vx * moved;</span><br><span class="line">        <span class="built_in">this</span>.y += <span class="built_in">this</span>.vy * moved;</span><br><span class="line">        <span class="comment">// 还要减掉移动的距离</span></span><br><span class="line">        <span class="built_in">this</span>.move_length -= moved;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.render();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这样就实现了玩家的移动功能了，可以登录 <code>id:socket</code> 调试该功能</p>
<h1 id="实现火球技能的功能">实现火球技能的功能</h1>
<p>火球对象的建立与玩家基本一致，直接照搬，在从细节上改改即可</p>
<p><strong><code>js/src/playground/skill/fireball/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FireBall</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground, player, x, y, radius, vx, vy, color, speed, move_length, damage</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line">        <span class="built_in">this</span>.ctx = <span class="built_in">this</span>.playground.game_map.ctx;</span><br><span class="line">        <span class="built_in">this</span>.player = player;</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">        <span class="built_in">this</span>.vx = vx;</span><br><span class="line">        <span class="built_in">this</span>.vy = vy;</span><br><span class="line">        <span class="built_in">this</span>.radius = radius;</span><br><span class="line">        <span class="built_in">this</span>.color = color;</span><br><span class="line">        <span class="built_in">this</span>.speed = speed;</span><br><span class="line">        <span class="built_in">this</span>.move_length = move.length;</span><br><span class="line">        <span class="built_in">this</span>.damage = damage;</span><br><span class="line">        <span class="built_in">this</span>.eps = <span class="number">0.1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.move_length &lt; <span class="built_in">this</span>.eps) &#123;</span><br><span class="line">            <span class="built_in">this</span>.destroy();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> moved = <span class="built_in">Math</span>.min(<span class="built_in">this</span>.move_length, <span class="built_in">this</span>.speed * <span class="built_in">this</span>.timedelta / <span class="number">1000</span>);</span><br><span class="line">            <span class="built_in">this</span>.x += <span class="built_in">this</span>.vx * moved;</span><br><span class="line">            <span class="built_in">this</span>.y += <span class="built_in">this</span>.vy * moved;</span><br><span class="line">            <span class="built_in">this</span>.move_length -= moved;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">        <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, <span class="built_in">this</span>.radius, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span> * Pi, <span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillStyle = <span class="built_in">this</span>.color;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fill();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>然后在玩家身上实现发火球的功能</p>
<p>基本实现逻辑：当前选中了火球技能，鼠标左键点击一处，向该处发射一个火球</p>
<p>因此，为了知道用户是否选择了技能，需要加一个键盘触发事件监听函数，然后加一个鼠标左键触发事件监听函数</p>
<p>然后发射一个火球即可</p>
<p><strong><code>js/src/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">...</span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.cur_skill = <span class="literal">null</span>;  <span class="comment">//记录当前选择的技能</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 左键:1 中键:2 右键:3</span></span><br><span class="line">        <span class="keyword">if</span> (e.which === <span class="number">3</span>) &#123;</span><br><span class="line">            outer.move_to(e.clientX, e.clientY);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">1</span>) &#123;     <span class="comment">//鼠标左键事件</span></span><br><span class="line">            <span class="keyword">if</span> (outer.cur_skill === <span class="string">&quot;fireball&quot;</span>) &#123;   <span class="comment">//当前已经选中火球技能</span></span><br><span class="line">                outer.shoot_fireball(e.clientX, e.clientY);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        outer.cur_skill = <span class="literal">null</span>; <span class="comment">//清空当前技能</span></span><br><span class="line">    &#125;);</span><br><span class="line">    $(<span class="built_in">window</span>).keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e.which === <span class="number">81</span>) &#123;       <span class="comment">//键盘按下事件</span></span><br><span class="line">            outer.cur_skill = <span class="string">&quot;fireball&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">shoot_fireball</span>(<span class="params">tx, ty</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//确定火球的参数</span></span><br><span class="line">    <span class="keyword">let</span> x = <span class="built_in">this</span>.x, y = <span class="built_in">this</span>.y; <span class="comment">//火球发射点就是当前玩家的位置</span></span><br><span class="line">    <span class="keyword">let</span> radius = <span class="built_in">this</span>.playground.height * <span class="number">0.01</span>;</span><br><span class="line">    <span class="keyword">let</span> angle = <span class="built_in">Math</span>.atan2(ty - <span class="built_in">this</span>.y, tx - <span class="built_in">this</span>.x);</span><br><span class="line">    <span class="keyword">let</span> vx = <span class="built_in">Math</span>.cos(angle), vy = <span class="built_in">Math</span>.sin(angle);</span><br><span class="line">    <span class="keyword">let</span> color = <span class="string">&quot;orange&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> speed = <span class="built_in">this</span>.playground.height * <span class="number">0.5</span>;</span><br><span class="line">    <span class="keyword">let</span> move_length = <span class="built_in">this</span>.playground.height * <span class="number">1.0</span>;</span><br><span class="line">    <span class="keyword">let</span> damage = <span class="built_in">this</span>.playground.height * <span class="number">0.01</span>;</span><br><span class="line">    <span class="keyword">new</span> FireBall(<span class="built_in">this</span>.playground, <span class="built_in">this</span>, x, y, radius, vx, vy, color, speed, move_length, damage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就成功实现了玩家发射火球的功能了</p>
<h2 id="实现单人模式下的人机功能">实现单人模式下的人机功能</h2>
<p>先创建好 5 个人机</p>
<p><strong><code>playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建好 5 个人机</span></span><br><span class="line"><span class="keyword">for</span> (len i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++ ) &#123;</span><br><span class="line">    <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span>, <span class="built_in">this</span>.height / <span class="number">2</span>, <span class="built_in">this</span>.height * <span class="number">0.05</span>, <span class="string">&quot;blue&quot;</span>, <span class="built_in">this</span>.height * <span class="number">0.15</span>, <span class="literal">false</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样创建出来的 5 个人机是不会行动的</p>
<p>我们写一个简易的 Ai 程序，让他们也会移动</p>
<p>这里实现的逻辑是：每次随机一个目的地，向目的地移动，然后再随机一个目的地，循环下去</p>
<p>根据该逻辑，修改两个函数即可</p>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.is_me) &#123;   <span class="comment">//对于用户玩家，加上监听函数</span></span><br><span class="line">        <span class="built_in">this</span>.add_listening_events();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> tx = <span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.width;</span><br><span class="line">        <span class="keyword">let</span> ty = <span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.height;</span><br><span class="line">        <span class="built_in">this</span>.move_to(tx, ty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"> <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.move_length &lt; <span class="built_in">this</span>.eps) &#123;</span><br><span class="line">        <span class="built_in">this</span>.move_length = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.vx = <span class="built_in">this</span>.vy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.is_me) &#123;   <span class="comment">//如果是人机，停下来时再随机一个方向前进</span></span><br><span class="line">            <span class="keyword">let</span> tx = <span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.width;</span><br><span class="line">            <span class="keyword">let</span> ty = <span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.height;</span><br><span class="line">            <span class="built_in">this</span>.move_to(tx, ty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">on_destroy</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.playground.players.length; i ++ ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.playground.players[i] === <span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.playground.players.splice(i, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现技能命中效果碰撞检测功能">实现技能命中效果（碰撞检测功能）</h2>
<p>实现逻辑：检测两个圆的中心距离是否小于两个圆的半径之和</p>
<p>小于等于时，代表发生碰撞，开始执行命中效果：</p>
<ol type="1">
<li>被击中用户掉血</li>
<li>被击中用户收到向后击退效果</li>
</ol>
<p>碰撞检测写在火球类里，击退效果写在玩家类里</p>
<p><strong><code>fireball/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (...) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 碰撞检测</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.playground.players.length; i ++ ) &#123;</span><br><span class="line">            <span class="keyword">let</span> player = <span class="built_in">this</span>.playground.players[i];</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.player !== player &amp;&amp; <span class="built_in">this</span>.is_collision(player)) &#123;  <span class="comment">// 碰撞发生一定是在非施法者身上</span></span><br><span class="line">                <span class="built_in">this</span>.attack(player);    <span class="comment">//火球命中，目标玩家执行击退效果</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.render();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">get_dist</span>(<span class="params">x1, y1, x2, y2</span>)</span> &#123;  <span class="comment">//获得两点的欧几里得距离</span></span><br><span class="line">        <span class="keyword">let</span> dx = x2 - x1;</span><br><span class="line">        <span class="keyword">let</span> dy = y2 - y1;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(dx * dx + dy * dy);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="title">is_collision</span>(<span class="params">player</span>)</span> &#123;  <span class="comment">//检测两个圆的中心距离是否小于两个圆的半径之和</span></span><br><span class="line">    <span class="keyword">let</span> distance = <span class="built_in">this</span>.get_dist(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, player.x, player.y);</span><br><span class="line">    <span class="keyword">if</span> (distance &lt; (<span class="built_in">this</span>.radius + player.radius))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">attack</span>(<span class="params">player</span>)</span> &#123;    <span class="comment">//火球命中，目标玩家执行击退效果</span></span><br><span class="line">    <span class="keyword">let</span> angle = <span class="built_in">Math</span>.atan2(player.y - <span class="built_in">this</span>.y, player.x - <span class="built_in">this</span>.x);   <span class="comment">//计算角度</span></span><br><span class="line">    player.is_attacked(angle, <span class="built_in">this</span>.damage); <span class="comment">//火球命中，目标玩家执行击退效果</span></span><br><span class="line">    <span class="built_in">this</span>.destroy(); <span class="comment">//火球命中后，自然消失</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写击退效果时，有几个细节要注意</p>
<p>被击退的时候，原来的移动速度应该置为 0，当前的移动应该转为向被击中方向上的移动</p>
<p><strong><code>player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">is_attacked</span>(<span class="params">angle, damage</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.radius -= damage;  <span class="comment">//受伤，半径减少</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.radius &lt; <span class="number">10</span>) &#123; <span class="comment">//当半径小于10像素时，代表死亡</span></span><br><span class="line">        <span class="built_in">this</span>.destroy();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开始执行击退效果</span></span><br><span class="line">    <span class="built_in">this</span>.damage_vx = <span class="built_in">Math</span>.cos(angle);</span><br><span class="line">    <span class="built_in">this</span>.damage_vy = <span class="built_in">Math</span>.sin(angle);</span><br><span class="line">    <span class="built_in">this</span>.damage_speed = damage * <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.speed *= <span class="number">0.5</span>;  <span class="comment">//被击中以后移动速度减半</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.damage_speed &gt; <span class="built_in">this</span>.eps) &#123;   <span class="comment">//当前仍处于击退效果中</span></span><br><span class="line">        <span class="built_in">this</span>.vx = <span class="built_in">this</span>.vy = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.move_length = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.x += <span class="built_in">this</span>.damage_vx * <span class="built_in">this</span>.damage_speed * <span class="built_in">this</span>.timedelta / <span class="number">1000</span>;</span><br><span class="line">        <span class="built_in">this</span>.y += <span class="built_in">this</span>.damage_vy * <span class="built_in">this</span>.damage_speed * <span class="built_in">this</span>.timedelta / <span class="number">1000</span>;</span><br><span class="line">        <span class="built_in">this</span>.damage_speed *= <span class="built_in">this</span>.friction; <span class="comment">// 击退速度乘以摩擦系数，已达到削减的目的</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="被击中以后的粒子效果特效">被击中以后的粒子效果特效</h2>
<p>实现逻辑：被击中以后，在玩家附近随机生成一些粒子小球</p>
<p>因此我们要先实现 <strong>粒子小球</strong> 对象</p>
<p><strong><code>static/js/src/playground/particle/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Particle</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground, x, y, radius, vx, vy, color, speed</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line">        <span class="built_in">this</span>.ctx = <span class="built_in">this</span>.playground.game_map.ctx;</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">        <span class="built_in">this</span>.radius = radius;</span><br><span class="line">        <span class="built_in">this</span>.vx = vx;</span><br><span class="line">        <span class="built_in">this</span>.vy = vy;</span><br><span class="line">        <span class="built_in">this</span>.color = color;</span><br><span class="line">        <span class="built_in">this</span>.speed = speed;</span><br><span class="line">        <span class="built_in">this</span>.friction = <span class="number">0.9</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.speed &lt; <span class="built_in">this</span>.eps) &#123;</span><br><span class="line">            <span class="built_in">this</span>.destroy;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.x += <span class="built_in">this</span>.vx * <span class="built_in">this</span>.speed * <span class="built_in">this</span>.timedelta / <span class="number">1000</span>;</span><br><span class="line">        <span class="built_in">this</span>.y += <span class="built_in">this</span>.vy * <span class="built_in">this</span>.speed * <span class="built_in">this</span>.timedelta / <span class="number">1000</span>;</span><br><span class="line">        <span class="built_in">this</span>.speed *= <span class="built_in">this</span>.friction;</span><br><span class="line">        <span class="built_in">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">        <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, <span class="built_in">this</span>.radius, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI, <span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillStyle = <span class="built_in">this</span>.color;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fill();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>然后我们在被击退功能模块，实现生成粒子小球的效果</p>
<ul>
<li>粒子小球释放弧度为 <span class="math inline">\([0, 2 \pi)\)</span> 的随机数
<ul>
<li>粒子小球的 x, y 分量比率根据弧度来设定</li>
</ul></li>
<li>粒子小球的起始坐标应与玩家的坐标相同</li>
<li>粒子小球的颜色与玩家颜色相同</li>
<li>粒子小球的速度为玩家移动速度的 <span class="math inline">\(10\)</span> 倍</li>
</ul>
<p><strong><code>js/src/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">is_attacked</span>(<span class="params">angle, damage</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 粒子小球效果</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span> + <span class="built_in">Math</span>.random() * <span class="number">5</span>; i ++ ) &#123;</span><br><span class="line">        <span class="keyword">let</span> x = <span class="built_in">this</span>.x, y = <span class="built_in">this</span>.y;</span><br><span class="line">        <span class="keyword">let</span> radius = <span class="built_in">this</span>.radius * <span class="built_in">Math</span>.random() * <span class="number">0.1</span>;</span><br><span class="line">        <span class="keyword">let</span> angle = <span class="number">2</span> * <span class="built_in">Math</span>.PI * <span class="built_in">Math</span>.random();</span><br><span class="line">        <span class="keyword">let</span> vx = <span class="built_in">Math</span>.cos(angle), vy = <span class="built_in">Math</span>.sin(angle);</span><br><span class="line">        <span class="keyword">let</span> color = <span class="built_in">this</span>.color;</span><br><span class="line">        <span class="keyword">let</span> speed = <span class="built_in">this</span>.speed * <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">new</span> Particle(<span class="built_in">this</span>.playground, x, y, radius, vx, vy, color, speed);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一些小优化">一些小优化</h2>
<h3 id="人机随机颜色">人机随机颜色</h3>
<p><strong><code>js/src/playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//创建好 5 个人机</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++ ) &#123;</span><br><span class="line">        <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span>, <span class="built_in">this</span>.height / <span class="number">2</span>, <span class="built_in">this</span>.height * <span class="number">0.05</span>, <span class="built_in">this</span>.get_random_color(), <span class="built_in">this</span>.height * <span class="number">0.15</span>, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">get_random_color</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> colors = [<span class="string">&quot;blue&quot;</span>, <span class="string">&quot;red&quot;</span>, <span class="string">&quot;pink&quot;</span>, <span class="string">&quot;grey&quot;</span>, <span class="string">&quot;green&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> colors[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">5</span>)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="人机ai随机攻击操作">人机AI随机攻击操作</h3>
<p><strong><code>js/src/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">constructor</span> (<span class="params">...</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.spent_time = <span class="number">0</span>;    <span class="comment">// 初始人机冷却攻击时间</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.spent_time += <span class="built_in">this</span>.timedelta / <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.is_me &amp;&amp; <span class="built_in">this</span>.spent_time &gt; <span class="number">4</span> &amp;&amp; <span class="built_in">Math</span>.random() * <span class="number">180</span> &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> player = <span class="built_in">this</span>.playground.players[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.players.length)];</span><br><span class="line">        <span class="built_in">this</span>.shoot_fireball(player.x, player.y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="部署nginx与对接acapp-ஐ">部署nginx与对接acapp ஐ</h1>
<h2 id="增加容器的映射端口-80-与-443">增加容器的映射端口 : 80 与 443</h2>
<blockquote>
<p>给运行中的容器，开通端口，是一件非常麻烦的事情 一个比较好的解决方案 : 先把容器保存成镜像，再删掉容器，然后用镜像生成新的容器，同时打开需要的端口</p>
</blockquote>
<p>第一步，登录容器，关闭所有运行中的任务</p>
<p>第二步，登录运行容器的服务器，然后执行 :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker commit CONTAINER_NAME django_lesson:1.1  <span class="comment"># 将容器保存成镜像，将CONTAINER_NAME替换成容器名称</span></span><br><span class="line">docker stop CONTAINER_NAME  <span class="comment"># 关闭容器</span></span><br><span class="line">docker rm CONTAINER_NAME <span class="comment"># 删除容器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用保存的镜像重新创建容器</span></span><br><span class="line"></span><br><span class="line">docker run -p 20000:22 -p 8000:8000 -p 80:80 -p 443:443 --name CONTAINER_NAME -itd django_lesson:1.1</span><br></pre></td></tr></table></figure>
<p>第三步，去云服务器控制台，在安全组配置中开放80和443端口。</p>
<h2 id="创建acapp获取域名nginx配置文件及https证书">创建AcApp，获取域名、nginx配置文件及https证书</h2>
<p>打开 <strong>AcWing应用中心</strong> ，点击 “<strong>创建应用</strong>” 的按钮</p>
<p>系统分配的域名、nginx配置文件及https证书在如下位置 :</p>
<p><img src="https://cdn.acwing.com/media/article/image/2021/11/12/1_7dff276143-QQ%E5%9B%BE%E7%89%8720211112144041.png" /></p>
<p>在 <code>服务器IP</code> 一栏填入自己服务器的ip地址。</p>
<p>将 <code>nginx.conf</code> 中的内容写入服务器 <code>/etc/nginx/nginx.conf</code> 文件中。如果 <code>django</code> 项目路径与配置文件中不同，注意修改路径。 将 <code>acapp.key</code> 中的内容写入服务器 <code>/etc/nginx/cert/acapp.key</code> 文件中。 将 <code>acapp.pem</code> 中的内容写入服务器<code>/etc/nginx/cert/acapp.pem</code> 文件中。</p>
<p>然后启动nginx服务 :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /etc/init.d/nginx start</span><br><span class="line">&gt;  * Starting nginx nginx                              [ OK ]</span><br></pre></td></tr></table></figure>
<h2 id="修改django项目的配置">修改django项目的配置</h2>
<p>打开 <code>settings.py</code> 文件 :</p>
<ul>
<li>将分配的域名添加到 <code>ALLOWED_HOSTS</code> 列表中 (注意只需要添加 <code>https://</code> 后面的部分)</li>
<li>令 <code>DEBUG = False</code></li>
</ul>
<p>归档 <code>static</code> 文件 :</p>
<ul>
<li><code>python3 manage.py collectstatic</code></li>
</ul>
<blockquote>
<p>归档的目的是让 <code>static</code> 文件夹复制到 <code>BASIC_DIR</code> 下（之前在全局配置里改过的）</p>
</blockquote>
<h2 id="配置uwsgi">配置uwsgi</h2>
<blockquote>
<p>原来访问我们的 <code>Django</code> 项目，要通过访问网站的 <code>8000</code> 端口 配置好 <code>uwsgi</code>后，就可以直接通过 <code>nginx</code> 直接访问域名即可</p>
</blockquote>
<p>在 <code>django</code> 项目中添加uwsgi的配置文件 : <code>scripts/uwsgi.ini</code> ，内容如下 :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">socket          = 127.0.0.1:8000</span><br><span class="line"><span class="built_in">chdir</span>           = /home/acs/acapp</span><br><span class="line">wsgi-file       = acapp/wsgi.py</span><br><span class="line">master          = <span class="literal">true</span></span><br><span class="line">processes       = 2</span><br><span class="line">threads         = 5</span><br><span class="line">vacuum          = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>启动 <code>uwsgi</code> 服务 :</p>
<p>要事先关闭原来开启的 <code>django</code> 项目，然后再用 <code>uwsgi</code> 命令启动 <code>django</code> 项目</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ uwsgi --ini scripts/uwsgi.ini</span><br></pre></td></tr></table></figure>
<h2 id="使分配的域名生效">使分配的域名生效</h2>
<p>填写完服务器 <code>IP</code> 之后，点 “<strong>保存</strong>” 或者 “<strong>提交</strong>” 按钮，均可使分配的域名生效</p>
<p>提交后点”打开应用”按钮，即可预览自己所写的应用</p>
<h2 id="发布应用">发布应用</h2>
<p>等项目调试完之后，可以申请发布应用。审核通过后，你的acapp应用就可以与大家见面啦！</p>
<h2 id="针对-acapp-的优化">针对 acapp 的优化</h2>
<h3 id="打包脚本优化">打包脚本优化</h3>
<p>由于现在 <strong>发布版本的脚本文件</strong> 用的是打包在根目录里的 <strong>static</strong> 文件夹</p>
<p>每次修改好 <strong>static</strong> 文件夹后，不太需要对 <strong>js</strong> 文件打包，还需要对 <strong>static</strong> 文件夹打包</p>
<p>不放把 "将static文件夹打包" 的 <strong>shell</strong> 代码一起加入 <strong>js</strong> 打包脚本中，从而实现一键打包</p>
<p><strong><code>scripts/compress_game_js.sh</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line">JS_PATH=/home/acs/acapp/game/static/js/</span><br><span class="line">JS_PATH_DIST=<span class="variable">$&#123;JS_PATH&#125;</span>dist/</span><br><span class="line">JS_PATH_SRC=<span class="variable">$&#123;JS_PATH&#125;</span>src/</span><br><span class="line"></span><br><span class="line">find <span class="variable">$JS_PATH_SRC</span> -<span class="built_in">type</span> f -name <span class="string">&#x27;*.js&#x27;</span> | sort | xargs cat &gt; <span class="variable">$&#123;JS_PATH_DIST&#125;</span>game.js</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;yes&quot;</span> | python3 manage.py collectstatic</span><br></pre></td></tr></table></figure>
<h3 id="鼠标点击事件的相对偏移">鼠标点击事件的相对偏移</h3>
<p>由于写游戏界面的时候，玩家移动是按照鼠标相对于当前整个浏览器取的位置参数 <code>e.clientX</code></p>
<p>而 <code>acapp</code> 里，每个应用是一个小窗口，鼠标点击位置的参数应当是 相对于整个游戏窗口的位置参数</p>
<p>所有会导致出现，点击的位置与移动的位置不同，这里需要做出小优化</p>
<p>优化的逻辑 :</p>
<ol type="1">
<li><span class="math inline">\(clientX - \text{窗口左侧到浏览器左侧的距离} = \text{玩家的目标} X\)</span></li>
<li><span class="math inline">\(clientY - \text{窗口上侧到浏览器上侧的距离} = \text{玩家的目标} Y\)</span></li>
</ol>
<p>这就要用到一个 <code>js</code> 的 <code>API</code> 了 : <code>getBoundingClientRect()</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rectObject = object.getBoundingClientRect();</span><br><span class="line"> </span><br><span class="line">rectObject.top : 元素上边到视窗上边的距离;</span><br><span class="line">rectObject.right : 元素右边到视窗左边的距离;</span><br><span class="line">rectObject.bottom : 元素下边到视窗上边的距离;</span><br><span class="line">rectObject.left : 元素左边到视窗左边的距离;</span><br><span class="line">rectObject.width : 是元素自身的宽</span><br><span class="line">rectObject.height : 是元素自身的高</span><br></pre></td></tr></table></figure>
<p><strong><code>player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//创建 rect 对象</span></span><br><span class="line">        <span class="keyword">const</span> rect = outer.ctx.canvas.getBoundingClientRect();</span><br><span class="line">        <span class="keyword">if</span> (e.which === <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="comment">//调整偏移量</span></span><br><span class="line">            outer.move_to(e.clientX - rect.left, e.clientY - rect.top);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (outer.cur_skill === <span class="string">&quot;fireball&quot;</span>) &#123;</span><br><span class="line">                <span class="comment">//调整偏移量</span></span><br><span class="line">                outer.shoot_fireball(e.clientX - rect.left, e.clientY - rect.top);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="将菜单界面重新设为主界面">将菜单界面重新设为主界面</h3>
<p><strong><code>js/zbase.js</code></strong> 的注释取消，使之创建出 <strong>menu</strong> 对象</p>
<p><strong><code>js/playground/zbase.js</code></strong> 的注释取消，并设置逻辑，让 <strong>playground</strong> 打开后，才进行游戏界面初始化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.root = root;</span><br><span class="line">        <span class="built_in">this</span>.$playground = $(<span class="string">`&lt;div class=&quot;ac-game-playground&quot;&gt;&lt;/div&gt;`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.hide();    <span class="comment">//初始时隐藏</span></span><br><span class="line">        <span class="comment">// 游戏界面生成代码在下面展示 playground 时执行</span></span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//打开 playground 界面</span></span><br><span class="line">        <span class="built_in">this</span>.$playground.show();</span><br><span class="line">        <span class="comment">//开始生成游戏界面</span></span><br><span class="line">        <span class="built_in">this</span>.root.$ac_game.append(<span class="built_in">this</span>.$playground);</span><br><span class="line">        <span class="built_in">this</span>.width = <span class="built_in">this</span>.$playground.width();</span><br><span class="line">        <span class="built_in">this</span>.height = <span class="built_in">this</span>.$playground.height();</span><br><span class="line">        <span class="built_in">this</span>.game_map = <span class="keyword">new</span> GameMap(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.players = [];  <span class="comment">// 存放当前游戏中的所有玩家</span></span><br><span class="line">        <span class="comment">//将玩家加入游戏中</span></span><br><span class="line">        <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span>, <span class="built_in">this</span>.height / <span class="number">2</span>, <span class="built_in">this</span>.height * <span class="number">0.05</span>, <span class="string">&quot;white&quot;</span>, <span class="built_in">this</span>.height * <span class="number">0.15</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建好 5 个人机</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++ ) &#123;</span><br><span class="line">            <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span>, <span class="built_in">this</span>.height / <span class="number">2</span>, <span class="built_in">this</span>.height * <span class="number">0.05</span>, <span class="built_in">this</span>.get_random_color(), <span class="built_in">this</span>.height * <span class="number">0.15</span>, <span class="literal">false</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调整-css-文件适应窗口">调整 css 文件，适应窗口</h2>
<p>在设置 web 网页的时候，有些设置了绝对值，可能对于窗口化的 acapp 显示效果差</p>
<p>将他们修改成相对数值</p>
<p><strong><code>game.css</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">.ac-game-menu-field &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">top</span>: <span class="number">40</span>%;</span><br><span class="line">    left: <span class="number">20</span>%;</span><br><span class="line">&#125;</span><br><span class="line">.ac-game-menu-field-item &#123;</span><br><span class="line">    <span class="attr">height</span>: 6vh;</span><br><span class="line">    ...</span><br><span class="line">    font-size: 4vh;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h1 id="用户系统-ஐ">用户系统 ஐ</h1>
<h2 id="前期准备工作">前期准备工作</h2>
<p>做开发，先开启调试模式，如果不开启，服务器一旦运行错误，就只返回 <code>Error</code> 报错</p>
<p><strong><code>settings.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>然后创建一个超级用户，方便进入到后台管理 <code>admin</code> 页面</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3 manage.py createsuperuser</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>然后登陆到管理员页面：<code>http://xxxxx/admin/</code></p>
<p>不过 <code>django</code> 自带的 <code>User</code> 表并不能满足我们的需求，因此我们需要自己额外建表</p>
<h2 id="创建用户表">创建用户表</h2>
<p>所有的数据表都存在 <code>models</code> 里</p>
<p>我们在 <code>models</code> 里创建一个 <code>player</code> 文件夹，用于存储所有的 <code>player</code> 相关的表</p>
<p>然后对文件夹初始化 <code>__init__.py</code>，接着扩充成一个我们需要的数据表</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> models</span><br><span class="line">$ mkdir player</span><br><span class="line">$ <span class="built_in">cd</span> player</span><br><span class="line">$ touch __init__.py</span><br><span class="line">$ vim player.py</span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span>(<span class="params">models.Model</span>):</span> <span class="comment"># Player 类继承自 Model 类</span></span><br><span class="line">    user = models.OneToOneField(User, on_delete=models.CASCADE)</span><br><span class="line">    <span class="comment"># 说明Player是从User表扩充过来的，每一个player都与一个user是一一对应关联关系</span></span><br><span class="line">    <span class="comment"># 后一个参数是指，当user被删除后，对应的player也要被删除</span></span><br><span class="line">    <span class="comment"># （感觉就是外键的意思）</span></span><br><span class="line">    photo = models.URLField(max_length=<span class="number">256</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 用于存储用户的头像的url</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 指定每个player数据展示在前台的数据</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(self.user)    <span class="comment"># 展示用户的用户名</span></span><br></pre></td></tr></table></figure>
<p>将定义的表，注册到后台 <code>admin</code> 页面中</p>
<p><strong><code>game/admin.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">from</span> game.models.player.player <span class="keyword">import</span> Player</span><br><span class="line"></span><br><span class="line">admin.site.register(Player)</span><br></pre></td></tr></table></figure>
<p>然后将创建的数据表更新到 <code>django</code> 的数据库中去</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ python3 manage.py makemigrations</span><br><span class="line">&gt; Migrations <span class="keyword">for</span> <span class="string">&#x27;game&#x27;</span>:</span><br><span class="line">&gt;   game/migrations/0001_initial.py</span><br><span class="line">&gt;     - Create model Player</span><br><span class="line">$ </span><br><span class="line">$ python3 manage.py migrate</span><br><span class="line">&gt; Operations to perform:</span><br><span class="line">&gt;   Apply all migrations: admin, auth, contenttypes, game, sessions</span><br><span class="line">&gt; Running migrations:</span><br><span class="line">&gt;   Applying game.0001_initial... OK</span><br></pre></td></tr></table></figure>
<p>然后重启一下服务，就可以在管理员页面看到新建的数据库了</p>
<h2 id="实现客户端的类型判别acapp-or-web">实现客户端的类型判别（ACAPP or WEB）</h2>
<p>由于我们实现的项目是前后端分离类型，因此对于不同的客户端，前端要控制生成不同的页面</p>
<p>为了增强扩展性，故这里要实现客户端类型的判别</p>
<p><strong>y总</strong> 已经提前写好了 <strong>ACAPP</strong> 的接口，如果用户用的是 <strong>ACAPP</strong> 访问，则在新建对象 <strong>ac_game</strong> 时，会额外传递一个参数</p>
<p>我们只需按照这个接口去完成扩充即可</p>
<blockquote>
<p>之后写小程序之类的同理，额外传一个接口</p>
</blockquote>
<p><strong><code>js/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AcGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">id, AcWingOS</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.$ac_game = $(<span class="string">&#x27;#&#x27;</span> + id);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.AcWingOS = AcWingOS;   <span class="comment">//如果是acapp端，该变量就会带着一系列y总提供的接口</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.menu = <span class="keyword">new</span> AcGameMenu(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.playground = <span class="keyword">new</span> AcGamePlayground(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="构建登录功能框架">构建登录功能框架</h2>
<p>基本逻辑 : 用户访问页面 -&gt; 进入登录页面 -&gt; 提交登录信息 -&gt; 核对登录信息 -&gt; 返回登陆结果和其他信息</p>
<p>每实现一个函数，就需要实现三个部分：</p>
<ol type="1">
<li><code>views</code> : 实现具体的调用数据库的逻辑</li>
<li><code>urls</code> : 实现一个路由</li>
<li><code>js</code> : 前端实现GET上述接口的过程</li>
</ol>
<p>欲实现流程 : 1. 用户访问网站，通过先前完成的路由，访问到 <code>web.html</code> 2. <code>web.html</code> 中的 <code>js</code> 部分创建了一个 <code>AcGame</code> 对象 3. <code>AcGame</code> 对象创建的过程中，生成了 <code>Settings</code> 对象 4. <code>Settings</code> 对象创建完成后，调用 <code>Settings.start()</code> 函数 5. <code>Settings.start()</code> 函数调用了 <code>Settings.getinfo()</code> 函数 6. <code>Settings.getinfo()</code> 函数中执行了 <code>ajax</code> 向 <code>getinfo</code> 接口发起一个含参数 <code>platform</code> 的 <code>GET</code> 请求 7. 通过 <code>urls</code> 路由的实现，最终定位到 <code>views/settings/getinfo.py</code> 文件的 <code>getinfo(request)</code> 函数 8. 根据传递过来的 <code>platform</code> 函数，实现不同的 <code>JsonResponse</code> 返回 9. <code>Settings.getinfo()</code> 接受到了 <code>response</code> 完成上述基本逻辑</p>
<h3 id="views">views</h3>
<p><strong><code>views/settings/getinfo.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> game.models.player.player <span class="keyword">import</span> Player</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getinfo_acapp</span>(<span class="params">request</span>):</span></span><br><span class="line">    player = Player.objects.<span class="built_in">all</span>()[<span class="number">0</span>]    <span class="comment"># 取出数据库中第一个用户(调试该功能)</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">        <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: player.user.username,</span><br><span class="line">        <span class="string">&#x27;photo&#x27;</span>: player.photo,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getinfo_web</span>(<span class="params">request</span>):</span></span><br><span class="line">    player = Player.objects.<span class="built_in">all</span>()[<span class="number">0</span>]    <span class="comment"># 取出数据库中第一个用户(调试该功能)</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">        <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: player.user.username,</span><br><span class="line">        <span class="string">&#x27;photo&#x27;</span>: player.photo,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getinfo</span>(<span class="params">request</span>):</span>   <span class="comment"># 处理请求</span></span><br><span class="line">    platform = request.GET.get(<span class="string">&#x27;platform&#x27;</span>)  <span class="comment"># 根据请求的平台不同，进行不同返回处理</span></span><br><span class="line">    <span class="keyword">if</span> platform == <span class="string">&quot;ACAPP&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> getinfo_acapp(request)</span><br><span class="line">    <span class="keyword">elif</span> platform == <span class="string">&quot;WEB&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> getinfo_web(request)</span><br></pre></td></tr></table></figure>
<h3 id="urls">urls</h3>
<p><strong><code>urls/settings/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> game.views.settings.getinfo <span class="keyword">import</span> getinfo</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&quot;getinfo/&quot;</span>, getinfo, name=<span class="string">&quot;settings_getinfo&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>路由建立好以后，访问 <code>xxxx/settings/getinfo</code>，可以看到 <code>getinfo.py</code> 返回的 <code>JSON</code> 类型的 <code>JSONResponse</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;result&quot;: &quot;success&quot;, &quot;username&quot;: &quot;zxc&quot;, &quot;photo&quot;: &quot;https://cdn.acwing.com/media/user/profile/photo/55909_lg_c33d84c566.jpeg&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="js">js</h3>
<p>网页刚访问时，应先将 <strong>menu</strong> 关闭，然后打开登录界面，随意先修改一个让 <strong>menu</strong> 初始关闭</p>
<p><strong><code>static/js/src/menu/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGameMenu</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.$menu.hide();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p><strong><code>static/js/src/settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.root = root;</span><br><span class="line">        <span class="built_in">this</span>.platform = <span class="string">&quot;WEB&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.root.AcWingOS == <span class="string">&quot;ACAPP&quot;</span>) <span class="built_in">this</span>.platform = <span class="string">&quot;ACAPP&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getinfo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">register</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//打开注册界面</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">login</span>(<span class="params"></span>)</span> &#123;       <span class="comment">//打开登录界面</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">getinfo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&quot;https://app1117.acapp.acwing.com.cn/settings/getinfo/&quot;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">platform</span>: outer.platform,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(resp);</span><br><span class="line">                <span class="keyword">if</span> (resp.result === <span class="string">&quot;success&quot;</span>) &#123;    <span class="comment">//登录成功，关闭登录界面，打开主菜单</span></span><br><span class="line">                    outer.hide();</span><br><span class="line">                    outer.root.menu.show();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outer.login();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">hide</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后不要忘记在 <code>根js</code> 下创建对象</p>
<p><strong><code>static/js/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AcGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">id, AcWingOS</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.settings = <span class="keyword">new</span> Settings(<span class="built_in">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样基本框架就完成了</p>
<h3 id="完善-http-请求的函数">完善 <code>HTTP</code> 请求的函数</h3>
<p>如果用户未登录，返回信息 "not login"；如果用户登录，返回信息 "success" 以及用户名和头像</p>
<p><strong><code>views/setting/getinfo.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getinfo_web</span>(<span class="params">request</span>):</span></span><br><span class="line">    user = request.user</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user.is_authenticated:   <span class="comment"># 未登录</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;not login&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">else</span>:                           <span class="comment"># 已登录</span></span><br><span class="line">        player = Player.objects.get(user=user)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: player.user.username,</span><br><span class="line">            <span class="string">&#x27;photo&#x27;</span>: player.photo,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>
<p>注意前后台是一个登录系统，因此要先退掉后台，再测试</p>
<h2 id="将用户头像渲染到玩家上">将用户头像渲染到玩家上</h2>
<p>将返回的 <code>JsonResponse</code> 存到 <code>Settings</code> 类的变量中</p>
<p><strong><code>settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.username = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.photo = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">getinfo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (resp.result === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">                    outer.username = resp.username;</span><br><span class="line">                    outer.photo = resp.photo;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                ..</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>Player</code> 里把用户的头像渲染到对应的玩家上</p>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">...</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.img = <span class="keyword">new</span> Image();</span><br><span class="line">        <span class="built_in">this</span>.img.src = <span class="built_in">this</span>.playground.root.settings.photo;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.is_me) &#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx.save();</span><br><span class="line">            <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">            <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, <span class="built_in">this</span>.radius, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="built_in">this</span>.ctx.stroke();</span><br><span class="line">            <span class="built_in">this</span>.ctx.clip();</span><br><span class="line">            <span class="built_in">this</span>.ctx.drawImage(<span class="built_in">this</span>.img, <span class="built_in">this</span>.x - <span class="built_in">this</span>.radius, <span class="built_in">this</span>.y - <span class="built_in">this</span>.radius, </span><br><span class="line">                               <span class="built_in">this</span>.radius * <span class="number">2</span>, <span class="built_in">this</span>.radius * <span class="number">2</span>);</span><br><span class="line">            <span class="built_in">this</span>.ctx.restore();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">            <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, <span class="built_in">this</span>.radius, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI, <span class="literal">false</span>);</span><br><span class="line">            <span class="built_in">this</span>.ctx.fillStyle = <span class="built_in">this</span>.color;</span><br><span class="line">            <span class="built_in">this</span>.ctx.fill();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现登录界面的前端">实现登录界面的前端</h2>
<p>先完成登录界面显示的逻辑</p>
<p><strong><code>settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">register</span>(<span class="params"></span>)</span> &#123;  <span class="comment">// 打开注册界面</span></span><br><span class="line">        <span class="built_in">this</span>.$login.hide();</span><br><span class="line">        <span class="built_in">this</span>.$register.show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">login</span>(<span class="params"></span>)</span> &#123;  <span class="comment">// 打开登录界面</span></span><br><span class="line">        <span class="built_in">this</span>.$register.hide();</span><br><span class="line">        <span class="built_in">this</span>.$login.show();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">hide</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$settings.hide();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$settings.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现前端的基础框架">实现前端的基础框架</h3>
<p><strong><code>settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.$settings = $(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;div class=&quot;ac-game-settings&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;ac-game-settings-login&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-title&quot;&gt;</span></span><br><span class="line"><span class="string">            登录</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-username&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;ac-game-settings-item&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=&quot;text&quot; placeholder=&quot;用户名&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-password&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;ac-game-settings-item&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=&quot;password&quot; placeholder=&quot;密码&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-submit&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;ac-game-settings-item&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;button&gt;登录&lt;/button&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-error-message&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-option&quot;&gt;</span></span><br><span class="line"><span class="string">            注册</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-acwing&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;img width=&quot;30&quot; src=&quot;https://app165.acapp.acwing.com.cn/static/image/settings/acwing_logo.png&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;br&gt;</span></span><br><span class="line"><span class="string">            &lt;div&gt;</span></span><br><span class="line"><span class="string">                AcWing一键登录</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;ac-game-settings-register&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-title&quot;&gt;</span></span><br><span class="line"><span class="string">            注册</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-username&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;ac-game-settings-item&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=&quot;text&quot; placeholder=&quot;用户名&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-password ac-game-settings-password-first&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;ac-game-settings-item&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=&quot;password&quot; placeholder=&quot;密码&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-password ac-game-settings-password-second&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;ac-game-settings-item&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=&quot;password&quot; placeholder=&quot;确认密码&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-submit&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;ac-game-settings-item&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;button&gt;注册&lt;/button&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-error-message&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-option&quot;&gt;</span></span><br><span class="line"><span class="string">            登录</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;ac-game-settings-acwing&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;img width=&quot;30&quot; src=&quot;https://app165.acapp.acwing.com.cn/static/image/settings/acwing_logo.png&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;br&gt;</span></span><br><span class="line"><span class="string">            &lt;div&gt;</span></span><br><span class="line"><span class="string">                AcWing一键登录</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line">        <span class="built_in">this</span>.$login = <span class="built_in">this</span>.$settings.find(<span class="string">&quot;.ac-game-settings-login&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$login_username = <span class="built_in">this</span>.$login.find(<span class="string">&quot;.ac-game-settings-username input&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$login_password = <span class="built_in">this</span>.$login.find(<span class="string">&quot;.ac-game-settings-password input&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$login_submit = <span class="built_in">this</span>.$login.find(<span class="string">&quot;.ac-game-settings-submit button&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$login_error_message = <span class="built_in">this</span>.$login.find(<span class="string">&quot;.ac-game-settings-error-message&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$login_register = <span class="built_in">this</span>.$login.find(<span class="string">&quot;.ac-game-settings-option&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.$login.hide();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.$register = <span class="built_in">this</span>.$settings.find(<span class="string">&quot;.ac-game-settings-register&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$register_username = <span class="built_in">this</span>.$register.find(<span class="string">&quot;.ac-game-settings-username input&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$register_password = <span class="built_in">this</span>.$register.find(<span class="string">&quot;.ac-game-settings-password-first input&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$register_password_confirm = <span class="built_in">this</span>.$register.find(<span class="string">&quot;.ac-game-settings-password-second input&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$register_submit = <span class="built_in">this</span>.$register.find(<span class="string">&quot;.ac-game-settings-submit button&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$register_error_message = <span class="built_in">this</span>.$register.find(<span class="string">&quot;.ac-game-settings-error-message&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.$register_login = <span class="built_in">this</span>.$register.find(<span class="string">&quot;.ac-game-settings-option&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.$register.hide();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.root.$ac_game.append(<span class="built_in">this</span>.$settings);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的 <strong>css</strong> 文件部分：</p>
<p><strong><code>css/game.css</code></strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.ac-game-settings</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;/static/image/menu/background.gif&quot;</span>);</span><br><span class="line">    <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span>;</span><br><span class="line">    user-select: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-login</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">41vh</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20vw</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.7</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-title</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">3vh</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">padding-top</span>: <span class="number">2vh</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">2vh</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-username</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">7vh</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-password</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">7vh</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-submit</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">7vh</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-acwing</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">7vh</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-item</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-item</span> &gt; <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">90%</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">3vh</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-item</span> &gt; <span class="selector-tag">button</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">90%</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">3vh</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#4CAF50</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-error-message</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8vh</span>;</span><br><span class="line">    <span class="attribute">display</span>: inline;</span><br><span class="line">    <span class="attribute">float</span>: left;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">1vw</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-option</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">2vh</span>;</span><br><span class="line">    <span class="attribute">display</span>: inline;</span><br><span class="line">    <span class="attribute">float</span>: right;</span><br><span class="line">    <span class="attribute">padding-right</span>: <span class="number">1vw</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-acwing</span> &gt; <span class="selector-tag">img</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-acwing</span> &gt; <span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.5vh</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-settings-register</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">49vh</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20vw</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.7</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现登录注册的相互切换">实现登录/注册的相互切换</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getinfo();</span><br><span class="line">        <span class="built_in">this</span>.add_listening_events();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.add_listening_events_login();</span><br><span class="line">        <span class="built_in">this</span>.add_listening_events_register();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_listening_events_login</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.$login_register.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.register();   <span class="comment">//跳到注册界面</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_listening_events_register</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.$register_login.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.login();      <span class="comment">//跳到登录界面</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现登录功能">实现登录功能</h2>
<p><strong><code>views/settings/login.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> authenticate, login</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signin</span>(<span class="params">request</span>):</span></span><br><span class="line">    data = request.GET</span><br><span class="line">    username = data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    password = data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    user = authenticate(username=username, password=password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;用户名或密码不正确&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    login(request, user)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">        <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p><strong><code>urls/settings/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> game.views.settings.getinfo <span class="keyword">import</span> getinfo</span><br><span class="line"><span class="keyword">from</span> game.views.settings.login <span class="keyword">import</span> signin</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&quot;getinfo/&quot;</span>, getinfo, name=<span class="string">&quot;settings_getinfo&quot;</span>),</span><br><span class="line">    path(<span class="string">&quot;login/&quot;</span>, signin, name=<span class="string">&quot;settings_login&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong><code>settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events_login</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.$login_submit.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.login_on_remote();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">login_on_remote</span>(<span class="params"></span>)</span> &#123;     <span class="comment">//在远程服务器上登录</span></span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="keyword">let</span> username = <span class="built_in">this</span>.$login_username.val();</span><br><span class="line">        <span class="keyword">let</span> password = <span class="built_in">this</span>.$login_password.val();</span><br><span class="line">        <span class="built_in">this</span>.$login_error_message.empty();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&quot;https://app1117.acapp.acwing.com.cn/settings/login/&quot;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">username</span>: username,</span><br><span class="line">                <span class="attr">password</span>: password,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(resp);</span><br><span class="line">                <span class="keyword">if</span> (resp.result === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">                    location.reload();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outer.$login_error_message.html(resp.result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现登出功能">实现登出功能</h2>
<p><strong><code>views/settings/logout.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> logout</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signout</span>(<span class="params">request</span>):</span></span><br><span class="line">    user = request.user</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    logout(request)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">        <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p><strong><code>urls/settings/index.py</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">from</span> game.views.settings.logout <span class="keyword">import</span> signout</span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">&quot;logout/&quot;</span>, signout, name=<span class="string">&quot;settings_logout&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong><code>settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="title">login_on_remote</span>(<span class="params"></span>)</span> &#123;     <span class="comment">//在远程服务器上登录</span></span><br><span class="line">    <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">let</span> username = <span class="built_in">this</span>.$login_username.val();</span><br><span class="line">    <span class="keyword">let</span> password = <span class="built_in">this</span>.$login_password.val();</span><br><span class="line">    <span class="built_in">this</span>.$login_error_message.empty();</span><br><span class="line"></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;https://app1117.acapp.acwing.com.cn/settings/login/&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: &#123;</span><br><span class="line">            <span class="attr">username</span>: username,</span><br><span class="line">            <span class="attr">password</span>: password,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(resp);</span><br><span class="line">            <span class="keyword">if</span> (resp.result === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">                location.reload();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outer.$login_error_message.html(resp.result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>再顺便将 <strong>menu</strong> 菜单页面里的 <code>设置</code> 按钮也绑定上登出功能</p>
<p><strong><code>menu/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.$settings_mode.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        outer.root.settings.logout_on_remote();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现注册功能">实现注册功能</h2>
<p><strong><code>views/settings/logout.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> login</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> game.models.player.player <span class="keyword">import</span> Player</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">request</span>):</span></span><br><span class="line">    data = request.GET</span><br><span class="line">    username = data.get(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;&quot;</span>).strip()</span><br><span class="line">    password = data.get(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;&quot;</span>).strip()</span><br><span class="line">    password_confirm = data.get(<span class="string">&quot;password_confirm&quot;</span>, <span class="string">&quot;&quot;</span>).strip()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;用户名或密码不能为空&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">if</span> password != password_confirm:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;两个密码不一致&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">if</span> User.objects.<span class="built_in">filter</span>(username=username).exists():</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;用户名已存在&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    user = User(username=username)</span><br><span class="line">    user.set_password(password)</span><br><span class="line">    user.save()</span><br><span class="line">    Player.objects.create(user=user, photo=<span class="string">&quot;https://cdn.acwing.com/media/user/profile/photo/42832_lg_f999efc3c8.png&quot;</span>)</span><br><span class="line">    login(request, user)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">        <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p><strong><code>urls/settings/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">from</span> game.views.settings.register <span class="keyword">import</span> register</span><br><span class="line">...</span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">&quot;register/&quot;</span>, register, name=<span class="string">&quot;settings_register&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong><code>settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="title">add_listening_events_register</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.$register_submit.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        outer.register_on_remote();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="title">register_on_remote</span>(<span class="params"></span>)</span> &#123;  <span class="comment">//在远程服务器上注册</span></span><br><span class="line">    <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">let</span> username = <span class="built_in">this</span>.$register_username.val();</span><br><span class="line">    <span class="keyword">let</span> password = <span class="built_in">this</span>.$register_password.val();</span><br><span class="line">    <span class="keyword">let</span> password_confirm = <span class="built_in">this</span>.$register_password_confirm.val();</span><br><span class="line">    <span class="built_in">this</span>.$register_error_message.empty();</span><br><span class="line"></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;https://app1117.acapp.acwing.com.cn/settings/register/&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: &#123;</span><br><span class="line">            <span class="attr">username</span>: username,</span><br><span class="line">            <span class="attr">password</span>: password,</span><br><span class="line">            <span class="attr">password_confirm</span>: password_confirm,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(resp);</span><br><span class="line">            <span class="keyword">if</span> (resp.result === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">                location.reload();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outer.$register_error_message.html(resp.result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>成功实现注册功能，完美 w ~</p>
<h1 id="web端acwing一键登录-ஐ">web端AcWing一键登录 ஐ</h1>
<p>业务流程如下所示：</p>
<p><img src="https://cdn.acwing.com/media/article/image/2021/11/25/1_1ddf070e4d-weboauth2.png" /></p>
<h2 id="在django中集成redis">在Django中集成Redis</h2>
<p><strong>1. 安装 <code>django_redis</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django_redis</span><br></pre></td></tr></table></figure>
<p><strong>2. 配置 <code>settings.py</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123; </span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LOCATION&#x27;</span>: <span class="string">&#x27;redis://127.0.0.1:6379/1&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;CLIENT_CLASS&quot;</span>: <span class="string">&quot;django_redis.client.DefaultClient&quot;</span>,</span><br><span class="line">        &#125;,  </span><br><span class="line">    &#125;,  </span><br><span class="line">&#125;</span><br><span class="line">USER_AGENTS_CACHE = <span class="string">&#x27;default&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>3. 启动 <code>redis-server</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>
<h3 id="在-django-后台里操纵-reids">在 <code>django</code> 后台里操纵 <code>reids</code></h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ python3 manage.py shell<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [1]: from django.core.cache import cache # 引入redis</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [2]: cache.keys(&#x27;</span>*<span class="string">&#x27;)                     # 查询redis里所有的关键字</span></span><br><span class="line"><span class="string">Out[2]: []</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [3]: cache.set(&#x27;</span>yxc<span class="string">&#x27;, 1, 5)              # 插入一个key-val，存在 5 s</span></span><br><span class="line"><span class="string">Out[3]: True</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [4]: cache.keys(&#x27;</span>*<span class="string">&#x27;)                     # 查询redis里所有的关键字</span></span><br><span class="line"><span class="string">Out[4]: [&#x27;</span>yxc<span class="string">&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [5]: cache.set(&#x27;</span>yxc<span class="string">&#x27;, 2, None)           # 插入一个key-val，不会过期</span></span><br><span class="line"><span class="string">Out[5]: True</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [6]: cache.set(&#x27;</span>abc<span class="string">&#x27;, 3, None)</span></span><br><span class="line"><span class="string">Out[6]: True</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [7]: cache.keys(&#x27;</span>y*<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">Out[7]: [&#x27;</span>yxc<span class="string">&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [8]: cache.has_key(&#x27;</span>abc<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">Out[8]: True</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [9]: cache.has_key(&#x27;</span>abcd<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">Out[9]: False</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [10]: cache.get(&#x27;</span>yxc<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">Out[10]: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [11]: cache.delete(&#x27;</span>yxc<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">Out[11]: True</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [12]: cache.keys(&#x27;</span>*<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">Out[12]: [&#x27;</span>abc<span class="string">&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In [13]:</span></span><br></pre></td></tr></table></figure>
<h2 id="扩充player表">扩充Player表</h2>
<p>为了实现一键登录，需要额外存储一个 <code>openid</code> 来标识每一个 <code>Player</code> 绑定的 <code>AcWing</code> 账号</p>
<p><strong><code>models/player.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    openid = models.CharField(default=<span class="string">&quot;&quot;</span>, max_length=<span class="number">256</span>, blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>然后更新数据库：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3 manage.py makemigrations</span><br><span class="line">$ python3 manage.py migrate</span><br></pre></td></tr></table></figure>
<h2 id="申请授权码code">申请授权码code</h2>
<p>请求地址：<code>https://www.acwing.com/third_party/api/oauth2/web/authorize/</code></p>
<p>参考示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">请求方法：GET</span><br><span class="line">https://www.acwing.com/third_party/api/oauth2/web/authorize/?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;scope=SCOPE&amp;state=STATE</span><br></pre></td></tr></table></figure>
<p>参数说明</p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>参数</th>
<th>是否必须</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>appid</td>
<td>是</td>
<td>应用的唯一id，可以在AcWing编辑AcApp的界面里看到</td>
</tr>
<tr class="even">
<td>redirect_uri</td>
<td>是</td>
<td>接收授权码的地址。需要用 <code>urllib.parse.quote</code> 对链接进行处理</td>
</tr>
<tr class="odd">
<td>scope</td>
<td>是</td>
<td>申请授权的范围。目前只需填 <code>userinfo</code></td>
</tr>
<tr class="even">
<td>state</td>
<td>否</td>
<td>用于判断请求和回调的一致性，授权成功后后原样返回。该参数可用于防止csrf攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数</td>
</tr>
</tbody>
</table>
<p>返回说明</p>
<p>用户同意授权后会重定向到 <code>redirect_uri</code> ，返回参数为 <code>code</code> 和 <code>state</code> 。 链接格式如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redirect_uri?code=CODE&amp;state=STATE</span><br></pre></td></tr></table></figure>
<p>如果用户拒绝授权，则不会发生重定向。</p>
<h3 id="views-1">views</h3>
<blockquote>
<p>创建新的 <code>views</code> 和 <code>urls</code> 时不要忘记初始化一个 <code>__init__.py</code> 文件</p>
</blockquote>
<p><strong><code>views/settings/acwing/web/apply_code.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_state</span>():</span>    <span class="comment"># 随机8位数字</span></span><br><span class="line">    ress = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        res += <span class="built_in">str</span>(randint(<span class="number">0</span>, <span class="number">9</span>))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_code</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 传递的四个参数</span></span><br><span class="line">    appid = <span class="string">&quot;1117&quot;</span></span><br><span class="line">    redirect_uri = quote(<span class="string">&quot;https://app1117.acapp.acwing.com.cn/settings/acwing/web/receive_code/&quot;</span>)</span><br><span class="line">    scope = <span class="string">&quot;userinfo&quot;</span></span><br><span class="line">    state = get_state()</span><br><span class="line"></span><br><span class="line">    cache.<span class="built_in">set</span>(state, <span class="literal">True</span>, <span class="number">7200</span>)    <span class="comment"># 把随机的状态码存入 redis 中，有效期 2 小时</span></span><br><span class="line"></span><br><span class="line">    apply_code_url = <span class="string">&quot;https://www.acwing.com/third_party/api/oauth2/web/authorize/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">        <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;apply_code_url&#x27;</span>: apply_code_url + <span class="string">&quot;?appid=%s&amp;redirect_uri=%s&amp;scope=%s&amp;state=%s&quot;</span> % (appid, redirect_uri, scope, state)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p><strong><code>views/settings/acwing/web/receive_code.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive_code</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;index&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="urls-1">urls</h3>
<p>创建一个新的文件夹，然后建立路由</p>
<p><strong><code>urls/settings/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">&quot;acwing/&quot;</span>, include(<span class="string">&quot;game.urls.settings.acwing.index&quot;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong><code>urls/settings/acwing/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> game.views.settings.acwing.web.apply_code <span class="keyword">import</span> apply_code</span><br><span class="line"><span class="keyword">from</span> game.views.settings.acwing.web.receive_code <span class="keyword">import</span> receive_code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&quot;web/apply_code/&quot;</span>, apply_code, name=<span class="string">&quot;settings_acwing_web_apply_code&quot;</span>),</span><br><span class="line">    path(<span class="string">&quot;web/receive_code/&quot;</span>, receive_code, name=<span class="string">&quot;settings_acwing_web_receive_code&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="js-1">js</h3>
<p><strong><code>js/settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">...</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.$acwing_login = <span class="built_in">this</span>.$settings.find(<span class="string">&#x27;.ac-game=settings-acwing img&#x27;</span>); </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.$acwing_login.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.acwing_login();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">acwing_login</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&quot;https://app1117.acapp.acwing.com.cn/settings/acwing/web/apply_code/&quot;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(resp);</span><br><span class="line">                <span class="keyword">if</span> (resp.result === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">                    <span class="built_in">window</span>.location.replace(resp.apply_code_url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="申请授权令牌-access_token-和用户的-openid">申请授权令牌 <code>access_token</code> 和用户的 <code>openid</code></h2>
<p>请求地址：<code>https://www.acwing.com/third_party/api/oauth2/access_token/</code></p>
<p>参考示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">请求方法：GET</span><br><span class="line">https://www.acwing.com/third_party/api/oauth2/access_token/?appid=APPID&amp;secret=APPSECRET&amp;code=CODE</span><br></pre></td></tr></table></figure>
<p><strong>参数说明</strong></p>
<table>
<thead>
<tr class="header">
<th>参数</th>
<th>是否必须</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>appid</td>
<td>是</td>
<td>应用的唯一id，可以在AcWing编辑AcApp的界面里看到</td>
</tr>
<tr class="even">
<td>secret</td>
<td>是</td>
<td>应用的秘钥，可以在AcWing编辑AcApp的界面里看到</td>
</tr>
<tr class="odd">
<td>code</td>
<td>是</td>
<td>第一步中获取的授权码</td>
</tr>
</tbody>
</table>
<p><strong>返回说明</strong></p>
<p>申请成功示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span>: <span class="string">&quot;ACCESS_TOKEN&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;expires_in&quot;</span>: <span class="number">7200</span>, </span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span>: <span class="string">&quot;REFRESH_TOKEN&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;openid&quot;</span>: <span class="string">&quot;OPENID&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;SCOPE&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>申请失败示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errcode&quot;</span>: <span class="number">40001</span>,</span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;code expired&quot;</span>,  # 授权码过期</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>返回参数说明</strong></p>
<table>
<thead>
<tr class="header">
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>access_token</td>
<td>授权令牌，有效期2小时</td>
</tr>
<tr class="even">
<td>expires_in</td>
<td>授权令牌还有多久过期，单位（秒）</td>
</tr>
<tr class="odd">
<td>refresh_token</td>
<td>用于刷新access_token的令牌，有效期30天</td>
</tr>
<tr class="even">
<td>openid</td>
<td>用户的id。每个AcWing用户在每个acapp中授权的openid是唯一的,可用于识别用户。</td>
</tr>
<tr class="odd">
<td>scope</td>
<td>用户授权的范围。目前范围为userinfo，包括用户名、头像</td>
</tr>
</tbody>
</table>
<p><strong>刷新access_token的有效期</strong></p>
<p><code>access_token</code> 的有效期为2小时，时间较短。<code>refresh_token</code> 的有效期为30天，可用于刷新 <code>access_token</code>。刷新结果有两种：</p>
<p>如果 <code>access_token</code> 已过期，则生成一个新的 <code>access_token</code> 。 如果 <code>access_token</code> 未过期，则将当前的 <code>access_token</code> 的有效期延长为2小时。</p>
<p>参考示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">请求方法：GET</span><br><span class="line">https://www.acwing.com/third_party/api/oauth2/refresh_token/?appid=APPID&amp;refresh_token=REFRESH_TOKEN</span><br></pre></td></tr></table></figure>
<p>返回结果的格式与申请 <code>access_token</code> 相同。</p>
<h3 id="views-2">views</h3>
<p><strong><code>views/settings/acwing/web/receive_code.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive_code</span>(<span class="params">request</span>):</span></span><br><span class="line">    data = request.GET</span><br><span class="line">    code = data.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    state = data.get(<span class="string">&#x27;state&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(state):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;index&quot;</span>)</span><br><span class="line">    cache.delete(state)</span><br><span class="line"></span><br><span class="line">    apply_access_token_url = <span class="string">&quot;https://www.acwing.com/third_party/api/oauth2/access_token/&quot;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;appid&#x27;</span>: <span class="string">&quot;1117&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;secret&#x27;</span>: <span class="string">&quot;79021fb1f2344bb6a191237ece84d874&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;code&#x27;</span>: code</span><br><span class="line">    &#125;</span><br><span class="line">    access_token_res = requests.get(apply_access_token_url, params=params).json()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(access_token_res)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;index&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="申请用户信息">申请用户信息</h2>
<p>请求地址：<code>https://www.acwing.com/third_party/api/meta/identity/getinfo/</code></p>
<p>参考示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">请求方法：GET</span><br><span class="line">https://www.acwing.com/third_party/api/meta/identity/getinfo/?access_token=ACCESS_TOKEN&amp;openid=OPENID</span><br></pre></td></tr></table></figure>
<p><strong>参数说明</strong></p>
<table>
<thead>
<tr class="header">
<th>参数</th>
<th>是否必须</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>access_token</td>
<td>是</td>
<td>第二步中获取的授权令牌</td>
</tr>
<tr class="even">
<td>openid</td>
<td>是</td>
<td>第二步中获取的用户openid</td>
</tr>
</tbody>
</table>
<p><strong>返回说明</strong></p>
<p>申请成功示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;username&#x27;: <span class="string">&quot;USERNAME&quot;</span>,</span><br><span class="line">    &#x27;photo&#x27;: <span class="string">&quot;https:cdn.acwing.com/xxxxx&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>申请失败示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;errcode&#x27;: <span class="string">&quot;40004&quot;</span>,</span><br><span class="line">    &#x27;errmsg&#x27;: <span class="string">&quot;access_token expired&quot;</span>  # 授权令牌过期</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="views-3">views</h3>
<p><strong><code>views/settings/acwing/web/receive_code.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> game.models.player.player <span class="keyword">import</span> Player</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> login</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive_code</span>(<span class="params">request</span>):</span></span><br><span class="line">    data = request.GET</span><br><span class="line">    code = data.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    state = data.get(<span class="string">&#x27;state&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(state):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;index&quot;</span>)</span><br><span class="line">    cache.delete(state)</span><br><span class="line"></span><br><span class="line">    apply_access_token_url = <span class="string">&quot;https://www.acwing.com/third_party/api/oauth2/access_token/&quot;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;appid&#x27;</span>: <span class="string">&quot;1117&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;secret&#x27;</span>: <span class="string">&quot;79021fb1f2344bb6a191237ece84d874&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;code&#x27;</span>: code</span><br><span class="line">    &#125;</span><br><span class="line">    access_token_res = requests.get(apply_access_token_url, params=params).json()</span><br><span class="line"></span><br><span class="line">    access_token = access_token_res[<span class="string">&#x27;access_token&#x27;</span>]</span><br><span class="line">    openid = access_token_res[<span class="string">&#x27;openid&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    players = Player.objects.<span class="built_in">filter</span>(openid=openid)</span><br><span class="line">    <span class="keyword">if</span> players.exists():    <span class="comment"># 如果acw账户对应用户已经存在，直接登录</span></span><br><span class="line">        login(request, players[<span class="number">0</span>].user)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;index&quot;</span>)</span><br><span class="line"></span><br><span class="line">    get_userinfo_url = <span class="string">&quot;https://www.acwing.com/third_party/api/meta/identity/getinfo/&quot;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;access_token&quot;</span>: access_token,</span><br><span class="line">        <span class="string">&quot;openid&quot;</span>: openid</span><br><span class="line">    &#125;</span><br><span class="line">    userinfo_res = requests.get(get_userinfo_url, params=params).json()</span><br><span class="line">    username = userinfo_res[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    photo = userinfo_res[<span class="string">&#x27;photo&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> User.objects.<span class="built_in">filter</span>(username=username).exists():  <span class="comment"># 如果重名，额外添加数字填充</span></span><br><span class="line">        username += <span class="built_in">str</span>(randint(<span class="number">0</span>, <span class="number">9</span>))</span><br><span class="line"></span><br><span class="line">    user = User.objects.create(username=username)</span><br><span class="line">    player = Player.objects.create(user=user, photo=photo, openid=openid)</span><br><span class="line"></span><br><span class="line">    login(request, user)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;index&quot;</span>)</span><br></pre></td></tr></table></figure>
<h1 id="acapp端acwing一键登录-ஐ">AcApp端AcWing一键登录 ஐ</h1>
<p>业务流程如下所示：</p>
<p><img src="https://cdn.acwing.com/media/article/image/2021/11/25/1_1ddf070e4d-weboauth2.png" /></p>
<h2 id="申请授权码-code">申请授权码 <code>code</code></h2>
<p>请求授权码的API：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AcWingOS.api.oauth2.authorize(appid, redirect_uri, scope, state, callback);</span><br></pre></td></tr></table></figure>
<p><strong>参数说明</strong></p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>参数</th>
<th>是否必须</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>appid</td>
<td>是</td>
<td>应用的唯一id，可以在AcWing编辑AcApp的界面里看到</td>
</tr>
<tr class="even">
<td>redirect_uri</td>
<td>是</td>
<td>接收授权码的地址。需要用 <code>urllib.parse.quote</code> 对链接进行处理。</td>
</tr>
<tr class="odd">
<td>scope</td>
<td>是</td>
<td>申请授权的范围。目前只需填userinfo</td>
</tr>
<tr class="even">
<td>state</td>
<td>是</td>
<td>用于判断请求和回调的一致性，授权成功后后原样返回。该参数可用于防止csrf攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数</td>
</tr>
<tr class="odd">
<td>callback</td>
<td>是</td>
<td>redirect_uri返回后的回调函数</td>
</tr>
</tbody>
</table>
<p><strong>返回说明</strong></p>
<p>用户同意授权后，会将 <code>code</code> 和 <code>state</code> 传递给 <code>redirect_uri</code></p>
<p>如果用户拒绝授权，则将会收到如下错误码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    errcode: <span class="string">&quot;40010&quot;</span></span><br><span class="line">    errmsg: <span class="string">&quot;user reject&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>申请授权令牌 <code>access_token</code> 和用户的 <code>openid</code> 以及 申请用户信息 都与先前 web 端一键登录相同</p>
</blockquote>
<h3 id="views-4">views</h3>
<blockquote>
<p>创建新的 <code>views</code> 和 <code>urls</code> 时不要忘记初始化一个 <code>__init__.py</code> 文件</p>
</blockquote>
<p><strong><code>views/settings/acwing/acapp/apply_code.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_state</span>():</span>    <span class="comment"># 随机8位数字</span></span><br><span class="line">    res = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        res += <span class="built_in">str</span>(randint(<span class="number">0</span>, <span class="number">9</span>))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_code</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 传递的四个参数</span></span><br><span class="line">    appid = <span class="string">&quot;1117&quot;</span></span><br><span class="line">    redirect_uri = quote(<span class="string">&quot;https://app1117.acapp.acwing.com.cn/settings/acwing/web/receive_code/&quot;</span>)</span><br><span class="line">    scope = <span class="string">&quot;userinfo&quot;</span></span><br><span class="line">    state = get_state()</span><br><span class="line"></span><br><span class="line">    cache.<span class="built_in">set</span>(state, <span class="literal">True</span>, <span class="number">7200</span>)    <span class="comment"># 把随机的状态码存入 redis 中，有效期 2 小时</span></span><br><span class="line"></span><br><span class="line">    apply_code_url = <span class="string">&quot;https://www.acwing.com/third_party/api/oauth2/web/authorize/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;   <span class="comment"># 此处与先前不同</span></span><br><span class="line">        <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;appid&#x27;</span>: appid,</span><br><span class="line">        <span class="string">&#x27;redirect_uri&#x27;</span>: redirect_uri,</span><br><span class="line">        <span class="string">&#x27;scope&#x27;</span>: scope,</span><br><span class="line">        <span class="string">&#x27;state&#x27;</span>: state,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p><strong><code>views/settings/acwing/acapp/receive_code.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> game.models.player.player <span class="keyword">import</span> Player</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> login</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive_code</span>(<span class="params">request</span>):</span></span><br><span class="line">    data = request.GET</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;errcode&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;apply failed&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;errcode&#x27;</span>: data[<span class="string">&#x27;errcode&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;errmsg&#x27;</span>: data[<span class="string">&#x27;errmsg&#x27;</span>],</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    code = data.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    state = data.get(<span class="string">&#x27;state&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(state):</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;state not exists&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    cache.delete(state)</span><br><span class="line"></span><br><span class="line">    apply_access_token_url = <span class="string">&quot;https://www.acwing.com/third_party/api/oauth2/access_token/&quot;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;appid&#x27;</span>: <span class="string">&quot;1117&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;secret&#x27;</span>: <span class="string">&quot;79021fb1f2344bb6a191237ece84d874&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;code&#x27;</span>: code</span><br><span class="line">    &#125;</span><br><span class="line">    access_token_res = requests.get(apply_access_token_url, params=params).json()</span><br><span class="line"></span><br><span class="line">    access_token = access_token_res[<span class="string">&#x27;access_token&#x27;</span>]</span><br><span class="line">    openid = access_token_res[<span class="string">&#x27;openid&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    players = Player.objects.<span class="built_in">filter</span>(openid=openid)</span><br><span class="line">    <span class="keyword">if</span> players.exists():    <span class="comment"># 如果acw账户对应用户已经存在，直接登录</span></span><br><span class="line">        player = players[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: player.user.username,</span><br><span class="line">            <span class="string">&#x27;photo&#x27;</span>: player.photo,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    get_userinfo_url = <span class="string">&quot;https://www.acwing.com/third_party/api/meta/identity/getinfo/&quot;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;access_token&quot;</span>: access_token,</span><br><span class="line">        <span class="string">&quot;openid&quot;</span>: openid</span><br><span class="line">    &#125;</span><br><span class="line">    userinfo_res = requests.get(get_userinfo_url, params=params).json()</span><br><span class="line">    username = userinfo_res[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    photo = userinfo_res[<span class="string">&#x27;photo&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> User.objects.<span class="built_in">filter</span>(username=username).exists():  <span class="comment"># 如果重名，额外添加数字填充</span></span><br><span class="line">        username += <span class="built_in">str</span>(randint(<span class="number">0</span>, <span class="number">9</span>))</span><br><span class="line"></span><br><span class="line">    user = User.objects.create(username=username)</span><br><span class="line">    player = Player.objects.create(user=user, photo=photo, openid=openid)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">        <span class="string">&#x27;result&#x27;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: player.user.username,</span><br><span class="line">        <span class="string">&#x27;photo&#x27;</span>: player.photo,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="urls-2">urls</h3>
<p><strong><code>urls/settings/acwing/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> game.views.settings.acwing.web.apply_code <span class="keyword">import</span> apply_code <span class="keyword">as</span> web_apply_code</span><br><span class="line"><span class="keyword">from</span> game.views.settings.acwing.web.receive_code <span class="keyword">import</span> receive_code <span class="keyword">as</span> _web_receive_code</span><br><span class="line"><span class="keyword">from</span> game.views.settings.acwing.acapp.apply_code <span class="keyword">import</span> apply_code <span class="keyword">as</span> acapp_apply_code</span><br><span class="line"><span class="keyword">from</span> game.views.settings.acwing.acapp.receive_code <span class="keyword">import</span> receive_code <span class="keyword">as</span> acapp_receive_code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&quot;web/apply_code/&quot;</span>, web_apply_code, name=<span class="string">&quot;settings_acwing_web_apply_code&quot;</span>),</span><br><span class="line">    path(<span class="string">&quot;web/receive_code/&quot;</span>, web_receive_code, name=<span class="string">&quot;settings_acwing_web_receive_code&quot;</span>),</span><br><span class="line">    path(<span class="string">&quot;acapp/apply_code/&quot;</span>, acapp_apply_code, name=<span class="string">&quot;settings_acwing_acapp_apply_code&quot;</span>),</span><br><span class="line">    path(<span class="string">&quot;acapp/receive_code/&quot;</span>, acapp_receive_code, name=<span class="string">&quot;settings_acwing_acapp_receive_code&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="js-2">js</h3>
<p><strong><code>js/src/settings/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.platform === <span class="string">&quot;ACAPP&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.getinfo_acapp();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.getinfo_web();</span><br><span class="line">            <span class="built_in">this</span>.add_listening_events();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">acapp_login</span>(<span class="params">appid, redirect_uri, scope, state</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.root.AcWingOS.api.oauth2.authorize(appid, redirect_uri, scope, state, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(resp);</span><br><span class="line">            <span class="keyword">if</span> (resp.result === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">                outer.username = resp.username;</span><br><span class="line">                outer.photo = resp.photo;</span><br><span class="line">                outer.hide();</span><br><span class="line">                outer.root.menu.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">getinfo_acapp</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&quot;https://app1117.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/&quot;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (resp.result === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">                    outer.acapp_login(resp.appid, resp.redirect_uri, resp.scope, resp.state);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="实现联机对战-ஐ">实现联机对战 ஐ</h1>
<h2 id="统一长度单位">统一长度单位</h2>
<p>由于联机对战的时候，每个用户的客户端长宽不一样</p>
<p>在之前完成的游戏界面里，我们会根据当前客户端的大小，进行渲染</p>
<p>但是在联机对战的时候，应当让所有玩家的游戏界面保持同步才可以</p>
<p>所有，就引入了 <strong>统一长度单位</strong> 的目标</p>
<h3 id="地图渲染">地图渲染</h3>
<h4 id="地图-169-等比例缩放">地图 16:9 等比例缩放</h4>
<p>实现逻辑：根据当前用户的客户端大小，统一渲染成 <strong>16:9</strong> 的游戏界面，且随着用户调整窗口大小，也动态调整</p>
<p><strong><code>js/src/playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">root</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.root.$ac_game.append(<span class="built_in">this</span>.$playground);<span class="comment">// 未来可能会多次 show 因此把创建场景挪到这里</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        $(<span class="built_in">window</span>).resize(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.resize();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resize</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.width = <span class="built_in">this</span>.$playground.width();</span><br><span class="line">        <span class="built_in">this</span>.height = <span class="built_in">this</span>.$playground.height();</span><br><span class="line">        <span class="keyword">let</span> unit = <span class="built_in">Math</span>.min(<span class="built_in">this</span>.width / <span class="number">16</span>, <span class="built_in">this</span>.height / <span class="number">9</span>);  <span class="comment">// 以最小的作为基准，渲染</span></span><br><span class="line">        <span class="built_in">this</span>.width = unit * <span class="number">16</span>;</span><br><span class="line">        <span class="built_in">this</span>.height = unit * <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.resize();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.scale = <span class="built_in">this</span>.height;   <span class="comment">// resize时，其他元素的渲染大小都以当前渲染的高度为基准，存为 scale 变量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.game_map) <span class="built_in">this</span>.game_map.resize();  <span class="comment">//如果此时地图已创建，则resize一下</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//打开 playground 界面</span></span><br><span class="line">        <span class="built_in">this</span>.$playground.show();</span><br><span class="line">        <span class="built_in">this</span>.resize();</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/playground/game_map/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameMap</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">resize</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx.canvas.width = <span class="built_in">this</span>.playground.width;</span><br><span class="line">        <span class="built_in">this</span>.ctx.canvas.height = <span class="built_in">this</span>.playground.height;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="地图居中">地图居中</h4>
<p>直接把 <strong>canvas</strong> 元素，用相对位置居中即可</p>
<p><strong><code>css/game.css</code></strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="selector-class">.ac-game-playground</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attribute">background-color</span>: grey;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.ac-game-playground</span> &gt; <span class="selector-tag">canvas</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解决地图-resize-时会出现渐变成黑色的情况">解决地图 resize 时，会出现渐变成黑色的情况</h4>
<p>原由是因为我们的实现逻辑是：每帧会渲染一层半透明的黑色背景</p>
<p>也就造就了一开始会出现灰屏的情况，解决方法很简单，直接 resize 完，强制涂一层不透明的黑色即可</p>
<p><strong><code>js/src/playground/game_map/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameMap</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">resize</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx.canvas.width = <span class="built_in">this</span>.playground.width;</span><br><span class="line">        <span class="built_in">this</span>.ctx.canvas.height = <span class="built_in">this</span>.playground.height;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillStyle = <span class="string">&quot;rgba(0, 0, 0, 1)&quot;</span>;    <span class="comment">// resize 完，涂一层不透明的即可</span></span><br><span class="line">        <span class="built_in">this</span>.ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">this</span>.ctx.canvas.width, <span class="built_in">this</span>.ctx.canvas.height);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="元素渲染">元素渲染</h3>
<p>地图随着尺寸等比例放大缩小的同时，地图内的其他元素也应与背景一同等比例放大缩小</p>
<p>因此，我们只需把元素全部设为相对大小即可，用我们先前设置的 playground.scale 值即可</p>
<h4 id="玩家-player">玩家 Player</h4>
<p>初始化的时候，转为传递 <strong>scale</strong> 的比例值</p>
<p><strong><code>js/src/playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//打开 playground 界面</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span> / <span class="built_in">this</span>.scale, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="string">&quot;white&quot;</span>, <span class="number">0.15</span>, <span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++ ) &#123;</span><br><span class="line">            <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span> / <span class="built_in">this</span>.scale, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="built_in">this</span>.get_random_color(), <span class="number">0.15</span>, <span class="literal">false</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.is_me) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> tx = <span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.width / <span class="built_in">this</span>.playground.scale;</span><br><span class="line">            <span class="keyword">let</span> ty = <span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.height / <span class="built_in">this</span>.playground.scale;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (e.which === <span class="number">3</span>) &#123;</span><br><span class="line">                outer.move_to((e.clientX - rect.left) / outer.playground.scale, (e.clientY - rect.top) / outer.playground.scale);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (outer.cur_skill === <span class="string">&quot;fireball&quot;</span>) &#123;</span><br><span class="line">                    outer.shoot_fireball((e.clientX - rect.left) / outer.playground.scale, (e.clientY - rect.top) / outer.playground.scale);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">shoot_fireball</span>(<span class="params">tx, ty</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> x = <span class="built_in">this</span>.x, y = <span class="built_in">this</span>.y;</span><br><span class="line">        <span class="keyword">let</span> radius = <span class="number">0.01</span>;</span><br><span class="line">        <span class="keyword">let</span> angle = <span class="built_in">Math</span>.atan2(ty - <span class="built_in">this</span>.y, tx - <span class="built_in">this</span>.x);</span><br><span class="line">        <span class="keyword">let</span> vx = <span class="built_in">Math</span>.cos(angle), vy = <span class="built_in">Math</span>.sin(angle);</span><br><span class="line">        <span class="keyword">let</span> color = <span class="string">&quot;orange&quot;</span>;</span><br><span class="line">        <span class="keyword">let</span> speed = <span class="number">0.5</span>;</span><br><span class="line">        <span class="keyword">let</span> move_length = <span class="number">1.0</span>;</span><br><span class="line">        <span class="keyword">let</span> damage = <span class="number">0.01</span>;</span><br><span class="line">        <span class="keyword">new</span> FireBall(<span class="built_in">this</span>.playground, <span class="built_in">this</span>, x, y, radius, vx, vy, color, speed, move_length, damage);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.update_move();</span><br><span class="line">        <span class="built_in">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update_move</span>(<span class="params"></span>)</span> &#123; <span class="comment">//更新玩家移动</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.is_me &amp;&amp; <span class="built_in">this</span>.spent_time &gt; <span class="number">4</span> &amp;&amp; <span class="built_in">Math</span>.random() * <span class="number">180</span> &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.damage_speed &gt; <span class="built_in">this</span>.eps) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.move_length &lt; <span class="built_in">this</span>.eps) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">this</span>.is_me) &#123;</span><br><span class="line">                    <span class="keyword">let</span> tx = <span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.width / <span class="built_in">this</span>.playground.scale;</span><br><span class="line">                    <span class="keyword">let</span> ty = <span class="built_in">Math</span>.random() * <span class="built_in">this</span>.playground.height / <span class="built_in">this</span>.playground.scale;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> scale = <span class="built_in">this</span>.playground.scale;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.is_me) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x * scale, <span class="built_in">this</span>.y * scale, <span class="built_in">this</span>.radius * scale, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>, <span class="literal">false</span>);</span><br><span class="line">            ...</span><br><span class="line">            <span class="built_in">this</span>.ctx.drawImage(<span class="built_in">this</span>.img, (<span class="built_in">this</span>.x - <span class="built_in">this</span>.radius) * scale, (<span class="built_in">this</span>.y - <span class="built_in">this</span>.radius) * scale, <span class="built_in">this</span>.radius * <span class="number">2</span> * scale, <span class="built_in">this</span>.radius * <span class="number">2</span> * scale);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x * scale, <span class="built_in">this</span>.y * scale, <span class="built_in">this</span>.radius * scale, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI, <span class="literal">false</span>);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="火球-fireball">火球 Fireball</h4>
<p><strong><code>js/src/playground/skill/fireball/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fireball</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> scale = <span class="built_in">this</span>.playground.scale;</span><br><span class="line">        <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">        <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x * scale, <span class="built_in">this</span>.y * scale, <span class="built_in">this</span>.radius * scale, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI, <span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillStyle = <span class="built_in">this</span>.color;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fill();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="粒子-particle">粒子 particle</h4>
<p><strong><code>js/src/playground/particle/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Particle</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> scale = <span class="built_in">this</span>.playground.scale;</span><br><span class="line">        <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">        <span class="built_in">this</span>.ctx.arc(<span class="built_in">this</span>.x * scale, <span class="built_in">this</span>.y * scale, <span class="built_in">this</span>.radius * scale, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI, <span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillStyle = <span class="built_in">this</span>.color;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fill();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="增加联机对战模式">增加“联机对战”模式</h2>
<p>为了区分：用户自己，机器人，联机玩家</p>
<p>需要把 <code>is_me</code> 改成字符串，用以表示不同 <strong>Player</strong></p>
<p><strong><code>menu/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGameMenu</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.$single_mode.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            outer.hide();</span><br><span class="line">            outer.root.playground.show(<span class="string">&quot;single mode&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">this</span>.$multi_mode.click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.hide();</span><br><span class="line">            outer.root.playground.show(<span class="string">&quot;multi mode&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Playground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params">mode</span>)</span> &#123;    <span class="comment">//打开 playground 界面</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span> / <span class="built_in">this</span>.scale, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="string">&quot;white&quot;</span>, <span class="number">0.15</span>, <span class="string">&quot;me&quot;</span>, <span class="built_in">this</span>.root.settings.username, <span class="built_in">this</span>.root.settings.photo)));</span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="string">&quot;single mode&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++ ) &#123;</span><br><span class="line">                <span class="built_in">this</span>.players.push(<span class="keyword">new</span> Player(<span class="built_in">this</span>, <span class="built_in">this</span>.width / <span class="number">2</span> / <span class="built_in">this</span>.scale, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="built_in">this</span>.get_random_color(), <span class="number">0.15</span>, <span class="string">&quot;robot&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground, x, y, radius, color, speed, character, username, photo</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.character = character;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.photo = photo;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.character !== <span class="string">&quot;robot&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.img = <span class="keyword">new</span> Image();</span><br><span class="line">            <span class="built_in">this</span>.img.src = <span class="built_in">this</span>.photo;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//同理，根据对应的逻辑，修改后面所有的 is_me 为 character</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="配置django_channels">配置django_channels</h2>
<p><strong>django_channels</strong> 就是基于 <strong>wss</strong> 协议的一种实现</p>
<p><strong>wss</strong> 是 <strong>web-socker</strong> 协议的安全模式，支持 <strong>C/S</strong> 下的双向通信（HTTP协议只支持单向通信）</p>
<h3 id="安装-channels_redis">安装 <code>channels_redis</code></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install channels_redis</span><br></pre></td></tr></table></figure>
<h3 id="配置-acappasgi.py">配置 <code>acapp/asgi.py</code></h3>
<p>内容如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> channels.auth <span class="keyword">import</span> AuthMiddlewareStack</span><br><span class="line"><span class="keyword">from</span> channels.routing <span class="keyword">import</span> ProtocolTypeRouter, URLRouter</span><br><span class="line"><span class="keyword">from</span> django.core.asgi <span class="keyword">import</span> get_asgi_application</span><br><span class="line"><span class="keyword">from</span> game.routing <span class="keyword">import</span> websocket_urlpatterns</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="string">&#x27;acapp.settings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">application = ProtocolTypeRouter(&#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: get_asgi_application(),</span><br><span class="line">    <span class="string">&quot;websocket&quot;</span>: AuthMiddlewareStack(URLRouter(websocket_urlpatterns))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="配置-acappsettings.py">配置 <code>acapp/settings.py</code></h3>
<p>在 <code>INSTALLED_APPS</code> 中添加 <code>channels</code> ，添加后如下所示：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [ </span><br><span class="line">    <span class="string">&#x27;channels&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;game.apps.GameConfig&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>然后在文件末尾添加：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ASGI_APPLICATION = <span class="string">&#x27;acapp.asgi.application&#x27;</span></span><br><span class="line">CHANNEL_LAYERS = &#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;channels_redis.core.RedisChannelLayer&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CONFIG&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;hosts&quot;</span>: [(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>)],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置-gamerouting.py">配置 <code>game/routing.py</code></h3>
<p>这一部分的作用相当于 <code>http</code> 的 <code>urls</code></p>
<p>内容如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">websocket_urlpatterns = [</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="编写-gameconsumers">编写 <code>game/consumers</code></h3>
<p>这一部分的作用相当于 <code>http</code> 的 <code>views</code></p>
<p>参考示例：</p>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> channels.generic.websocket <span class="keyword">import</span> AsyncWebsocketConsumer</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayer</span>(<span class="params">AsyncWebsocketConsumer</span>):</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">await</span> self.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;accept&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.room_name = <span class="string">&quot;room&quot;</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_add(self.room_name, self.channel_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">disconnect</span>(<span class="params">self, close_code</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span>(<span class="params">self, text_data</span>):</span></span><br><span class="line">        data = json.loads(text_data)</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br></pre></td></tr></table></figure>
<h3 id="启动-django_channels">启动 <code>django_channels</code></h3>
<p>在 <code>~/acapp</code> 目录下执行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daphne -b 0.0.0.0 -p 5015 acapp.asgi:application</span><br></pre></td></tr></table></figure>
<h3 id="建立-wss-连接">建立 WSS 连接</h3>
<h4 id="路由-routing">路由 routing</h4>
<p><strong><code>game/routing.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> game.consumers.multiplayer.index <span class="keyword">import</span> MultiPlayer</span><br><span class="line"></span><br><span class="line">websocket_urlpatterns = [</span><br><span class="line">    path(<span class="string">&quot;wss/multiplayer/&quot;</span>, MultiPlayer.as_asgi(), name=<span class="string">&quot;wss_multiplayer&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="前端js">前端js</h4>
<p><strong><code>playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params">mode</span>)</span> &#123;    <span class="comment">//打开 playground 界面</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="string">&quot;single mode&quot;</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mps = <span class="keyword">new</span> MultiPlayerSocket(<span class="built_in">this</span>);</span><br><span class="line">            <span class="built_in">this</span>.mps.ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                outer.mps.send_create_player();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/socket/multiplayer/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayerSocket</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line">        <span class="built_in">this</span>.ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;wss://app1117.acapp.acwing.com.cn/wss/multiplayer/&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">send_create_player</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;hello acapp server&#x27;</span>,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">receive_create_player</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="编写同步函数">编写同步函数</h2>
<p>一共需要完成四个通信：</p>
<p>（通信的逻辑基本都是现在本地完成，然后将结果返回给服务器，服务器再分发给其他客户端，达成同步）</p>
<ol type="1">
<li><strong>create-player</strong> : 在所有玩家的游戏界面，创建一个新加入的玩家</li>
<li><strong>move-to</strong> : 在所有玩家的游戏界面，讲一个角色移动到一个位置</li>
<li><strong>shoot-fireball</strong> : 在所有玩家的游戏界面，让一个角色发射一个火球</li>
<li><strong>attack</strong> : 在所有玩家的游戏界面，让一个角色被攻击</li>
</ol>
<p>一场游戏里，所有的元素（玩家，火球等）都需要唯一的标识，来方便同步</p>
<p>为此，我们可以直接修改一下游戏引擎，对于每个元素都创建我们需要的唯一标识</p>
<p><strong><code>playground/ac-game-object/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.uuid = <span class="built_in">this</span>.create_uuid();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">create_uuid</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i ++ ) &#123;</span><br><span class="line">            <span class="keyword">let</span> x = <span class="built_in">parseInt</span>(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">10</span>));   <span class="comment">//[0, 10)</span></span><br><span class="line">            res += x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params">mode</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="string">&quot;single mode&quot;</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mps = <span class="keyword">new</span> MultiPlayerSocket(<span class="built_in">this</span>);</span><br><span class="line">            <span class="built_in">this</span>.mps.uuid = <span class="built_in">this</span>.players[<span class="number">0</span>].uuid;</span><br><span class="line">            <span class="built_in">this</span>.mps.ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                outer.mps.send_create_player();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/socket/multiplayer/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayerSocket</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">send_create_player</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;create_player&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.uuid,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着，利用通信的方式，使得每个窗口内，逻辑上相同的元素，其 <code>uid</code> 也相同即可</p>
<p>原则是：哪个窗口创建的元素，就用他创建时的 <code>uid</code> 作为整个项目运行时的 <code>uid</code></p>
<p>然后，我们打算用 <strong>redis</strong> 来实现存储每个游戏房间，以及元素，并初始默认设定每个房间上限 3 人</p>
<h3 id="create-player">create-player</h3>
<h4 id="后端">后端</h4>
<p><strong><code>settings.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ROOM_CAPACITY = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> channels.generic.websocket <span class="keyword">import</span> AsyncWebsocketConsumer</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayer</span>(<span class="params">AsyncWebsocketConsumer</span>):</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.room_name = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):   <span class="comment"># 上限 1k 个房间</span></span><br><span class="line">            name = <span class="string">&quot;room-%d&quot;</span> % (i)</span><br><span class="line">            <span class="comment"># 当前房间为空，或房间内玩家人数不到 ROOM_CAPACITY</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(name) <span class="keyword">or</span> <span class="built_in">len</span>(cache.get(name)) &lt; settings.ROOM_CAPACITY:</span><br><span class="line">                self.room_name = name</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.room_name:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> self.accept()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(self.room_name):   <span class="comment"># 如果房间不存在，则新建房间</span></span><br><span class="line">            cache.<span class="built_in">set</span>(self.room_name, [], <span class="number">3600</span>) <span class="comment"># 有效期 1 小时</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> player <span class="keyword">in</span> cache.get(self.room_name):    <span class="comment"># 对该房间已存在的用户，创建到新加入的用户的游戏界面中</span></span><br><span class="line">            <span class="keyword">await</span> self.send(text_data=json.dumps(&#123;</span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;create_player&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: player[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: player[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;photo&#x27;</span>: player[<span class="string">&#x27;photo&#x27;</span>],</span><br><span class="line">            &#125;))</span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_add(self.room_name, self.channel_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">disconnect</span>(<span class="params">self, close_code</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_player</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        players = cache.get(self.room_name)</span><br><span class="line">        players.append(&#123;</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: data[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;photo&#x27;</span>: data[<span class="string">&#x27;photo&#x27;</span>],</span><br><span class="line">        &#125;)</span><br><span class="line">        cache.<span class="built_in">set</span>(self.room_name, players, <span class="number">3600</span>) <span class="comment"># 更新房间存在时间为 1 小时（最后一次加入一名玩家时）</span></span><br><span class="line">        <span class="comment"># 群发消息更新</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_send(</span><br><span class="line">            self.room_name,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&quot;group_create_player&quot;</span>,  <span class="comment"># 群发该消息后，作为客户端接受者，所接受用的函数名</span></span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;create_player&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: data[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;photo&#x27;</span>: data[<span class="string">&#x27;photo&#x27;</span>],</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">group_create_player</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">await</span> self.send(text_data=json.dumps(data))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span>(<span class="params">self, text_data</span>):</span></span><br><span class="line">        data = json.loads(text_data)</span><br><span class="line">        event = data[<span class="string">&#x27;event&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> event == <span class="string">&quot;create_player&quot;</span>:</span><br><span class="line">            <span class="keyword">await</span> self.create_player(data)</span><br></pre></td></tr></table></figure>
<h4 id="前端">前端</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayerSocket</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;wss://app1117.acapp.acwing.com.cn/wss/multiplayer/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.receive();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">receive</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> data = <span class="built_in">JSON</span>.parse(e.data);</span><br><span class="line">            <span class="keyword">let</span> uuid = data.uuid;</span><br><span class="line">            <span class="keyword">if</span> (uuid === outer.uuid) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> event = data.event;</span><br><span class="line">            <span class="keyword">if</span> (event === <span class="string">&quot;create_player&quot;</span>) &#123;</span><br><span class="line">                outer.receive_create_player(uuid, data.username, data.photo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">send_create_player</span>(<span class="params">username, photo</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;create_player&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.uuid,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">            <span class="string">&#x27;photo&#x27;</span>: photo,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">receive_create_player</span>(<span class="params">uuid, username, photo</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> player = <span class="keyword">new</span> Player(</span><br><span class="line">            <span class="built_in">this</span>.playground,</span><br><span class="line">            <span class="built_in">this</span>.playground.width / <span class="number">2</span> / <span class="built_in">this</span>.playground.scale,</span><br><span class="line">            <span class="number">0.5</span>,</span><br><span class="line">            <span class="number">0.05</span>,</span><br><span class="line">            <span class="string">&quot;white&quot;</span>,</span><br><span class="line">            <span class="number">0.15</span>,</span><br><span class="line">            <span class="string">&quot;enemy&quot;</span>,</span><br><span class="line">            username,</span><br><span class="line">            photo,</span><br><span class="line">        );</span><br><span class="line">        player.uuid = uuid;</span><br><span class="line">        <span class="built_in">this</span>.playground.players.push(player);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="redis-调试语句">redis 调试语句</h4>
<p>打开 shell 交互</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py shell</span><br></pre></td></tr></table></figure>
<p>然后用 py3 交互进行 cache 调试</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear</span>():</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> cache.keys(<span class="string">&#x27;*&#x27;</span>):</span><br><span class="line">        cache.delete(key)</span><br><span class="line"></span><br><span class="line">cache.keys(<span class="string">&#x27;*&#x27;</span>) <span class="comment"># 查询当前 redis 中所有 key</span></span><br><span class="line"></span><br><span class="line">cache.get(<span class="string">&#x27;room-1&#x27;</span>) <span class="comment"># 查询当前 redis 中 key 为 room-1 的值</span></span><br></pre></td></tr></table></figure>
<p>到目前为止，便可以在不同的窗口渲染同一批玩家了</p>
<h3 id="move-to">move-to</h3>
<h4 id="前端-1">前端</h4>
<p>客户端的通信的发出和接受函数</p>
<p><strong><code>js/src/playground/</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayerSocket</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">receive</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (event === <span class="string">&quot;move_to&quot;</span>) &#123;</span><br><span class="line">                outer.receive_move_to(uuid, data.tx, data.ty);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">send_move_to</span>(<span class="params">tx, ty</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;move_to&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.uuid,</span><br><span class="line">            <span class="string">&#x27;tx&#x27;</span>: tx,</span><br><span class="line">            <span class="string">&#x27;ty&#x27;</span>: ty,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">get_player</span>(<span class="params">uuid</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> players = <span class="built_in">this</span>.playground.players;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; players.length; i ++ ) &#123;</span><br><span class="line">            <span class="keyword">let</span> player = players[i];</span><br><span class="line">            <span class="keyword">if</span> (player.uuid === uuid) &#123;</span><br><span class="line">                <span class="keyword">return</span> player;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">receive_move_to</span>(<span class="params">uuid, tx, ty</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> player = <span class="built_in">this</span>.get_player(uuid);</span><br><span class="line">        <span class="keyword">if</span> (player) &#123;</span><br><span class="line">            player.move_to(tx, ty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了让游戏界面中对于要移动的元素做出移动动作，需要对 <code>move_to</code> 函数做出一些修改</p>
<p>首先要标识出当前为多人模式，然后模式为多人模式时，每次移动都会触发一次通信</p>
<p><strong><code>playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params">mode</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.mode = mode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">       <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">           ...</span><br><span class="line">           <span class="keyword">if</span> (e.which === <span class="number">3</span>) &#123;</span><br><span class="line">               <span class="keyword">let</span> tx = (e.clientX - rect.left) / outer.playground.scale;</span><br><span class="line">               <span class="keyword">let</span> ty = (e.clientY - rect.top) / outer.playground.scale;</span><br><span class="line">               outer.move_to(tx, ty);</span><br><span class="line">               <span class="keyword">if</span> (outer.playground.mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">                   outer.playground.mps.send_move_to(tx, ty);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           ...</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="后端-1">后端</h4>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">move_to</span>(<span class="params">self, data</span>):</span></span><br><span class="line">    <span class="keyword">await</span> self.channel_layer.group_send(</span><br><span class="line">        self.room_name,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&quot;group_send_event&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;move_to&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;tx&#x27;</span>: data[<span class="string">&#x27;tx&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;ty&#x27;</span>: data[<span class="string">&#x27;ty&#x27;</span>],</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">group_send_event</span>(<span class="params">self, data</span>):</span></span><br><span class="line">    <span class="keyword">await</span> self.send(text_data=json.dumps(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span>(<span class="params">self, text_data</span>):</span></span><br><span class="line">    data = json.loads(text_data)</span><br><span class="line">    event = data[<span class="string">&#x27;event&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&quot;create_player&quot;</span>:</span><br><span class="line">        <span class="keyword">await</span> self.create_player(data)</span><br><span class="line">    <span class="keyword">elif</span> event == <span class="string">&quot;move_to&quot;</span>:</span><br><span class="line">        <span class="keyword">await</span> self.move_to(data)</span><br></pre></td></tr></table></figure>
<h3 id="shoot-fireball">shoot-fireball</h3>
<h4 id="优化一下火球元素">优化一下火球元素</h4>
<p>用一个数组来存一个玩家发射的所有火球，以便于子弹消失时，将他们找出并对应删掉</p>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground, x, y, radius, color, speed, character, username, photo</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.fireballs = [];    <span class="comment">//存该用户发射的所有火球</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> tx = (e.clientX - rect.left) / outer.playground.scale;</span><br><span class="line">                <span class="keyword">let</span> ty = (e.clientY - rect.top) / outer.playground.scale;</span><br><span class="line">                <span class="keyword">if</span> (outer.cur_skill === <span class="string">&quot;fireball&quot;</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> fireball = outer.shoot_fireball(tx, ty);</span><br><span class="line">                    <span class="keyword">if</span> (outer.playground.mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">                        outer.playground.mps.send_shoot_fireball(tx, ty, fireball.uuid);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line">        $(<span class="built_in">window</span>).keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (e.which === <span class="number">81</span>) &#123;           <span class="comment">//键盘按下q事件</span></span><br><span class="line">                outer.cur_skill = <span class="string">&quot;fireball&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">shoot_fireball</span>(<span class="params">tx, ty</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> fireball = <span class="keyword">new</span> FireBall(<span class="built_in">this</span>.playground, <span class="built_in">this</span>, x, y, radius, vx, vy, color, speed, move_length, damage);</span><br><span class="line">        <span class="built_in">this</span>.fireballs.push(fireball);</span><br><span class="line">        <span class="keyword">return</span> fireball;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">destroy_fireball</span>(<span class="params">uuid</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.fireballs.length; i ++ ) &#123;</span><br><span class="line">            <span class="keyword">let</span> fireball = <span class="built_in">this</span>.fireballs[i];</span><br><span class="line">            <span class="keyword">if</span> (fireball.uuid == uuid) &#123;</span><br><span class="line">                fireball.destroy();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/skill/fireball/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FireBall</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">on_destory</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fireballs = <span class="built_in">this</span>.player.fireballs;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; fireballs.length; i ++ ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fireballs[i] === <span class="built_in">this</span>) &#123;</span><br><span class="line">                fireballs.splice(i, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/playground/socket/multiplayer/</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayerSocket</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">send_shoot_fireball</span>(<span class="params">tx, ty, ball_uuid</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;move_to&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.uuid,</span><br><span class="line">            <span class="string">&#x27;tx&#x27;</span>: tx,</span><br><span class="line">            <span class="string">&#x27;ty&#x27;</span>: ty,</span><br><span class="line">            <span class="string">&#x27;ball_uuid&#x27;</span>: ball_uuid;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">receive_shoot_fireball</span>(<span class="params">uuid, tx, ty, ball_uuid</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> player = <span class="built_in">this</span>.get_player(uuid);</span><br><span class="line">        <span class="keyword">if</span> (player) &#123;</span><br><span class="line">            <span class="keyword">let</span> fireball = player.shoot_fireball(tx, ty);</span><br><span class="line">            fireball.uuid = ball_uuid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="后端-2">后端</h4>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayer</span>(<span class="params">AsyncWebsocketConsumer</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">shoot_fireball</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_send(</span><br><span class="line">            self.room_name,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&quot;group_send_event&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;shoot_fireball&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;tx&#x27;</span>: data[<span class="string">&#x27;tx&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;ty&#x27;</span>: data[<span class="string">&#x27;ty&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;ball_uuid&#x27;</span>: data[<span class="string">&#x27;ball_uuid&#x27;</span>],</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span>(<span class="params">self, text_data</span>):</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">elif</span> event == <span class="string">&quot;shoot_fireball&quot;</span>:</span><br><span class="line">            <span class="keyword">await</span> self.shoot_fireball(data)</span><br></pre></td></tr></table></figure>
<h3 id="attack">attack</h3>
<p>为了只让一个客户端进行攻击命中的判断，因此只有发出方的火球才做碰撞检测</p>
<p>其他客户端对于该火球只有动画效果</p>
<p>又由于碰撞检测是在一台客户端上进行的，因此多端之间可能会存在同步上的延迟</p>
<p>为此的解决方法是：碰撞检测成功时，强制把被击中玩家移动到发起方客户端中的位置，以避免击中延迟上发生的事情</p>
<h4 id="前端-2">前端</h4>
<p><strong><code>playground/skill/fireball/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FireBall</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.move_length &lt; <span class="built_in">this</span>.eps) &#123;</span><br><span class="line">            <span class="built_in">this</span>.destroy();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.update_move();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.player.character !== <span class="string">&quot;enemy&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.update_attack();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">attack</span>(<span class="params">player</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.playground.mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.playground.mps.send_attack(player.uuid, player.x, player.y, angle, <span class="built_in">this</span>.damage, <span class="built_in">this</span>.uuid);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">receive_attack</span>(<span class="params">x, y, angle, damage, ball_uuid, attacker</span>)</span> &#123;</span><br><span class="line">        attacker.destroy_fireball(ball_uuid);</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">        <span class="built_in">this</span>.is_attacked(angle, damage);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/playground/socket/multiplayer/</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayerSocket</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">send_attack</span>(<span class="params">attackee_uuid, x, y, angle, damage, ball_uuid</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;attack&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.uuid,</span><br><span class="line">            <span class="string">&#x27;attackee_uuid&#x27;</span>: attackee_uuid,</span><br><span class="line">            <span class="string">&#x27;x&#x27;</span>: x,</span><br><span class="line">            <span class="string">&#x27;y&#x27;</span>: y,</span><br><span class="line">            <span class="string">&#x27;angle&#x27;</span>: angle,</span><br><span class="line">            <span class="string">&#x27;damage&#x27;</span>: damage,</span><br><span class="line">            <span class="string">&#x27;ball_uuid&#x27;</span>: ball_uuid,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">receive_attack</span>(<span class="params">uuid, attackee_uuid, x, y, angle, damage, ball_uuid</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> attacker = <span class="built_in">this</span>.get_player(uuid);</span><br><span class="line">        <span class="keyword">let</span> attackee = <span class="built_in">this</span>.get_player(attackee_uuid);</span><br><span class="line">        <span class="keyword">if</span> (attacker &amp;&amp; attackee) &#123;</span><br><span class="line">            attackee.receive_attack(x, y, angle, damage, ball_uuid, attacker);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="后端-3">后端</h4>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayer</span>(<span class="params">AsyncWebsocketConsumer</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">attack</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_send(</span><br><span class="line">            self.room_name,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&quot;group_send_event&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;attack&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;x&#x27;</span>: data[<span class="string">&#x27;x&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;y&#x27;</span>: data[<span class="string">&#x27;y&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;angle&#x27;</span>: data[<span class="string">&#x27;angle&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;damage&#x27;</span>: data[<span class="string">&#x27;damage&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;ball_uuid&#x27;</span>: data[<span class="string">&#x27;ball_uuid&#x27;</span>],</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h2 id="游戏的小优化">游戏的小优化</h2>
<h3 id="多人模式下游戏没有开始前玩家不可以移动">多人模式下游戏没有开始前，玩家不可以移动</h3>
<p>为此我们先引入一个状态机：<code>'waiting' -&gt; 'fighting' -&gt; 'over'</code> 来标识当前游戏进行的状态</p>
<p>然后用一个 <code>notice_board</code> 计分板在前端显示出来</p>
<p>实现的逻辑就是：游戏初始时为 <code>waiting</code> 状态，房间内人数满 3 人时，才会进入 <code>fighting</code>，角色死亡时为 <code>over</code></p>
<p>且发射火球，移动等行为，当且仅当玩家状态为 <code>fighting</code> 时，才可以做</p>
<p>然后设定火球技能的 cd 为 3 秒，且在游戏进入 <code>fighting</code> 时，先自动进入 cd 状态</p>
<p>这样就实现了初始 3 秒内，任何玩家不可攻击</p>
<p><strong><code>js/src/playground/notice_board/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoticeBoard</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line">        <span class="built_in">this</span>.ctx = <span class="built_in">this</span>.playground.game_map.ctx;</span><br><span class="line">        <span class="built_in">this</span>.text = <span class="string">&quot;已就绪：0人&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">write</span>(<span class="params">text</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.text = text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx.font = <span class="string">&quot;20px serif&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillStyle = <span class="string">&quot;white&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.ctx.textAlign = <span class="string">&quot;center&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.ctx.fillText(<span class="built_in">this</span>.text, <span class="built_in">this</span>.playground.width / <span class="number">2</span>, <span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params">mode</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.state = <span class="string">&quot;waiting&quot;</span>;     <span class="comment">//waiting -&gt; fighting -&gt; over</span></span><br><span class="line">        <span class="built_in">this</span>.notice_board = <span class="keyword">new</span> NoticeBoard(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.player_count = <span class="number">0</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (outer.playground.state !== <span class="string">&quot;fighting&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        $(<span class="built_in">window</span>).keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (outer.playground.state !== <span class="string">&quot;fighting&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.playground.player_count ++ ;</span><br><span class="line">        <span class="built_in">this</span>.playground.notice_board.write(<span class="string">&quot;已就绪：&quot;</span> + <span class="built_in">this</span>.playground.player_count + <span class="string">&quot;人&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.playground.player_count &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.playground.state = <span class="string">&quot;fighting&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.playground.notice_board.write(<span class="string">&quot;Fighting&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="技能cd">技能CD</h3>
<p>给火球技能设置 3s 的 cd，实现逻辑很简单，设定一个 cool_time 变量，每次渲染的时候减去上次渲染的时间间隔</p>
<p>然后 cool_time 为 0 时，技能才可以成功释放</p>
<p>另外修改冷却时间，只用修改自己的即可</p>
<p><strong><code>js/src/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">...</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.character === <span class="string">&quot;me&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.fireball_coldtime = <span class="number">3</span>; <span class="comment">// 单位：s</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">1</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (outer.cur_skill === <span class="string">&quot;fireball&quot;</span>) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">if</span> (outer.playground.mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">                        outer.playground.mps.send_shoot_fireball(tx, ty, fireball.uuid);</span><br><span class="line">                    &#125;</span><br><span class="line">                    outer.fireball_coldtime = <span class="number">3</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line">        $(<span class="built_in">window</span>).keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (outer.fireball_coldtime &gt;= outer.eps)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.character === <span class="string">&quot;me&quot;</span> &amp;&amp; <span class="built_in">this</span>.playground.state === <span class="string">&quot;fighting&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.update_coldtime();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update_coldtime</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fireball_coldtime -= <span class="built_in">this</span>.timedelta / <span class="number">1000</span>;</span><br><span class="line">        <span class="built_in">this</span>.fireball_coldtime = <span class="built_in">Math</span>.max(<span class="number">0</span>, <span class="built_in">this</span>.fireball_coldtime);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="用图片来渲染技能cd">用图片来渲染技能CD</h3>
<p><strong><code>js/src/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">...</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.character === <span class="string">&quot;me&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.fireball_coldtime = <span class="number">3</span>; <span class="comment">// 单位：s</span></span><br><span class="line">            <span class="built_in">this</span>.fireball_img = <span class="keyword">new</span> Image();</span><br><span class="line">            <span class="built_in">this</span>.fireball_img.src = <span class="string">&quot;https://cdn.acwing.com/media/article/image/2021/12/02/1_9340c86053-fireball.png&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.character === <span class="string">&quot;me&quot;</span> &amp;&amp; <span class="built_in">this</span>.playground.state === <span class="string">&quot;fighting&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.render_skill_coldtime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="function"><span class="title">render_skill_coldtime</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> scale = <span class="built_in">this</span>.playground.scale;</span><br><span class="line">        <span class="keyword">let</span> x = <span class="number">1.5</span>, y = <span class="number">0.9</span>, r = <span class="number">0.04</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 渲染技能图标</span></span><br><span class="line">        <span class="built_in">this</span>.ctx.save();</span><br><span class="line">        <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">        <span class="built_in">this</span>.ctx.arc(x * scale, y * scale, r * scale, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.ctx.stroke();</span><br><span class="line">        <span class="built_in">this</span>.ctx.clip();</span><br><span class="line">        <span class="built_in">this</span>.ctx.drawImage(<span class="built_in">this</span>.fireball_img, (x - r) * scale, (y - r) * scale, r * <span class="number">2</span> * scale, r * <span class="number">2</span> * scale);</span><br><span class="line">        <span class="built_in">this</span>.ctx.restore();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 渲染冷却指示</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.fireball_coldtime &gt;= <span class="built_in">this</span>.eps)&#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">            <span class="built_in">this</span>.ctx.moveTo(x * scale, y * scale);</span><br><span class="line">            <span class="built_in">this</span>.ctx.arc(x * scale, y * scale, r * scale, <span class="number">0</span> - <span class="built_in">Math</span>.PI / <span class="number">2</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span> * (<span class="number">1</span> - <span class="built_in">this</span>.fireball_coldtime / <span class="number">3</span>) - <span class="built_in">Math</span>.PI / <span class="number">2</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="built_in">this</span>.ctx.lineTo(x * scale, y * scale);</span><br><span class="line">            <span class="built_in">this</span>.ctx.fillStyle = <span class="string">&quot;rgba(0, 0, 255, 0.6)&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.ctx.fill();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h3 id="添加一个闪现技能">添加一个闪现技能</h3>
<h4 id="单机部分">单机部分</h4>
<p><strong><code>js/src/playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">...</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.character === <span class="string">&quot;me&quot;</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="built_in">this</span>.blink_coldtime = <span class="number">5</span>;</span><br><span class="line">            <span class="built_in">this</span>.blink_img = <span class="keyword">new</span> Image();</span><br><span class="line">            <span class="built_in">this</span>.blink_img.src = <span class="string">&quot;https://cdn.acwing.com/media/article/image/2021/12/02/1_daccabdc53-blink.png&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.playground.game_map.$canvas.mousedown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">1</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (outer.cur_skill === <span class="string">&quot;blink&quot;</span>) &#123;</span><br><span class="line">                    outer.blink(tx, ty);</span><br><span class="line">                    <span class="comment">// 同步函数</span></span><br><span class="line">                    <span class="keyword">if</span> (outer.playground.mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">                        outer.playground.mps.send_blink(tx, ty);</span><br><span class="line">                    &#125;</span><br><span class="line">                    outer.blink_coldtime = <span class="number">5</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            outer.cur_skill = <span class="literal">null</span>; <span class="comment">//清空当前技能</span></span><br><span class="line">        &#125;);</span><br><span class="line">        $(<span class="built_in">window</span>).keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">70</span>) &#123;    <span class="comment">//f键</span></span><br><span class="line">                <span class="keyword">if</span> (outer.blink_coldtime &gt;= outer.eps) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                outer.cur_skill = <span class="string">&quot;blink&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">blink</span>(<span class="params">tx, ty</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> d = <span class="built_in">this</span>.get_dist(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, tx, ty);</span><br><span class="line">        d = <span class="built_in">Math</span>.min(d, <span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">let</span> angle = <span class="built_in">Math</span>.atan2(ty - <span class="built_in">this</span>.y, tx - <span class="built_in">this</span>.x);</span><br><span class="line">        <span class="built_in">this</span>.x += d * <span class="built_in">Math</span>.cos(angle);</span><br><span class="line">        <span class="built_in">this</span>.y += d * <span class="built_in">Math</span>.sin(angle);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.move_length = <span class="number">0</span>;   <span class="comment">//闪现完停下来</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">render_skill_coldtime</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        x = <span class="number">1.62</span>, y = <span class="number">0.9</span>, r = <span class="number">0.04</span>;</span><br><span class="line">        <span class="comment">// 闪现技能</span></span><br><span class="line">        <span class="comment">// 渲染技能图标</span></span><br><span class="line">        <span class="built_in">this</span>.ctx.save();</span><br><span class="line">        <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">        <span class="built_in">this</span>.ctx.arc(x * scale, y * scale, r * scale, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.ctx.stroke();</span><br><span class="line">        <span class="built_in">this</span>.ctx.clip();</span><br><span class="line">        <span class="built_in">this</span>.ctx.drawImage(<span class="built_in">this</span>.blink_img, (x - r) * scale, (y - r) * scale, r * <span class="number">2</span> * scale, r * <span class="number">2</span> * scale);</span><br><span class="line">        <span class="built_in">this</span>.ctx.restore();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 渲染冷却指示</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.blink_coldtime &gt;= <span class="built_in">this</span>.eps)&#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">            <span class="built_in">this</span>.ctx.moveTo(x * scale, y * scale);</span><br><span class="line">            <span class="built_in">this</span>.ctx.arc(x * scale, y * scale, r * scale, <span class="number">0</span> - <span class="built_in">Math</span>.PI / <span class="number">2</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span> * (<span class="number">1</span> - <span class="built_in">this</span>.blink_coldtime / <span class="number">5</span>) - <span class="built_in">Math</span>.PI / <span class="number">2</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="built_in">this</span>.ctx.lineTo(x * scale, y * scale);</span><br><span class="line">            <span class="built_in">this</span>.ctx.fillStyle = <span class="string">&quot;rgba(0, 0, 255, 0.6)&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.ctx.fill();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="联机部分">联机部分</h4>
<p><strong><code>js/src/playground/socket/multiplayer/</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayerSocket</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">send_blink</span>(<span class="params">tx, ty</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;blink&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.uuid,</span><br><span class="line">            <span class="string">&#x27;tx&#x27;</span>: tx,</span><br><span class="line">            <span class="string">&#x27;ty&#x27;</span>: ty,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">receive_blink</span>(<span class="params">uuid, tx, ty</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> player = <span class="built_in">this</span>.get_player(uuid);</span><br><span class="line">        <span class="keyword">if</span> (player) &#123;</span><br><span class="line">            player.blink(tx, ty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayer</span>(<span class="params">AsyncWebsocketConsumer</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">blink</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_send(</span><br><span class="line">            self.room_name,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&quot;group_send_event&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;blink&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;tx&#x27;</span>: data[<span class="string">&#x27;tx&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;ty&#x27;</span>: data[<span class="string">&#x27;ty&#x27;</span>],</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>大功告成 =w=</p>
<h1 id="实现聊天系统-ஐ">实现聊天系统 ஐ</h1>
<h2 id="优化键盘绑定事件">优化键盘绑定事件</h2>
<p>这部分算是之前的遗留问题，先前的 <code>keydown</code> 监听事件绑定在了 <code>window</code> 上会出现一个问题</p>
<p>如果在一个浏览器内打开多个 ACAPP，此时按下键位触发 <code>keydown</code> 事件，会被浏览器内所有的 <code>ACAPP</code> 都捕获到</p>
<p>之前影响不大，但对此次要实现的聊天系统就有着致命的影响，即打开一个 ACAPP 的聊天栏，其他都会被打开</p>
<p>所有我们要将 <code>keydown</code> 监听事件绑定到 <code>canvas</code> 上</p>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.playground.game_map.$canvas.keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (outer.playground.state !== <span class="string">&quot;fighting&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (e.which === <span class="number">81</span>) &#123;           <span class="comment">//键盘按下q事件</span></span><br><span class="line">                <span class="keyword">if</span> (outer.fireball_coldtime &gt;= outer.eps) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                outer.cur_skill = <span class="string">&quot;fireball&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">70</span>) &#123;    <span class="comment">//f键</span></span><br><span class="line">                <span class="keyword">if</span> (outer.blink_coldtime &gt;= outer.eps) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                outer.cur_skill = <span class="string">&quot;blink&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/game-map/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameMap</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground</span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.$canvas = $(<span class="string">`&lt;canvas tabindex=0&gt;&lt;/canvas&gt;`</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$canvas.focus();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="本地前端">本地前端</h2>
<p>要实现两个部分： 1. 文本输入框（让用户输入要发送的信息） 2. 历史记录显示框（之前用户发送的信息的显示框）</p>
<p>欲实现逻辑：用户按下 <code>&lt;Enter&gt;</code> 后，游戏界面弹出文本输入框，然后聚焦于文本输入框，且同时弹出历史记录显示框 3 秒</p>
<p>然后用户输入信息后，按下 <code>&lt;Enter&gt;</code> 后发出信息，接着信息会显示在历史记录显示框最下方，并弹出历史记录显示框 3 秒</p>
<p><strong><code>playground/chat_field/zbase.js</code></strong></p>
<p>chat field 负责管理 文本输入框 和 历史记录显示框</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatField</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.$history = $(<span class="string">`&lt;div class=&quot;ac-game-chat-field-history&quot;&gt;&lt;/div&gt;`</span>);</span><br><span class="line">        <span class="built_in">this</span>.$input = $(<span class="string">`&lt;input type=&quot;text&quot; class=&quot;ac-game-chat-field-input&quot;&gt;`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.$history.hide();</span><br><span class="line">        <span class="built_in">this</span>.$input.hide();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.func_id = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.playground.$playground.append(<span class="built_in">this</span>.$history);</span><br><span class="line">        <span class="built_in">this</span>.playground.$playground.append(<span class="built_in">this</span>.$input);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.add_listening_events();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.$input.keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (e.which === <span class="number">27</span>) &#123;   <span class="comment">//ESC</span></span><br><span class="line">                outer.hide_input();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">13</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> username = outer.playground.root.settings.username;</span><br><span class="line">                <span class="keyword">let</span> text = outer.$input.val();</span><br><span class="line">                <span class="keyword">if</span> (text) &#123;</span><br><span class="line">                    outer.$input.val(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                    outer.add_message(username, text);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">show_history</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.$history.fadeIn();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.func_id) <span class="built_in">clearTimeout</span>(<span class="built_in">this</span>.func_id);</span><br><span class="line">        <span class="built_in">this</span>.func_id = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.$history.fadeOut();</span><br><span class="line">            outer.func_id = <span class="literal">null</span>;</span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render_message</span>(<span class="params">message</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> $(<span class="string">`&lt;div&gt;<span class="subst">$&#123;message&#125;</span>&lt;/div&gt;`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">add_message</span>(<span class="params">username, text</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.show_history();</span><br><span class="line">        <span class="keyword">let</span> message = <span class="string">`[<span class="subst">$&#123;username&#125;</span>] <span class="subst">$&#123;text&#125;</span>`</span>;</span><br><span class="line">        <span class="built_in">this</span>.$history.append(<span class="built_in">this</span>.render_message(message));</span><br><span class="line">        <span class="built_in">this</span>.$history.scrollTop(<span class="built_in">this</span>.$history[<span class="number">0</span>].scrollHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">show_input</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.show_history();</span><br><span class="line">        <span class="built_in">this</span>.$input.show();</span><br><span class="line">        <span class="built_in">this</span>.$input.focus();    <span class="comment">//输入时，聚焦于输入框</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">hide_input</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$input.hide();</span><br><span class="line">        <span class="built_in">this</span>.playground.game_map.$canvas.focus();   <span class="comment">//退出时，聚焦回游戏界面</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/zbase.js</code></strong></p>
<p>把它创建出来</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params">mode</span>)</span> &#123;    <span class="comment">//打开 playground 界面</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.chat_field = <span class="keyword">new</span> ChatField(<span class="built_in">this</span>);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<p>添加监听事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.playground.game_map.$canvas.keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (e.which === <span class="number">13</span>) &#123;   <span class="comment">// enter (显示对话框)</span></span><br><span class="line">                <span class="keyword">if</span> (outer.playground.mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">                    outer.playground.chat_field.show_input();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">27</span>) &#123;    <span class="comment">//esc（关闭对话框）</span></span><br><span class="line">                <span class="keyword">if</span> (outer.playground.mode === <span class="string">&quot;multi mode&quot;</span>) &#123;</span><br><span class="line">                    outer.playground.char_field.hide_input();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>game.css</code></strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="selector-class">.ac-game-chat-field-history</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">66%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">20%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">32%</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">2vh</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-chat-field-history</span>::-webkit-scrollbar &#123;</span><br><span class="line">    width: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.ac-game-chat-field-input</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">86%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">20%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">3vh</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">2vh</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">222</span>,<span class="number">225</span>,<span class="number">230</span>, <span class="number">0.2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="联机聊天窗">联机聊天窗</h2>
<p>经过前几节课的洗礼，这个就很简单了，不需要看视频相信也可以独立完成</p>
<h3 id="前端-3">前端</h3>
<p><strong><code>playground/chat_field/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatField</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.$input.keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e.which === <span class="number">13</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (text) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    outer.playground.mps.send_message(text);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>js/src/playground/socket/multiplayer/</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayerSocket</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">send_message</span>(<span class="params">text</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;message&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.uuid,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: outer.playground.root.settings.username,</span><br><span class="line">            <span class="string">&#x27;text&#x27;</span>: text,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">receive_message</span>(<span class="params">username, text</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.playground.chat_field.add_message(username, text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="后端-4">后端</h3>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayer</span>(<span class="params">AsyncWebsocketConsumer</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">message</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_send(</span><br><span class="line">            self.room_name,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&quot;group_send_event&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;message&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: data[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;text&#x27;</span>: data[<span class="string">&#x27;text&#x27;</span>],</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h1 id="实现匹配系统-ஐ">实现匹配系统 ஐ</h1>
<p>本章节内容是利用 thrift 创建客户端-服务端交互的接口</p>
<p>然后利用该接口完成一个匹配系统</p>
<p>匹配系统由一个消息队列 + 生产者-消费者模型 + 匹配池 完成</p>
<p>基本与 Linux基础课 里的部分完全一致，因此不会做过多笔记和阐述</p>
<p>当时我们是拿 cpp 来写的，写了差不多 200 行，整整就是一个大模拟题啊 hh</p>
<p>本节会拿 py 来实现，差不多 140 行即可</p>
<p><strong><code>thrift</code> 接口文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">namespace py match_service</span><br><span class="line"></span><br><span class="line">service Match &#123;</span><br><span class="line">    i32 add_player(1: i32 score, 2: string uuid, 3: string username, 4: string photo, 5: string channel_name),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后用该源文件生成接口文件，不再做过多阐述</p>
<h2 id="服务端">服务端</h2>
<p>配置 <code>asgi.py</code> 让服务端进程可以调用客户端进程里的函数</p>
<p><strong><code>acapp/acapp/asgi.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="string">&#x27;acapp.settings&#x27;</span>)</span><br><span class="line">django.setup()</span><br><span class="line">...</span><br><span class="line"><span class="keyword">from</span> channels.layers <span class="keyword">import</span> get_channel_layer</span><br><span class="line">channel_layer = get_channel_layer()</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong><code>acapp/match_system/src/main.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.insert(<span class="number">0</span>, glob.glob(<span class="string">&#x27;../../&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> match_server.match_service <span class="keyword">import</span> Match</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</span><br><span class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</span><br><span class="line"><span class="keyword">from</span> thrift.server <span class="keyword">import</span> TServer</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> acapp.asgi <span class="keyword">import</span> channel_layer</span><br><span class="line"><span class="keyword">from</span> asgiref.sync <span class="keyword">import</span> async_to_sync</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line">queue = Queue()  <span class="comment"># 消息队列</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, score, uuid, username, photo, channel_name</span>):</span></span><br><span class="line">        self.score = score</span><br><span class="line">        self.uuid = uuid</span><br><span class="line">        self.username = username</span><br><span class="line">        self.photo = photo</span><br><span class="line">        self.channel_name = channel_name</span><br><span class="line">        self.waiting_time = <span class="number">0</span>  <span class="comment"># 等待时间</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pool</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.players = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_player</span>(<span class="params">self, player</span>):</span></span><br><span class="line">        self.players.append(player)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_match</span>(<span class="params">self, a, b</span>):</span></span><br><span class="line">        dt = <span class="built_in">abs</span>(a.score - b.score)</span><br><span class="line">        a_max_dif = a.waiting_time * <span class="number">50</span></span><br><span class="line">        b_max_dif = b.waiting_time * <span class="number">50</span></span><br><span class="line">        <span class="keyword">return</span> dt &lt;= a_max_dif <span class="keyword">and</span> dt &lt;= b_max_dif</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match_success</span>(<span class="params">self, ps</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Match Success: %s %s %s&quot;</span> % (ps[<span class="number">0</span>].username, ps[<span class="number">1</span>].username, ps[<span class="number">2</span>].username))</span><br><span class="line">        room_name = <span class="string">&quot;room-%s-%s-%s&quot;</span> % (ps[<span class="number">0</span>].uuid, ps[<span class="number">1</span>].uuid, ps[<span class="number">2</span>].uuid)</span><br><span class="line">        players = []</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> ps:</span><br><span class="line">            async_to_sync(channel_layer.group_add)(room_name, p.channel_name)</span><br><span class="line">            players.append(&#123;</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: p.uuid,</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: p.username,</span><br><span class="line">                <span class="string">&#x27;photo&#x27;</span>: p.photo,</span><br><span class="line">                <span class="string">&#x27;hp&#x27;</span>: <span class="number">100</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">        cache.<span class="built_in">set</span>(room_name, players, <span class="number">3600</span>)  <span class="comment"># 有效时间：1小时</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> ps:</span><br><span class="line">            async_to_sync(channel_layer.group_send)(</span><br><span class="line">                room_name,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&quot;group_send_event&quot;</span>,</span><br><span class="line">                    <span class="string">&#x27;event&#x27;</span>: <span class="string">&quot;create_player&quot;</span>,</span><br><span class="line">                    <span class="string">&#x27;uuid&#x27;</span>: p.uuid,</span><br><span class="line">                    <span class="string">&#x27;username&#x27;</span>: p.username,</span><br><span class="line">                    <span class="string">&#x27;photo&#x27;</span>: p.photo,</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">increase_waiting_time</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> player <span class="keyword">in</span> self.players:</span><br><span class="line">            player.waiting_time += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(self.players) &gt;= <span class="number">3</span>:</span><br><span class="line">            self.players = <span class="built_in">sorted</span>(self.players, key=<span class="keyword">lambda</span> p: p.score)</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.players) - <span class="number">2</span>):</span><br><span class="line">                a, b, c = self.players[i], self.players[i + <span class="number">1</span>], self.players[i + <span class="number">2</span>]</span><br><span class="line">                <span class="keyword">if</span> self.check_match(a, b) <span class="keyword">and</span> self.check_match(a, c) <span class="keyword">and</span> self.check_match(b, c):</span><br><span class="line">                    self.match_success([a, b, c])</span><br><span class="line">                    self.players = self.players[:i] + self.players[i + <span class="number">3</span>:]</span><br><span class="line">                    flag = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        self.increase_waiting_time()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MatchHandler</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_player</span>(<span class="params">self, score, uuid, username, photo, channel_name</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Add Player: %s %d&quot;</span> % (username, score))</span><br><span class="line">        player = Player(score, uuid, username, photo, channel_name)</span><br><span class="line">        queue.put(player)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_player_from_queue</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> queue.get_nowait()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span>():</span></span><br><span class="line">    pool = Pool()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        player = get_player_from_queue()</span><br><span class="line">        <span class="keyword">if</span> player:</span><br><span class="line">            pool.add_player(player)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pool.match()</span><br><span class="line">            sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    handler = MatchHandler()</span><br><span class="line">    processor = Match.Processor(handler)</span><br><span class="line">    transport = TSocket.TServerSocket(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">9090</span>)</span><br><span class="line">    tfactory = TTransport.TBufferedTransportFactory()</span><br><span class="line">    pfactory = TBinaryProtocol.TBinaryProtocolFactory()</span><br><span class="line"></span><br><span class="line">    server = TServer.TThreadedServer(</span><br><span class="line">        processor, transport, tfactory, pfactory)</span><br><span class="line"></span><br><span class="line">    Thread(target=worker, daemon=<span class="literal">True</span>).start()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Starting the server...&#x27;</span>)</span><br><span class="line">    server.serve()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done.&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="客户端">客户端</h2>
<p>扩展数据库表，让其可以存放 rank分 的信息</p>
<p><strong><code>game/models/player/player.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    score = models.IntegerField(default=<span class="number">1500</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> channels.generic.websocket <span class="keyword">import</span> AsyncWebsocketConsumer</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> thrift <span class="keyword">import</span> Thrift</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</span><br><span class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> match_system.src.match_server.match_service <span class="keyword">import</span> Match</span><br><span class="line"><span class="keyword">from</span> game.models.player.player <span class="keyword">import</span> Player</span><br><span class="line"><span class="keyword">from</span> channels.db <span class="keyword">import</span> database_sync_to_async</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayer</span>(<span class="params">AsyncWebsocketConsumer</span>):</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">await</span> self.accept()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">disconnect</span>(<span class="params">self, close_code</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.room_name:</span><br><span class="line">            <span class="keyword">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_player</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        self.room_name = <span class="literal">None</span></span><br><span class="line">        self.uuid = data[<span class="string">&#x27;uuid&#x27;</span>]</span><br><span class="line">        <span class="comment"># Make socket</span></span><br><span class="line">        transport = TSocket.TSocket(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9090</span>)</span><br><span class="line">        <span class="comment"># Buffering is critical. Raw sockets are very slow</span></span><br><span class="line">        transport = TTransport.TBufferedTransport(transport)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Wrap in a protocol</span></span><br><span class="line">        protocol = TBinaryProtocol.TBinaryProtocol(transport)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create a client to use the protocol encoder</span></span><br><span class="line">        client = Match.Client(protocol)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">db_get_player</span>():</span></span><br><span class="line">            <span class="keyword">return</span> Player.objects.get(user__username=data[<span class="string">&#x27;username&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        player = <span class="keyword">await</span> database_sync_to_async(db_get_player)()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Connect!</span></span><br><span class="line">        transport.<span class="built_in">open</span>()</span><br><span class="line"></span><br><span class="line">        client.add_player(player.score, data[<span class="string">&#x27;uuid&#x27;</span>], data[<span class="string">&#x27;username&#x27;</span>], data[<span class="string">&#x27;photo&#x27;</span>], self.channel_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Close!</span></span><br><span class="line">        transport.close()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">group_send_event</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.room_name:</span><br><span class="line">            keys = cache.keys(<span class="string">&#x27;*%s*&#x27;</span> % (self.uuid))</span><br><span class="line">            <span class="keyword">if</span> keys:</span><br><span class="line">                self.room_name = keys[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">await</span> self.send(text_data=json.dumps(data))</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h1 id="项目收尾-ஐ">项目收尾 ஐ</h1>
<h2 id="加密压缩js代码">加密、压缩js代码</h2>
<p>安装 <code>terser</code> :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install npm</span><br><span class="line">sudo npm install terser -g</span><br></pre></td></tr></table></figure>
<p><code>terser</code> 不仅支持文件输入，也支持标准输入。结果会输出到标准输出中。</p>
<p>使用方式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terser xxx.js -c -m</span><br></pre></td></tr></table></figure>
<p>我们将整合 <code>js</code> 文件的脚本修改一下即可：</p>
<p><strong><code>scripts/compress_game_js.sh</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line">JS_PATH=/home/acs/acapp/game/static/js/</span><br><span class="line">JS_PATH_DIST=<span class="variable">$&#123;JS_PATH&#125;</span>dist/</span><br><span class="line">JS_PATH_SRC=<span class="variable">$&#123;JS_PATH&#125;</span>src/</span><br><span class="line"></span><br><span class="line">find <span class="variable">$JS_PATH_SRC</span> -<span class="built_in">type</span> f -name <span class="string">&#x27;*.js&#x27;</span> | sort | xargs cat | terser -c -m &gt; <span class="variable">$&#123;JS_PATH_DIST&#125;</span>game.js</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;yes&quot;</span> | python3 manage.py collectstatic</span><br></pre></td></tr></table></figure>
<h2 id="清理监听函数">清理监听函数</h2>
<p>在AcAPP关闭之前触发的事件可以通过如下api添加：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AcWingOS.api.window.on_close(func);</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>同一个页面中，多个acapp引入的js代码只会加载一次，因此 <code>AC_GAME_OBJECTS</code> 等全局变量是同一个页面、同一个 <code>acapp</code> 的所有窗口共用的。</li>
<li>各自创建的局部变量是独立的，比如 <code>new AcGame()</code> 创建出的对象各个窗口是独立的。</li>
</ul>
<p>我们给每一个窗口创建一个 <code>uid</code> 然后根据不同的 <code>uid</code> 进行事件解绑</p>
<p><strong><code>playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">create_uuid</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i ++ ) &#123;</span><br><span class="line">            <span class="keyword">let</span> x = <span class="built_in">parseInt</span>(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">10</span>));   <span class="comment">//[0, 10)</span></span><br><span class="line">            res += x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="keyword">let</span> uuid = <span class="built_in">this</span>.create_uuid();</span><br><span class="line">        $(<span class="built_in">window</span>).on(<span class="string">`resize.<span class="subst">$&#123;uuid&#125;</span>`</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.resize();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.root.AcWingOS) &#123;</span><br><span class="line">            outer.root.AcWingOS.api.window.on_close(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                $(<span class="built_in">window</span>).off(<span class="string">`resize.<span class="subst">$&#123;uuid&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="编写每局游戏的结束界面">编写每局游戏的结束界面</h2>
<p>单独创建一个结束界面，然后游戏结束的时候渲染出该结束界面即可</p>
<p>因为结束界面要覆盖在游戏界面之上，因此我们需要先修改一下游戏引擎，添加一个 <code>late_update</code></p>
<p>在每一帧渲染的内容最后再渲染，从而实现结束界面叠加在游戏界面之上的效果</p>
<p><strong><code>ac_game_object/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">late_update</span>(<span class="params"></span>)</span> &#123; <span class="comment">//每一帧均会执行一次，且在所有 update 执行完后才执行</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">let</span> AC_GAME_ANIMATION = <span class="function"><span class="keyword">function</span>(<span class="params">timestamp</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; AC_GAME_OBJECTS.length; i ++ ) &#123;</span><br><span class="line">        <span class="keyword">let</span> obj = AC_GAME_OBJECTS[i];</span><br><span class="line">        obj.late_update();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>然后我们做一个渲染出结束界面的类</p>
<p><strong><code>playground/score_board/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScoreBoard</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">playground</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.playground = playground;</span><br><span class="line">        <span class="built_in">this</span>.ctx = <span class="built_in">this</span>.playground.game_map.ctx;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.state = <span class="literal">null</span>;  <span class="comment">// win-胜利；lose-失败</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.win_img = <span class="keyword">new</span> Image();</span><br><span class="line">        <span class="built_in">this</span>.win_img.src = <span class="string">&quot;https://cdn.acwing.com/media/article/image/2021/12/17/1_8f58341a5e-win.png&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.lose_img = <span class="keyword">new</span> Image();</span><br><span class="line">        <span class="built_in">this</span>.lose_img.src = <span class="string">&quot;https://cdn.acwing.com/media/article/image/2021/12/17/1_9254b5f95e-lose.png&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">add_listening_events</span>(<span class="params"></span>)</span> &#123;    <span class="comment">//点击后，返回主页面</span></span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="keyword">let</span> $canvas = <span class="built_in">this</span>.playground.game_map.$canvas;</span><br><span class="line"></span><br><span class="line">        $canvas.on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.playground.hide();</span><br><span class="line">            outer.playground.root.menu.show();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">win</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = <span class="string">&quot;win&quot;</span>;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.add_listening_events();</span><br><span class="line">        &#125;, <span class="number">1000</span>);   <span class="comment">//1秒后监听点击事件</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">lose</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = <span class="string">&quot;lose&quot;</span>;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            outer.add_listening_events();</span><br><span class="line">        &#125;, <span class="number">1000</span>);   <span class="comment">//1秒后监听点击事件</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">late_update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.render();  <span class="comment">//渲染在图层最上方</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> len = <span class="built_in">this</span>.playground.height / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.state === <span class="string">&quot;win&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx.drawImage(<span class="built_in">this</span>.win_img, <span class="built_in">this</span>.playground.width / <span class="number">2</span> - len / <span class="number">2</span>, <span class="built_in">this</span>.playground.height / <span class="number">2</span> - len / <span class="number">2</span>, len, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.state === <span class="string">&quot;lose&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx.drawImage(<span class="built_in">this</span>.lose_img, <span class="built_in">this</span>.playground.width / <span class="number">2</span> - len / <span class="number">2</span>, <span class="built_in">this</span>.playground.height / <span class="number">2</span> - len / <span class="number">2</span>, len, len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过游戏结束的逻辑判断，渲染结束界面，同时在结束并返回主菜单的时候，重置游戏元素</p>
<p>游戏元素重置</p>
<p><strong><code>playground/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcGamePlayground</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params">mode</span>)</span> &#123;    <span class="comment">//打开 playground 界面</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.score_board = <span class="keyword">new</span> ScoreBoard(<span class="built_in">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">hide</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">//清空所有游戏元素</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">this</span>.players &amp;&amp; <span class="built_in">this</span>.players.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.players[<span class="number">0</span>].destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.game_map) &#123;</span><br><span class="line">            <span class="built_in">this</span>.game_map.destroy();</span><br><span class="line">            <span class="built_in">this</span>.game_map = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.notice_board) &#123;</span><br><span class="line">            <span class="built_in">this</span>.notice_board.destroy();</span><br><span class="line">            <span class="built_in">this</span>.notice_board = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.score_board) &#123;</span><br><span class="line">            <span class="built_in">this</span>.score_board.destroy();</span><br><span class="line">            <span class="built_in">this</span>.score_board = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.$playground.empty();   <span class="comment">//清空所有html标签</span></span><br><span class="line">        <span class="built_in">this</span>.$playground.hide();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>游戏结束的逻辑判断</p>
<p><strong><code>playground/player/zbase.js</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">AcGameObject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.update_win();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update_win</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 竞赛状态，且只有一名玩家，且改名玩家就是我，则胜利</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.playground.state === <span class="string">&quot;fighting&quot;</span> &amp;&amp; <span class="built_in">this</span>.character === <span class="string">&quot;me&quot;</span> &amp;&amp; <span class="built_in">this</span>.playground.players.length === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.playground.state = <span class="string">&quot;over&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.playground.score_board.win();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="title">on_destroy</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 我死亡，且游戏处于竞赛状态，则失败</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.character === <span class="string">&quot;me&quot;</span> &amp;&amp; <span class="built_in">this</span>.playground.state === <span class="string">&quot;fighting&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.playground.state = <span class="string">&quot;over&quot;</span></span><br><span class="line">            <span class="built_in">this</span>.playground.score_board.lose();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="更新战绩">更新战绩</h2>
<p>这里我们完全交给后端来判断</p>
<p>在处理广播的 <code>attack</code> 信息的时候，先前我们额外留了一个参数 <code>hp</code></p>
<p>围绕该 <code>hp</code> 进行续写，若当前房间内 <code>hp</code> 大于 0 的玩家少于等于 1 个</p>
<p>则对于所有 <code>hp</code> 为 0 的玩家减 rank 分，大于 0 的玩家加 rank 分</p>
<p><strong><code>consumers/multiplayer/index.py</code></strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiPlayer</span>(<span class="params">AsyncWebsocketConsumer</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">attack</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.room_name:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        players = cache.get(self.room_name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> players:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> player <span class="keyword">in</span> players:</span><br><span class="line">            <span class="keyword">if</span> player[<span class="string">&#x27;uuid&#x27;</span>] == data[<span class="string">&#x27;attackee_uuid&#x27;</span>]:</span><br><span class="line">                player[<span class="string">&#x27;hp&#x27;</span>] -= <span class="number">25</span></span><br><span class="line"></span><br><span class="line">        remain_cnt = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> player <span class="keyword">in</span> players:</span><br><span class="line">            <span class="keyword">if</span> player[<span class="string">&#x27;hp&#x27;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">                remain_cnt += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> remain_cnt &gt; <span class="number">1</span>:  <span class="comment"># 继续进行游戏</span></span><br><span class="line">            <span class="keyword">if</span> self.room_name:</span><br><span class="line">                cache.<span class="built_in">set</span>(self.room_name, players, <span class="number">3600</span>)</span><br><span class="line">        <span class="keyword">else</span>:   <span class="comment"># 结算 </span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">db_update_player_score</span>(<span class="params">username, score</span>):</span></span><br><span class="line">                player = Player.objects.get(user__username=username)</span><br><span class="line">                player.score += score</span><br><span class="line">                player.save()</span><br><span class="line">            <span class="keyword">for</span> player <span class="keyword">in</span> players:</span><br><span class="line">                <span class="keyword">if</span> player[<span class="string">&#x27;hp&#x27;</span>] &lt;= <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">await</span> database_sync_to_async(db_update_player_score)(player[<span class="string">&#x27;username&#x27;</span>], -<span class="number">5</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">await</span> database_sync_to_async(db_update_player_score)(player[<span class="string">&#x27;username&#x27;</span>], <span class="number">10</span>)</span><br><span class="line">        ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h2 id="添加favicon.ico">添加favicon.ico</h2>
<p>这是修正一个小 BUG，之前 web 端一直没有网页显示图标，这里给他加上去</p>
<p><strong><code>game/templates/multiends/web.html</code></strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdn.acwing.com/media/article/image/2021/12/17/1_be4c11ce5f-acapp.png&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Colopen 彩色铅笔</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.colopen-blog.com/Engineer/acw_django/">http://www.colopen-blog.com/Engineer/acw_django/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.colopen-blog.com" target="_blank">Colopen's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AcWing/">AcWing</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.acwing.com/media/activity/surface/acdjango.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Algorithm/lydguid/z0x01_%E4%BD%8D%E8%BF%90%E7%AE%97/"><img class="prev-cover" src="/img/top.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">《算法竞赛进阶指南》0x01 位运算</div></div></a></div><div class="next-post pull-right"><a href="/Engineer/acw_linux/"><img class="next-cover" src="https://cdn.acwing.com/media/activity/surface/QQ%E6%88%AA%E5%9B%BE20210722233821.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">AcWing Linux 基础课</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/Engineer/acw_linux/" title="AcWing Linux 基础课"><img class="cover" src="https://cdn.acwing.com/media/activity/surface/QQ%E6%88%AA%E5%9B%BE20210722233821.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-10</div><div class="title">AcWing Linux 基础课</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Colopen 彩色铅笔</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zxclss"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zxclss" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zhaoxiucong@126.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">假期里努力坚持每日一更 =w=</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#python3%E6%95%99%E7%A8%8B-%E0%AE%90"><span class="toc-text">Python3教程 ஐ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEdockergit%E7%8E%AF%E5%A2%83%E4%B8%8E%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA-%E0%AE%90"><span class="toc-text">配置docker、git环境与项目创建 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-docker-%E7%8E%AF%E5%A2%83"><span class="toc-text">配置 docker 环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-git-%E7%8E%AF%E5%A2%83"><span class="toc-text">配置 git 环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-django-%E9%A1%B9%E7%9B%AE"><span class="toc-text">配置 Django 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%88%9D%E5%A7%8B%E9%A1%B9%E7%9B%AE"><span class="toc-text">启动初始项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gitignore%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">【*.gitignore的作用】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-text">创建管理员登录页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-text">创建用户登录页面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%8F%9C%E5%8D%95%E7%95%8C%E9%9D%A2-%E0%AE%90"><span class="toc-text">创建菜单界面 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%A5%BD%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%A1%86%E6%9E%B6"><span class="toc-text">构建好项目的框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%8F%9C%E5%8D%95-menu-%E7%95%8C%E9%9D%A2"><span class="toc-text">创建菜单 menu 界面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E8%8F%9C%E5%8D%95-menu-%E7%95%8C%E9%9D%A2%E7%9A%84%E6%A1%86%E6%9E%B6"><span class="toc-text">搭建菜单 menu 界面的框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%8F%9C%E5%8D%95-menu-%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-text">设置菜单 menu 页面的内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-%E5%8D%95%E4%BA%BA%E6%A8%A1%E5%BC%8F-%E7%9B%91%E5%90%AC%E5%87%BD%E6%95%B0-%E6%89%93%E5%BC%80%E6%B8%B8%E6%88%8F%E7%95%8C%E9%9D%A2-%E5%8A%9F%E8%83%BD"><span class="toc-text">添加 &#39;单人模式&#39; 监听函数 —— 打开游戏界面 功能</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B8%B8%E6%88%8F%E7%95%8C%E9%9D%A2-%E0%AE%90"><span class="toc-text">创建游戏界面 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E5%BC%95%E5%85%A5"><span class="toc-text">前端的模块化引入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E6%B8%B8%E6%88%8F%E7%95%8C%E9%9D%A2%E6%A1%86%E6%9E%B6"><span class="toc-text">构建游戏界面框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E6%A1%86%E6%9E%B6"><span class="toc-text">实现游戏引擎框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B8%B8%E6%88%8F%E5%9C%B0%E5%9B%BE%E5%8A%9F%E8%83%BD"><span class="toc-text">实现游戏地图功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%8E%A9%E5%AE%B6%E6%98%BE%E7%A4%BA%E5%8A%9F%E8%83%BD"><span class="toc-text">实现玩家显示功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%8E%A9%E5%AE%B6%E7%A7%BB%E5%8A%A8%E5%8A%9F%E8%83%BD"><span class="toc-text">实现玩家移动功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%81%AB%E7%90%83%E6%8A%80%E8%83%BD%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-text">实现火球技能的功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%BA%BA%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E4%BA%BA%E6%9C%BA%E5%8A%9F%E8%83%BD"><span class="toc-text">实现单人模式下的人机功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8A%80%E8%83%BD%E5%91%BD%E4%B8%AD%E6%95%88%E6%9E%9C%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B%E5%8A%9F%E8%83%BD"><span class="toc-text">实现技能命中效果（碰撞检测功能）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A2%AB%E5%87%BB%E4%B8%AD%E4%BB%A5%E5%90%8E%E7%9A%84%E7%B2%92%E5%AD%90%E6%95%88%E6%9E%9C%E7%89%B9%E6%95%88"><span class="toc-text">被击中以后的粒子效果特效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%B0%8F%E4%BC%98%E5%8C%96"><span class="toc-text">一些小优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%BA%E6%9C%BA%E9%9A%8F%E6%9C%BA%E9%A2%9C%E8%89%B2"><span class="toc-text">人机随机颜色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%BA%E6%9C%BAai%E9%9A%8F%E6%9C%BA%E6%94%BB%E5%87%BB%E6%93%8D%E4%BD%9C"><span class="toc-text">人机AI随机攻击操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2nginx%E4%B8%8E%E5%AF%B9%E6%8E%A5acapp-%E0%AE%90"><span class="toc-text">部署nginx与对接acapp ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%AE%B9%E5%99%A8%E7%9A%84%E6%98%A0%E5%B0%84%E7%AB%AF%E5%8F%A3-80-%E4%B8%8E-443"><span class="toc-text">增加容器的映射端口 : 80 与 443</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAacapp%E8%8E%B7%E5%8F%96%E5%9F%9F%E5%90%8Dnginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8F%8Ahttps%E8%AF%81%E4%B9%A6"><span class="toc-text">创建AcApp，获取域名、nginx配置文件及https证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9django%E9%A1%B9%E7%9B%AE%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-text">修改django项目的配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEuwsgi"><span class="toc-text">配置uwsgi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E5%88%86%E9%85%8D%E7%9A%84%E5%9F%9F%E5%90%8D%E7%94%9F%E6%95%88"><span class="toc-text">使分配的域名生效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%BA%94%E7%94%A8"><span class="toc-text">发布应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-acapp-%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-text">针对 acapp 的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC%E4%BC%98%E5%8C%96"><span class="toc-text">打包脚本优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BC%A0%E6%A0%87%E7%82%B9%E5%87%BB%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB"><span class="toc-text">鼠标点击事件的相对偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E8%8F%9C%E5%8D%95%E7%95%8C%E9%9D%A2%E9%87%8D%E6%96%B0%E8%AE%BE%E4%B8%BA%E4%B8%BB%E7%95%8C%E9%9D%A2"><span class="toc-text">将菜单界面重新设为主界面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E6%95%B4-css-%E6%96%87%E4%BB%B6%E9%80%82%E5%BA%94%E7%AA%97%E5%8F%A3"><span class="toc-text">调整 css 文件，适应窗口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%B3%BB%E7%BB%9F-%E0%AE%90"><span class="toc-text">用户系统 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text">前期准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E8%A1%A8"><span class="toc-text">创建用户表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%88%A4%E5%88%ABacapp-or-web"><span class="toc-text">实现客户端的类型判别（ACAPP or WEB）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%E6%A1%86%E6%9E%B6"><span class="toc-text">构建登录功能框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#views"><span class="toc-text">views</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#urls"><span class="toc-text">urls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js"><span class="toc-text">js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84-http-%E8%AF%B7%E6%B1%82%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-text">完善 HTTP 请求的函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F%E6%B8%B2%E6%9F%93%E5%88%B0%E7%8E%A9%E5%AE%B6%E4%B8%8A"><span class="toc-text">将用户头像渲染到玩家上</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%E7%9A%84%E5%89%8D%E7%AB%AF"><span class="toc-text">实现登录界面的前端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%AB%AF%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6"><span class="toc-text">实现前端的基础框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E7%9A%84%E7%9B%B8%E4%BA%92%E5%88%87%E6%8D%A2"><span class="toc-text">实现登录&#x2F;注册的相互切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-text">实现登录功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%87%BA%E5%8A%9F%E8%83%BD"><span class="toc-text">实现登出功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD"><span class="toc-text">实现注册功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web%E7%AB%AFacwing%E4%B8%80%E9%94%AE%E7%99%BB%E5%BD%95-%E0%AE%90"><span class="toc-text">web端AcWing一键登录 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8django%E4%B8%AD%E9%9B%86%E6%88%90redis"><span class="toc-text">在Django中集成Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-django-%E5%90%8E%E5%8F%B0%E9%87%8C%E6%93%8D%E7%BA%B5-reids"><span class="toc-text">在 django 后台里操纵 reids</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%85%85player%E8%A1%A8"><span class="toc-text">扩充Player表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E6%8E%88%E6%9D%83%E7%A0%81code"><span class="toc-text">申请授权码code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#views-1"><span class="toc-text">views</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#urls-1"><span class="toc-text">urls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js-1"><span class="toc-text">js</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E6%8E%88%E6%9D%83%E4%BB%A4%E7%89%8C-access_token-%E5%92%8C%E7%94%A8%E6%88%B7%E7%9A%84-openid"><span class="toc-text">申请授权令牌 access_token 和用户的 openid</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#views-2"><span class="toc-text">views</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">申请用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#views-3"><span class="toc-text">views</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#acapp%E7%AB%AFacwing%E4%B8%80%E9%94%AE%E7%99%BB%E5%BD%95-%E0%AE%90"><span class="toc-text">AcApp端AcWing一键登录 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E6%8E%88%E6%9D%83%E7%A0%81-code"><span class="toc-text">申请授权码 code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#views-4"><span class="toc-text">views</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#urls-2"><span class="toc-text">urls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js-2"><span class="toc-text">js</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%81%94%E6%9C%BA%E5%AF%B9%E6%88%98-%E0%AE%90"><span class="toc-text">实现联机对战 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E9%95%BF%E5%BA%A6%E5%8D%95%E4%BD%8D"><span class="toc-text">统一长度单位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9B%BE%E6%B8%B2%E6%9F%93"><span class="toc-text">地图渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%B0%E5%9B%BE-169-%E7%AD%89%E6%AF%94%E4%BE%8B%E7%BC%A9%E6%94%BE"><span class="toc-text">地图 16:9 等比例缩放</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%B0%E5%9B%BE%E5%B1%85%E4%B8%AD"><span class="toc-text">地图居中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%9C%B0%E5%9B%BE-resize-%E6%97%B6%E4%BC%9A%E5%87%BA%E7%8E%B0%E6%B8%90%E5%8F%98%E6%88%90%E9%BB%91%E8%89%B2%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-text">解决地图 resize 时，会出现渐变成黑色的情况</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E7%B4%A0%E6%B8%B2%E6%9F%93"><span class="toc-text">元素渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%A9%E5%AE%B6-player"><span class="toc-text">玩家 Player</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%81%AB%E7%90%83-fireball"><span class="toc-text">火球 Fireball</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B2%92%E5%AD%90-particle"><span class="toc-text">粒子 particle</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E8%81%94%E6%9C%BA%E5%AF%B9%E6%88%98%E6%A8%A1%E5%BC%8F"><span class="toc-text">增加“联机对战”模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEdjango_channels"><span class="toc-text">配置django_channels</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-channels_redis"><span class="toc-text">安装 channels_redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-acappasgi.py"><span class="toc-text">配置 acapp&#x2F;asgi.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-acappsettings.py"><span class="toc-text">配置 acapp&#x2F;settings.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-gamerouting.py"><span class="toc-text">配置 game&#x2F;routing.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99-gameconsumers"><span class="toc-text">编写 game&#x2F;consumers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-django_channels"><span class="toc-text">启动 django_channels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-wss-%E8%BF%9E%E6%8E%A5"><span class="toc-text">建立 WSS 连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1-routing"><span class="toc-text">路由 routing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AFjs"><span class="toc-text">前端js</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%90%8C%E6%AD%A5%E5%87%BD%E6%95%B0"><span class="toc-text">编写同步函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#create-player"><span class="toc-text">create-player</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF"><span class="toc-text">后端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF"><span class="toc-text">前端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-%E8%B0%83%E8%AF%95%E8%AF%AD%E5%8F%A5"><span class="toc-text">redis 调试语句</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#move-to"><span class="toc-text">move-to</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF-1"><span class="toc-text">前端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF-1"><span class="toc-text">后端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shoot-fireball"><span class="toc-text">shoot-fireball</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E4%B8%80%E4%B8%8B%E7%81%AB%E7%90%83%E5%85%83%E7%B4%A0"><span class="toc-text">优化一下火球元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF-2"><span class="toc-text">后端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack"><span class="toc-text">attack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF-2"><span class="toc-text">前端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF-3"><span class="toc-text">后端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E7%9A%84%E5%B0%8F%E4%BC%98%E5%8C%96"><span class="toc-text">游戏的小优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%BA%BA%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%B8%B8%E6%88%8F%E6%B2%A1%E6%9C%89%E5%BC%80%E5%A7%8B%E5%89%8D%E7%8E%A9%E5%AE%B6%E4%B8%8D%E5%8F%AF%E4%BB%A5%E7%A7%BB%E5%8A%A8"><span class="toc-text">多人模式下游戏没有开始前，玩家不可以移动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E8%83%BDcd"><span class="toc-text">技能CD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E5%9B%BE%E7%89%87%E6%9D%A5%E6%B8%B2%E6%9F%93%E6%8A%80%E8%83%BDcd"><span class="toc-text">用图片来渲染技能CD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E9%97%AA%E7%8E%B0%E6%8A%80%E8%83%BD"><span class="toc-text">添加一个闪现技能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E9%83%A8%E5%88%86"><span class="toc-text">单机部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%94%E6%9C%BA%E9%83%A8%E5%88%86"><span class="toc-text">联机部分</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-%E0%AE%90"><span class="toc-text">实现聊天系统 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E9%94%AE%E7%9B%98%E7%BB%91%E5%AE%9A%E4%BA%8B%E4%BB%B6"><span class="toc-text">优化键盘绑定事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%89%8D%E7%AB%AF"><span class="toc-text">本地前端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%94%E6%9C%BA%E8%81%8A%E5%A4%A9%E7%AA%97"><span class="toc-text">联机聊天窗</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF-3"><span class="toc-text">前端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF-4"><span class="toc-text">后端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E0%AE%90"><span class="toc-text">实现匹配系统 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%94%B6%E5%B0%BE-%E0%AE%90"><span class="toc-text">项目收尾 ஐ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%8E%8B%E7%BC%A9js%E4%BB%A3%E7%A0%81"><span class="toc-text">加密、压缩js代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E7%9B%91%E5%90%AC%E5%87%BD%E6%95%B0"><span class="toc-text">清理监听函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%AF%8F%E5%B1%80%E6%B8%B8%E6%88%8F%E7%9A%84%E7%BB%93%E6%9D%9F%E7%95%8C%E9%9D%A2"><span class="toc-text">编写每局游戏的结束界面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%88%98%E7%BB%A9"><span class="toc-text">更新战绩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0favicon.ico"><span class="toc-text">添加favicon.ico</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Algorithm/lydguid/z0x15_%E5%AD%97%E7%AC%A6%E4%B8%B2/" title="《算法竞赛进阶指南》0x15 字符串"><img src="/img/top.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《算法竞赛进阶指南》0x15 字符串"/></a><div class="content"><a class="title" href="/Algorithm/lydguid/z0x15_%E5%AD%97%E7%AC%A6%E4%B8%B2/" title="《算法竞赛进阶指南》0x15 字符串">《算法竞赛进阶指南》0x15 字符串</a><time datetime="2022-02-05T16:00:00.000Z" title="发表于 2022-02-06 00:00:00">2022-02-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Algorithm/lydguid/z0x14_Hash/" title="《算法竞赛进阶指南》0x14 Hash"><img src="/img/top.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《算法竞赛进阶指南》0x14 Hash"/></a><div class="content"><a class="title" href="/Algorithm/lydguid/z0x14_Hash/" title="《算法竞赛进阶指南》0x14 Hash">《算法竞赛进阶指南》0x14 Hash</a><time datetime="2022-02-04T16:00:00.000Z" title="发表于 2022-02-05 00:00:00">2022-02-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Algorithm/lydguid/z0x13_%E9%93%BE%E8%A1%A8%E4%B8%8E%E9%82%BB%E6%8E%A5%E8%A1%A8/" title="《算法竞赛进阶指南》0x13 链表与邻接表"><img src="/img/top.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《算法竞赛进阶指南》0x13 链表与邻接表"/></a><div class="content"><a class="title" href="/Algorithm/lydguid/z0x13_%E9%93%BE%E8%A1%A8%E4%B8%8E%E9%82%BB%E6%8E%A5%E8%A1%A8/" title="《算法竞赛进阶指南》0x13 链表与邻接表">《算法竞赛进阶指南》0x13 链表与邻接表</a><time datetime="2022-02-03T16:00:00.000Z" title="发表于 2022-02-04 00:00:00">2022-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Algorithm/lydguid/z0x12_%E9%98%9F%E5%88%97/" title="《算法竞赛进阶指南》0x12 队列"><img src="/img/top.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《算法竞赛进阶指南》0x12 队列"/></a><div class="content"><a class="title" href="/Algorithm/lydguid/z0x12_%E9%98%9F%E5%88%97/" title="《算法竞赛进阶指南》0x12 队列">《算法竞赛进阶指南》0x12 队列</a><time datetime="2022-02-02T16:00:00.000Z" title="发表于 2022-02-03 00:00:00">2022-02-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Algorithm/lydguid/z0x11_%E6%A0%88/" title="《算法竞赛进阶指南》0x11 栈"><img src="/img/top.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《算法竞赛进阶指南》0x11 栈"/></a><div class="content"><a class="title" href="/Algorithm/lydguid/z0x11_%E6%A0%88/" title="《算法竞赛进阶指南》0x11 栈">《算法竞赛进阶指南》0x11 栈</a><time datetime="2022-02-01T16:00:00.000Z" title="发表于 2022-02-02 00:00:00">2022-02-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Colopen 彩色铅笔</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hello, welcome to my blog.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'gKOSQieW3w4mqQWaEbqkq3V6-9Nh9j0Va',
      appKey: 'A3pLjLFHX6WdjQy1whxou4Ki',
      placeholder: '留言前，请先留下你的昵称 (^w^)',
      avatar: 'mp',
      meta: 'nick,mail'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: 'https://gkosqiew.lc-cn-e1-shared.com',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: true
    }, ))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script>(function(d, w, c) {
    w.ChatraID = 'br28SJa9R5bPMHm5T';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>